let path_control=' \nvar PathCtr={isOutputDebugPrint:!1,debugPrint:function(){PathCtr.isOutputDebugPrint&&console.log.apply(null,arguments)},isOutputLoadState:!0,loadState:function(){if(PathCtr.isOutputLoadState)for(let t=0;t<arguments.length;++t)console.log(arguments[t])},defaultCanvasContainerID:"path-container",defaultActionName:"base",initTarget:null,binDataPosRange:2e4,pathContainer:null,canvas:null,subCanvas:null,context:null,subContext:null,viewWidth:0,viewHeight:0,actionName:"base",frameNumber:0,fixFrameTime:1/24,prevTimestamp:0,average:0,requestAnimationIDs:[],setTimeoutIDs:[],cancelRequestAnimation:function(){(PathCtr.requestAnimationIDs.length>1||PathCtr.setTimeoutIDs.length>1)&&console.error("requestAnimationIDs:"+PathCtr.requestAnimationIDs.length+", "+PathCtr.setTimeoutIDs.length),PathCtr.requestAnimationIDs.forEach(cancelAnimationFrame),PathCtr.requestAnimationIDs.length=0,PathCtr.setTimeoutIDs.forEach(clearTimeout),PathCtr.setTimeoutIDs.length=0},setSize:function(t,e){PathCtr.canvas.width=PathCtr.subCanvas.width=PathCtr.viewWidth=t,PathCtr.canvas.height=PathCtr.subCanvas.height=PathCtr.viewHeight=e,PathCtr.pathContainer&&PathCtr.pathContainer.setSize(t,e),PathCtr.update()},loadComplete:function(){PathCtr.pathContainer=PathCtr.initTarget,PathCtr.pathContainer.context=PathWorker.isWorker?PathCtr.context:PathCtr.subContext,PathCtr.setSize(PathCtr.viewWidth,PathCtr.viewHeight),PathCtr.initTarget=null,PathCtr.loadState(PathCtr.pathContainer),"undefined"!=typeof DebugPath&&DebugPath.init(PathCtr.pathContainer),PathCtr.update()},draw:function(t){if("undefined"!=typeof DebugPath&&DebugPath.isStop){if(!DebugPath.isStep)return;DebugPath.isStep=!1,console.log("STEP: "+PathCtr.actionName+" - "+PathCtr.frameNumber)}if(void 0===t)return;let e=(t-PathCtr.prevTimestamp)/1e3;if(PathCtr.average=(PathCtr.average+e)/2,!PathCtr.pathContainer)return;let a=1,i=PathCtr.pathContainer.getAction(PathCtr.actionName);if(i?a=i.totalFrames:(PathCtr.actionName="base",(i=PathCtr.pathContainer.getAction(PathCtr.actionName))&&(a=i.totalFrames)),PathWorker.isWorker){if(PathCtr.context.clearRect(0,0,PathCtr.viewWidth,PathCtr.viewHeight),PathCtr.pathContainer.draw(),t-PathCtr.prevTimestamp<1/24*500)return}else PathCtr.subContext.clearRect(0,0,PathCtr.viewWidth,PathCtr.viewHeight),PathCtr.pathContainer.draw(),PathCtr.context.clearRect(0,0,PathCtr.viewWidth,PathCtr.viewHeight),PathCtr.context.putImageData(PathCtr.subContext.getImageData(0,0,PathCtr.viewWidth,PathCtr.viewHeight),0,0);PathCtr.frameNumber=PathCtr.frameNumber%a+1,PathCtr.prevTimestamp=t,PathCtr.average>1/24*2?(PathCtr.fixFrameTime*=.99,PathCtr.debugPrint("up")):PathCtr.average<1/24*.5?(PathCtr.fixFrameTime*=1.01,PathCtr.debugPrint("down")):PathCtr.fixFrameTime=(1/24+PathCtr.fixFrameTime)/2,PathCtr.pathContainer.update(PathCtr.frameNumber,PathCtr.actionName)},update:function(){PathCtr.cancelRequestAnimation(),PathCtr.requestAnimationIDs.push(requestAnimationFrame(PathCtr.draw)),PathCtr.setTimeoutIDs.push(setTimeout(PathCtr.update,1e3*PathCtr.fixFrameTime))},init:function(t,e,a,i){t&&e?(PathCtr.canvas=t,PathCtr.context=t.getContext("2d"),PathCtr.subCanvas=e,PathCtr.subContext=e.getContext("2d"),PathCtr.context&&PathCtr.subContext?(t.width=e.width=PathCtr.viewWidth=a,t.height=e.height=PathCtr.viewHeight=i):console.error("context is not found.")):console.error("canvas is not found.")}};class Matrix{constructor(){this.a=1,this.b=0,this.c=0,this.d=1,this.e=0,this.f=0}reset(){return this.a=this.d=1,this.b=this.c=this.e=this.f=0,this}applyToPoint(t,e=0){let a=t[e],i=t[e+1];t[e]=a*this.a+i*this.c+this.e,t[e+1]=a*this.b+i*this.d+this.f}applyToArray(t,e=0){let a=t.length;for(let i=e;i<a;i+=2)this.applyToPoint(t,i)}setMatrix(t){return this.a=t.a,this.b=t.b,this.c=t.c,this.d=t.d,this.e=t.e,this.f=t.f,this}interpolate(t,e){let a=new Matrix;return a.a=this.a+(t.a-this.a)*e,a.b=this.b+(t.b-this.b)*e,a.c=this.c+(t.c-this.c)*e,a.d=this.d+(t.d-this.d)*e,a.e=this.e+(t.e-this.e)*e,a.f=this.f+(t.f-this.f)*e,a}mult(t){let e=new Matrix;return e.a=this.a*t,e.b=this.b*t,e.c=this.c*t,e.d=this.d*t,e.e=this.e*t,e.f=this.f*t,e}multAndAddPoint(t,e,a,i,r){i[r]+=(e*this.a+a*this.c+this.e)*t,i[r+1]+=(e*this.b+a*this.d+this.f)*t}setTransform(t,e,a,i,r,s){return this.a=t,this.b=e,this.c=a,this.d=i,this.e=r,this.f=s,this}transform(t,e,a,i,r,s){let n=this.a,o=this.b,h=this.c,l=this.d,c=this.e,u=this.f;return this.a=n*t+h*e,this.b=o*t+l*e,this.c=n*a+h*i,this.d=o*a+l*i,this.e=n*r+h*s+c,this.f=o*r+l*s+u,this}rotate(t){let e=Math.cos(t),a=Math.sin(t);return this.transform(e,a,-a,e,0,0)}transformFromMatrix(t){return this.transform(t.a,t.b,t.c,t.d,t.e,t.f)}scale(t,e=t){return this.transform(t,0,0,e,0,0)}scaleX(t){return this.transform(t,0,0,1,0,0)}scaleY(t){return this.transform(1,0,0,t,0,0)}skew(t,e){return this.transform(1,e,t,1,0,0)}skewX(t){return this.transform(1,0,t,1,0,0)}skewY(t){return this.transform(1,t,0,1,0,0)}translate(t,e){return this.transform(1,0,0,1,t,e)}translateX(t){return this.transform(1,0,0,1,t,0)}translateY(t){return this.transform(1,0,0,1,0,t)}}class Sprite{constructor(){this.m=new Matrix,this.x=0,this.y=0,this.anchorX=0,this.anchorY=0,this.scaleX=1,this.scaleY=1,this.rotation=0}reset(){this.x=0,this.y=0,this.anchorX=0,this.anchorY=0,this.scaleX=1,this.scaleY=1,this.rotation=0}clone(){let t=new Sprite;return t.x=this.x,t.y=this.y,t.anchorX=this.anchorX,t.anchorY=this.anchorY,t.scaleX=this.scaleX,t.scaleY=this.scaleY,t.rotation=this.rotation,t}setSprite(t){return this.x=t.x,this.y=t.y,this.anchorX=t.anchorX,this.anchorY=t.anchorY,this.scaleX=t.scaleX,this.scaleY=t.scaleY,this.rotation=t.rotation,this}addSprite(t){return this.x+=t.x,this.y+=t.y,this.anchorX+=t.anchorX,this.anchorY+=t.anchorY,this.scaleX*=t.scaleX,this.scaleY*=t.scaleY,this.rotation=t.rotation,this}compSprite(t){let e=new Sprite;return e.x=this.x+t.x,e.y=this.y+t.y,e.anchorX=this.anchorX+t.anchorX,e.anchorY=this.anchorY+t.anchorY,e.scaleX=this.scaleX*t.scaleX,e.scaleY=this.scaleY*t.scaleY,e.rotation=this.rotation+t.rotation,e}getMatrix(t=0,e=0){return this.m.reset().translate(this.x+t,this.y+e).rotate(this.rotation).scale(this.scaleX,this.scaleY).translate(-this.anchorX-t,-this.anchorY-+e)}}class ActionContainer{constructor(t,e){this.data=t,this.checkFunc=e,this.hasAction=Array.isArray(t)&&t.some(t=>Array.isArray(t)&&t.some(e)),this.result=this.hasAction?t[0][0]:t}setData(t,e=0,a=0){this.hasAction?this.addAction(t,e,a):(this.data=t,this.hasAction=Array.isArray(t)&&t.some(t=>Array.isArray(t)&&t.some(this.checkFunc)),this.result=this.hasAction?t[0][0]:t)}addAction(t,e,a){if(!this.hasAction){if(JSON.stringify(this.data)==JSON.stringify(t))return;this.data=[[this.data]],this.hasAction=!0}void 0===this.data[e]&&(this.data[e]=[this.data[0][0].concat()]);let i=!0;for(let r=this.data[e].length-1;r>=0;--r)if(void 0!==this.data[e][r]){if(JSON.stringify(t)==JSON.stringify(this.data[e][r]))break;this.data[e][a]=t,i=!1;break}i&&(this.data[e][a]=void 0)}hasActionID(t){return!!this.hasAction&&void 0!==this.data[t]}getData(t=0,e=0){return this.hasAction?this.data[t][Math.min(e,this.data[t].length-1)]:this.data}getAvailableData(t=0,e=0){if(!this.hasAction)return this.data;if(!this.hasActionID(t))return this.data[0][0];for(let a=e;a>=0;--a){let e=this.getData(t,a);if(void 0!==e)return e}}update(t,e=0,a=0){if(!this.hasAction)return;this.hasActionID(e)||(e=0);let i=(t,e)=>{PathCtr.isOutputDebugPrint&&this.result!=e&&PathCtr.debugPrint(t.name,t.pastFrame,t.currentFrame,e)},r=null;this.data.forEach((e,a)=>{let s=t.actionList[a],n=s.pastFrame,o=s.currentFrame;if(n!=o)if(n<=o)for(let t=Math.min(o,e.length-1);t>=n;--t){let a=e[t];if(void 0!==a){i(s,r=a);break}}else for(let t=Math.min(n,e.length-1);t>=o;--t){if(void 0!==e[t]){for(let t=Math.min(o,e.length-1);t>=0;--t){let a=e[t];if(void 0!==a){i(s,r=a);break}}break}}}),r&&this.result!=r&&(this.result=r)}}class PathObj{constructor(t,e,a,i,r,s,n){this.maskIdToUse=t,this.fillRule=i,this.pathDiffList=new ActionContainer(a,t=>Array.isArray(t)&&t.some(t=>Array.isArray(t))),this.fillStyle=new ActionContainer(r,t=>"string"==typeof t),this.lineWidth=new ActionContainer(s,t=>Number.isFinite(t)),this.strokeStyle=new ActionContainer(n,t=>"string"==typeof t),this.resultPathList=e,this.defPathList=e}addAction(t,e,a,i,r,s){t?this.defPathList.length!=t.length&&(console.error("The number of paths does not match."),console.log(this.defPathList),console.log(t),t=this.defPathList.concat()):t=this.defPathList.concat();let n=[];this.defPathList.forEach((e,a)=>{if(e.type!=t[a].type)return console.error("type does not match."),console.log(this.defPathList),void console.log(t);e.pos&&(n[a]=[],e.pos.forEach((e,i)=>{n[a].push(t[a].pos[i]-e)}))}),this.pathDiffList.addAction(n,s,r),this.fillStyle.addAction(e,s,r),this.lineWidth.addAction(a,s,r),this.strokeStyle.addAction(i,s,r)}makeData(t){let e=[];return this.defPathList.forEach((a,i)=>{e.push({type:a.type,pos:a.pos?a.pos.map((e,a)=>e+t[i][a]):void 0})}),e}getPathDataList(t=0,e=0){return this.makeData(this.pathDiffList.getAvailableData(e,t))}getMergePathDataList(t,e=0,a=0){if(!this.pathDiffList.hasAction)return this.makeData(this.pathDiffList.getData());this.pathDiffList.hasActionID(a)||(a=0,e=0);let i=this.makeData(this.pathDiffList.getAvailableData(a,e));return 1==t.actionList.length?i:(t.actionList.forEach(t=>{a!=t.id&&this.pathDiffList.hasActionID(t.id)&&this.pathDiffList.getAvailableData(t.id,t.currentFrame).forEach((t,e)=>{t&&t.forEach((t,a)=>{t&&(i[e].pos[a]+=t)})})}),i)}static calcFlexiPoints(t,e,a,i=0,r=a.length){if(!(!a||a.length>i+r||r<2))for(let s=i;s<i+r;s+=2){if(1==e.length){let i=e[0];if(0==t.groups[i].strength)continue;t.groups[i].effectSprite.getMatrix().applyToPoint(a,s);continue}let i=a[s],r=a[s+1],n=[],o=0;e.forEach(e=>{let a=t.groups[e].getInfluence(i,r);o+=a,n.push(a)}),0!=o&&(a[s]=0,a[s+1]=0,e.forEach((e,h)=>{t.groups[e].effectSprite.getMatrix().multAndAddPoint(1-n[h]/o,i,r,a,s)}))}}calcFlexi(t,e){this.resultPathList.forEach(a=>{a.pos&&0!=a.pos.length&&PathObj.calcFlexiPoints(t,e,a.pos)})}update(t,e,a,i){let r=this.getMergePathDataList(a,t,e);r.forEach(t=>{t.pos&&i.applyToArray(t.pos)}),this.resultPathList=r,this.fillStyle.update(a,e,t),this.lineWidth.update(a,e,t),this.strokeStyle.update(a,e,t)}draw(t,e,a,i){this.resultPathList.forEach(e=>{let i=e.pos,r=t.pathRatio;switch(e.type){case"M":a.moveTo(i[0]*r,i[1]*r);break;case"L":a.lineTo(i[0]*r,i[1]*r);break;case"C":a.bezierCurveTo(i[0]*r,i[1]*r,i[2]*r,i[3]*r,i[4]*r,i[5]*r);break;case"Z":a.closePath();break;default:console.error("unknown type")}}),i||(this.lineWidth.result&&(e.lineJoin="round",e.lineCap="round",e.lineWidth=this.lineWidth.result,e.strokeStyle=this.strokeStyle.result,e.stroke(a)),e.fillStyle=this.fillStyle.result,e.fill(a,this.fillRule))}debugDraw(t,e){let a=2*Math.PI,i=(t,i)=>{if(!DebugPath.isShowPoints)return;let r=new Path2D;r.arc(t,i,DebugPath.pointSize,0,a),e.fillStyle=DebugPath.pointColor,e.fill(r,"nonzero")};this.resultPathList.forEach(r=>{let s=r.pos,n=t.pathRatio;switch(r.type){case"M":case"L":i(s[0]*n,s[1]*n);break;case"C":((t,i,r,s)=>{if(!DebugPath.isShowControls)return;let n=new Path2D;n.arc(t,i,DebugPath.controlSize,0,a),n.arc(r,s,DebugPath.controlSize,0,a),e.fillStyle=DebugPath.controlColor,e.fill(n,"nonzero")})(s[0]*n,s[1]*n,s[2]*n,s[3]*n),i(s[4]*n,s[5]*n);break;case"Z":break;default:console.error("unknown type")}})}}class GroupObj extends Sprite{constructor(t,e,a,i,r){super(),this.visible=!0,this.uid=t,this.id=e,this.paths=a,this.childGroups=new ActionContainer(i,t=>Array.isArray(t)&&t.some(t=>Number.isFinite(t))),this.maskIdToUse=r,this.flexi=[]}addAction(t,e,a){this.childGroups.addAction(t,a,e)}setCustomFunc(t){"initFuncStr"in t&&(this.customInit=new Function("pathContainer",t.initFuncStr),this.customInit(),delete this.customInit),"controlFuncStr"in t&&(this.control=new Function("pathContainer",t.controlFuncStr))}control(t){}preprocessing(t){this.reset();let e=t.currentActionID;this.childGroups.update(t,e,t.actionList[e].currentFrame)}update(t,e,a=[]){let i=t.currentActionID,r=t.actionList[i].currentFrame,s=e.compSprite(this),n=a.concat(this.flexi),o=s.getMatrix();this.paths.forEach(e=>{e.update(r,i,t,o)}),this.childGroups.result.forEach(e=>{t.groups[e].update(t,s,n)}),n.length<=0||this.paths.forEach(e=>e.calcFlexi(t,n))}draw(t,e,a=!1){if(!this.visible)return;let i=!1;if(!a&&this.maskIdToUse){let a=t.groups[this.maskIdToUse];a?(i=!0,e.save(),a.draw(t,e,!0)):console.error("group is not found : "+this.maskIdToUse)}let r=a?new Path2D:null,s=!1;this.paths.forEach(i=>{s=!0;let n=!1;if(!a&&i.maskIdToUse){let a=t.groups[i.maskIdToUse];a?(n=!0,e.save(),a.draw(t,e,!0)):console.error("mask is not found : "+i.maskIdToUse)}a||(r=new Path2D),i.draw(t,e,r,a),n&&e.restore()}),this.childGroups.result.forEach(i=>{t.groups[i].draw(t,e,a)}),a&&s&&e.clip(r),r=null,i&&e.restore()}debugDraw(t,e){if(this.visible){if(this.maskIdToUse){let a=t.groups[this.maskIdToUse];a?a.debugDraw(t,e):console.error("group is not found : "+this.maskIdToUse)}this.paths.forEach(a=>{if(a.maskIdToUse){let i=t.groups[a.maskIdToUse];i?i.debugDraw(t,e):console.error("mask is not found : "+a.maskIdToUse)}a.debugDraw(t,e)}),this.childGroups.result.forEach(a=>{t.groups[a].debugDraw(t,e)})}}}class BoneObj extends Sprite{constructor(t,e,a,i){super(),this.visible=!0,this.uid=t,this.id=e,this.paths=a,this.childGroups=i,this.effectSprite=new Sprite,a&&a.length>0&&BoneObj.setPath(this,a[0])}static setPath(t,e){let a=e.getPathDataList(),i=a[0].pos[0],r=a[0].pos[1],s=a[1].pos[0],n=a[1].pos[1],o=s-i,h=n-r,l=Math.sqrt(o*o+h*h),c=Math.atan2(h,o);t.defState={x0:i,y0:r,x1:s,y1:n,distance:l,angle:c},t.currentState={pos:[i,r,s,n],distance:l,angle:c}}initIK(t=0,e=0){this.posIK={enable:!1,x:t,y:e}}setCustomFunc(t){"initFuncStr"in t&&(this.customInit=new Function("pathContainer",t.initFuncStr),this.customInit(),delete this.customInit),"controlFuncStr"in t&&(this.control=new Function("pathContainer",t.controlFuncStr))}getSmartFrame(t){if(!this.isSmartBone)return console.error("It is not bone: "+this.id),0;let e=-this.currentState.angle;return(e-=this.smartBase)<0&&(e+=2*Math.PI),e>this.smartMax&&(e=this.smartMax),1+(e/this.smartMax*(t-2)^0)}calcCurrentState(t){let e=this.currentState.pos;if("flexi"in this){this.paths[0].calcFlexi(t,this.flexi);let a=this.paths[0].resultPathList;e[0]=a[0].pos[0],e[1]=a[0].pos[1],e[2]=a[1].pos[0],e[3]=a[1].pos[1]}if("flexiPoint"in this){let a=this.flexiPoint.dataIndex,i=this.paths[0].resultPathList[a].pos.concat();PathObj.calcFlexiPoints(t,this.flexiPoint.bones,i,0,2);let r=i[0]-e[2*a+0],s=i[1]-e[2*a+1];e[0]+=r,e[1]+=s,e[2]+=r,e[3]+=s}let a=e[2]-e[0],i=e[3]-e[1],r=this.currentState.angle=Math.atan2(i,a),s=this.currentState.distance=Math.sqrt(a*a+i*i),n=this.effectSprite;n.x=e[0],n.y=e[1],n.anchorX=this.defState.x0,n.anchorY=this.defState.y0,n.scaleY=s/this.defState.distance,n.rotation=r-this.defState.angle}rotateCurrentState(t,e){let a=this.currentState.distance,i=this.currentState.pos;i[2]=i[0]+Math.cos(e)*a,i[3]=i[1]+Math.sin(e)*a,this.calcCurrentState(t)}limitAngle(t,e){if(void 0===e){let t=this.currentState.pos;e=Math.atan2(t[3]-t[1],t[2]-t[0])}if(!("maxAngle"in this||"minAngle"in this))return e;let a="parentID"in this?t.groups[this.parentID].currentState.angle:0,i=t=>{let e=Math.PI,a=2*e;for(;t<-e;)t+=a;for(;t>=e;)t-=a;return t},r=i(e-a);if("maxAngle"in this){let t=i(this.maxAngle);if(r>t)return t+a}if("minAngle"in this){let t=i(this.minAngle);if(r<t)return t+a}return e}control(t){}preprocessing(t){if(!this.defState)return;let e=this.paths[0].resultPathList=this.paths[0].getPathDataList(t.actionList[t.currentActionID].currentFrame,t.currentActionID);if(2!=e.length)return;let a=[e[0].pos[0],e[0].pos[1],e[1].pos[0],e[1].pos[1]];this.getMatrix(a[0],a[1]).applyToArray(a);let i=this.currentState.pos;i[0]=a[0],i[1]=a[1],i[2]=a[2],i[3]=a[3],this.calcCurrentState(t)}calcInverseKinematics(t){let e=(e,a,i,r)=>{let s=e.pos,n=s[2]-s[0],o=s[3]-s[1],h=Math.atan2(o,n),l=Math.sqrt(n*n+o*o),c=Math.atan2(i-s[1],a-s[0]),u=h-r.currentState.angle,p=r.limitAngle(t,c-u);r.rotateCurrentState(t,p);let d=p+u,f=s[2]=s[0]+Math.cos(d)*l,g=s[3]=s[1]+Math.sin(d)*l;return e.resultAngle=d-u,{x:a-(s[2]-s[0]),y:i-(s[3]-s[1]),amdX:f,amdY:g}},a=(s,n=0)=>{let o=e(r[0],this.posIK.x,this.posIK.y,t.groups[i[0]]);for(let h=1;h<s;++h){let s=(o=e(r[h],o.x,o.y,t.groups[i[h]])).amdX-r[h-1].pos[0],l=o.amdY-r[h-1].pos[1];for(let t=0;t<h;++t){let e=r[t];e.pos[0]+=s,e.pos[1]+=l,e.pos[2]+=s,e.pos[3]+=l}a(h,n+1)}},i=[this.uid],r=[{pos:this.currentState.pos.concat(),defPos:this.currentState.pos.concat()}],s=this;for(;"parentID"in s&&s.feedback;){let e=s.parentID,a=t.groups[e];r.push({pos:[a.currentState.pos[0],a.currentState.pos[1],s.currentState.pos[0],s.currentState.pos[1]],defPos:a.currentState.pos.concat()}),i.push(e),s=a}let n=i.length;a(n);for(let t=n-2;t>=0;--t){let e=r[t],a=r[t+1].pos[2]-e.pos[0],i=r[t+1].pos[3]-e.pos[1];e.pos[0]+=a,e.pos[1]+=i,e.pos[2]+=a,e.pos[3]+=i}let o=0,h=0;for(let e=n-1;e>=0;--e){let a=t.groups[i[e]],s=a.currentState.pos,n=r[e],l=n.pos[0]-n.defPos[0]+o,c=n.pos[1]-n.defPos[1]+h,u=s[0]=n.defPos[0]+l,p=s[1]=n.defPos[1]+c;s[2]=n.defPos[2]+l,s[3]=n.defPos[3]+c,a.rotateCurrentState(t,n.resultAngle),o+=s[0]-u,h+=s[1]-p}}calcForwardKinematics(t){if(!("parentID"in this))return;let e=this.currentState.pos,a=t.groups[this.parentID];if(this.isParentPin){let i=a.effectSprite.x-a.effectSprite.anchorX,r=a.effectSprite.y-a.effectSprite.anchorY;return e[0]+=i,e[1]+=r,e[2]+=i,e[3]+=r,void this.calcCurrentState(t)}a.effectSprite.getMatrix().applyToArray(e),this.calcCurrentState(t)}calc(t){this.calcForwardKinematics(t),"posIK"in this&&this.posIK.enable&&this.calcInverseKinematics(t)}getInfluence(t,e){let a=this.strength;if(!a)return 0;let i=this.defState.x0,r=this.defState.y0,s=this.defState.x1,n=this.defState.y1,o=s-i,h=n-r,l=o*o+h*h,c=-(o*(i-t)+h*(r-e)),u=0;if(c<0)u=(i-t)*(i-t)+(r-e)*(r-e);else if(c>l)u=(s-t)*(s-t)+(n-e)*(n-e);else{let a=o*(r-e)-h*(i-t);u=a*a/l}return u*a}update(){}draw(){}debugDraw(t,e){if(!this.visible||!DebugPath.isShowBones)return;let a=t.pathRatio,i=2*Math.PI;this.paths.forEach(t=>{let r=this.currentState.pos,s=r[0]*a,n=r[1]*a,o=r[2]*a,h=r[3]*a;e.lineJoin="round",e.lineCap="round";let l=new Path2D;l.arc(s,n,DebugPath.bonePointSize,0,i),l.moveTo(s,n),l.lineTo(o,h),e.lineWidth=DebugPath.boneLineSize,e.strokeStyle=DebugPath.boneColor,e.stroke(l);let c=this.strength*a;(l=new Path2D).arc(s,n,c,0,i),l.arc(o,h,c,0,i),e.fillStyle=DebugPath.strengthPointColor,e.fill(l,"nonzero"),(l=new Path2D).moveTo(s,n),l.lineTo(o,h),e.lineWidth=2*c,e.strokeStyle=DebugPath.strengthLineColor,e.stroke(l),l=null}),this.childGroups.forEach(a=>{t.groups[a].debugDraw(t,e)})}}class PathContainer extends Sprite{constructor(t,e){super(),this.visible=!0,this.originalWidth=t,this.originalHeight=e,this.displayWidth=t,this.displayHeight=e,this.pathRatio=0,this.context=null,this.rootGroups=[],this.groups=[],this.bones=[],this.actionList=[],this.currentActionID=-1}getGroup(t){return this.groups.find(e=>e.id==t)}getBone(t){let e=this.getGroup(t);if(e&&this.bones.includes(e.uid))return this.groups[e.uid]}getAction(t){return this.actionList.find(e=>e.name==t)}addAction(t,e,a){return e<0&&(e=this.actionList.length),this.actionList[e]={name:t,id:e,totalFrames:a,pastFrame:0,currentFrame:0}}setSize(t,e){this.originalWidth>this.originalHeight?(this.displayWidth=t,this.displayHeight=t*this.originalHeight/this.originalWidth,this.pathRatio=t):(this.displayWidth=e*this.originalWidth/this.originalHeight,this.displayHeight=e,this.pathRatio=e)}setMouse(t,e){this.mouseX=t/this.pathRatio,this.mouseY=e/this.pathRatio}update(t,e=PathCtr.defaultActionName){if(!this.visible||!this.rootGroups)return;let a=this.getAction(e);if(!a)return void console.error("target action is not found: "+e);a.pastFrame=a.currentFrame,a.currentFrame=t,this.currentActionID=a.id,this.groups.forEach(t=>{t.preprocessing(this)}),this.groups.forEach(t=>{t.control(this)});let i=this.groups.length,r=this.bones.map((t,e)=>{let a=this.groups[t],r={id:t,priority:-1,name:a.id};if(!a.defState)return r;let s=t+2*i,n=0;return this.bones.forEach(t=>{this.groups[t].parentID==a.uid&&(n+=1)}),"parentID"in a?s+=0==n?2*i:i:0==n&&(s+=3*i),r.priority=s,r});r.forEach(t=>{let e=this.groups[t.id];if(!("posIK"in e&&e.posIK.enable))return;let a=t.priority=e.uid+i;for(;"parentID"in e;){if(r.find(t=>t.id==e.parentID).priority=--a,!(e=this.groups[e.parentID]).feedback)break}}),r.sort((t,e)=>t.priority<0?1:e.priority<0?-1:t.priority>e.priority?1:t.priority<e.priority?-1:0),r.some(t=>{if(t.priority<0)return!0;this.groups[t.id].calc(this)}),this.actionList.forEach(t=>{t.id!=a.id&&(t.pastFrame=t.currentFrame,"smartBoneID"in t&&(t.currentFrame=this.groups[t.smartBoneID].getSmartFrame(t.totalFrames)))}),this.rootGroups.forEach(t=>{this.groups[t].update(this,(new Sprite).setSprite(this))})}draw(){this.visible&&this.rootGroups&&(this.context?(this.rootGroups.forEach(t=>{this.groups[t].draw(this,this.context)}),"undefined"!=typeof DebugPath&&DebugPath.isDebugDraw()&&this.rootGroups.forEach(t=>{this.groups[t].debugDraw(this,this.context)})):console.error("context is not found"))}}var BinaryLoader={bonePropList:{parentID:1,isParentPin:2,feedback:3,strength:4,maxAngle:5,minAngle:6,isSmartBone:7,smartBase:8,smartMax:9},init:function(t){if(!t)return console.error("array buffer is not found"),null;let e=new DataView(t),a=0,i=()=>{let t=e.getUint8(a);return a+=1,t},r=()=>{let t=e.getUint16(a);return a+=2,t},s=()=>{let t=e.getFloat32(a);return a+=4,t},n=()=>{let t=e.getInt16(a)/PathCtr.binDataPosRange;return a+=2,t},o=()=>{let t=i(),e="";for(let a=0;a<t;++a)e+=String.fromCharCode(r());return e},h=()=>0==i()?"transparent":"rgb("+i()+", "+i()+", "+i()+")",l=(t,e)=>{let a=Array(t()),i=a.length;for(let t=0;t<i;){let i=r();if(0==i){if(0==(i=r())){console.error("data format error");break}t+=i;continue}let s=e();if(Array.isArray(s))for(let e=0;e<i;++e)a[t+e]=s.concat();else for(let e=0;e<i;++e)a[t+e]=s;t+=i}return a},c=t=>i()?l(i,()=>l(r,()=>t())):t(),u=()=>l(r,()=>l(r,n)),p=()=>{let t=r()-1;t<0&&(t=null);let e=i()?"evenodd":"nonzero",a=(()=>{let t=r(),e=[];for(let a=0;a<t;++a){let t=i();switch(t){case 0:e.push({type:"M",pos:[n(),n()]});break;case 1:e.push({type:"L",pos:[n(),n()]});break;case 2:e.push({type:"C",pos:[n(),n(),n(),n(),n(),n()]});break;case 3:e.push({type:"Z"});break;default:console.error("unknown type : "+t)}}return e})(),o=c(s),l=c(h),p=c(h),d=c(u);return new PathObj(t,a,d,e,l,o,p)},d=t=>{let e=o(),a=r()-1;a<0&&(a=null);let n,h=l(r,p),u=l(i,r);if(e.startsWith(PathCtr.defaultBoneName)){n=new BoneObj(t,e,h,l(i,r));let a=i();for(;a>0;){switch(a){case BinaryLoader.bonePropList.parentID:n.parentID=r();break;case BinaryLoader.bonePropList.isParentPin:n.isParentPin=!0;break;case BinaryLoader.bonePropList.feedback:n.feedback=!0;break;case BinaryLoader.bonePropList.strength:n.strength=s();break;case BinaryLoader.bonePropList.maxAngle:n.maxAngle=s()/180*Math.PI;break;case BinaryLoader.bonePropList.minAngle:n.minAngle=s()/180*Math.PI;break;case BinaryLoader.bonePropList.isSmartBone:n.isSmartBone=!0;break;case BinaryLoader.bonePropList.smartBase:n.smartBase=s()/180*Math.PI;break;case BinaryLoader.bonePropList.smartMax:let t=s();n.smartMax=t/180*Math.PI}a=i()}i()&&(n.flexiPoint={dataIndex:i(),bones:l(i,r)})}else n=new GroupObj(t,e,h,c(()=>l(i,r)),a);return u.length>0&&(n.flexi=u),n},f=PathCtr.initTarget=new PathContainer(r(),r()),g=i();if(g>0)for(let t=0;t<g;++t){let t=f.addAction(o(),i(),r());i()&&(t.smartBoneID=r())}f.rootGroups=l(i,r);let P=r();for(let t=0;t<P;++t){PathCtr.debugPrint("count : "+t),PathCtr.debugPrint(t),PathCtr.debugPrint(a);let e=d(t);f.groups[t]=e,BoneObj.prototype.isPrototypeOf(e)&&f.bones.push(e.uid),PathCtr.debugPrint(e)}return f},load:function(t,e=null){if(!t)return void console.error("filePath not found");let a=new XMLHttpRequest;a.onreadystatechange=function(t){let i=t.target;if(4!=i.readyState)return;if(200!=i.status&&0!=i.status||!i.response)return console.error("failed to read file: "+i.responseURL),void console.error(i.statusText);let r=a.response;BinaryLoader.init(r);PathCtr.loadState("loading completed"),e&&e()},a.open("GET",t,!0),a.responseType="arraybuffer",a.send()}},PathWorker={instance:null,isWorker:!1,postMessage:function(t){PathWorker.isWorker?PathWorker.instance.postMessage(t):window.dispatchEvent(new CustomEvent("message",{bubbles:!0,detail:t}))},init:function(){PathWorker.instance.addEventListener("message",function(t){let e=t.data?t.data:t.detail;switch(e.cmd){case"init":return PathCtr.loadState("init"),PathCtr.defaultBoneName=e.defaultBoneName,PathCtr.init(e.canvas,e.subCanvas,e.viewWidth,e.viewHeight),!1;case"load-complete":return PathCtr.loadComplete(),PathWorker.postMessage({cmd:"main-init-complete"}),!1;case"load-bin":return BinaryLoader.load(e.path,()=>{PathCtr.loadComplete(),PathWorker.postMessage({cmd:"main-init-complete"})}),!1;case"load-bone":return BoneLoader.load(e.path,PathCtr.pathContainer),!1;case"resize-canvas":return PathCtr.setSize(e.viewWidth,e.viewHeight),!1;case"change-action":return PathCtr.actionName=e.name,void 0!==e.frame&&e.frame>=0&&(PathCtr.frameNumber=e.frame),!1;case"move-mouse":return PathCtr.pathContainer&&PathCtr.pathContainer.setMouse(e.x,e.y),!1;case"keyup":return"undefined"!=typeof DebugPath&&DebugPath.keyUp(PathCtr.pathContainer,e.code),!1;case"set-group-control":return void 0!==(a=PathCtr.pathContainer.getGroup(e.name))?(a.setCustomFunc(e),PathCtr.loadState("set group control: "+a.id)):console.error(e.name+" is not found."),!1;case"output-path-container":return DebugPath.outputJSON(PathCtr.pathContainer),!1;case"output-bin":return DebugPath.outputBin(PathCtr.pathContainer),!1;case"create-path-container":return PathCtr.loadState("init path container"),PathCtr.initTarget=new PathContainer(e.width,e.height),!1;case"add-action":return PathCtr.loadState("load action: "+e.actionName+" - "+e.totalFrames),PathCtr.initTarget.addAction(e.actionName,e.frame,e.totalFrames),!1;case"add-root-group":return PathCtr.initTarget.rootGroups.push(e.id),!1;case"new-group":return PathCtr.initTarget.groups[e.uid]=new GroupObj(e.uid,e.name,[],[],e.maskID),!1;case"new-bone":return PathCtr.initTarget.groups[e.uid]=new BoneObj(e.uid,e.name,[],[]),PathCtr.initTarget.bones.push(e.uid),!1;case"add-group-action":return PathCtr.initTarget.bones.includes(e.uid)||PathCtr.initTarget.groups[e.uid].addAction(e.childGroups,e.frame,PathCtr.initTarget.getAction(e.actionName).id),!1;case"set-child-group-id":return PathCtr.initTarget.bones.includes(e.uid)?PathCtr.initTarget.groups[e.uid].childGroups=e.childGroups:PathCtr.initTarget.groups[e.uid].childGroups.setData(e.childGroups),!1;case"new-path":return PathCtr.initTarget.groups[e.uid].paths.push(new PathObj(e.maskID,e.pathDataList,e.pathDiffList,e.fillRule,e.fillStyle,e.lineWidth,e.strokeStyle)),!1;case"new-bone-path":if(PathCtr.initTarget.groups[e.uid].paths.push(new PathObj(null,e.pathDataList,e.pathDiffList,"nonzero","transparent",2,"rgb(0, 255, 0)")),1==PathCtr.initTarget.groups[e.uid].paths.length){let t=PathCtr.initTarget.groups[e.uid];BoneObj.setPath(t,t.paths[0])}return!1;case"add-path-action":return PathCtr.initTarget.groups[e.uid].paths[e.pathID].addAction(e.pathDataList,e.fillStyle,e.lineWidth,e.strokeStyle,e.frame,PathCtr.initTarget.getAction(e.actionName).id),!1;case"add-bone-path-action":return PathCtr.initTarget.groups[e.uid].paths[e.pathID].addAction(e.pathDataList,"transparent",2,"rgb(0, 255, 0)",e.frame,PathCtr.initTarget.getAction(e.actionName).id),!1;case"set-unvisible-path-action":return PathCtr.initTarget.groups[e.uid].paths.forEach(t=>{t.addAction(null,"transparent",0,"transparent",e.frame,PathCtr.initTarget.getAction(e.actionName).id)}),!1;default:return t.bubbles||console.error("unknown command: "+e.cmd),!0}var a},!1)}};PathWorker.isWorker="undefined"!=typeof DedicatedWorkerGlobalScope,PathWorker.isWorker?(PathWorker.instance=this,PathWorker.init()):(PathWorker.instance=window,PathWorker.init(),PathMain.initWorker());';var PathMain={defaultBoneName:"bone",isUseMin:!1,worker:null,useWorker:!1,path:null,canvas:null,subCanvas:null,completeFunc:null,postMessage:function(t,e){PathMain.useWorker?PathMain.worker.postMessage(t,e):window.dispatchEvent(new CustomEvent("message",{bubbles:!0,detail:t}))},initWorker:function(){let t=PathMain.canvas,e=PathMain.subCanvas,a=document.documentElement.clientWidth,i=document.documentElement.clientHeight;t.width=e.width=a,t.height=e.height=i,t.setAttribute("style","position:fixed;z-index:-1;left:0;top:0;width:"+a+"px;height:"+i+"px;"),PathMain.worker.addEventListener("message",function(t){let e=t.data?t.data:t.detail;switch(e.cmd){case"main-init-complete":case"main-bone-load-complete":return PathMain.completeFunc(),!1;case"main-confirm":return confirm(e.message)&&PathMain.postMessage({cmd:e.callback}),!1;case"main-download":return PathMain.downloadData(e.type,e.fileName,e.data),!1;default:return t.bubbles||console.error("unknown command: "+e.cmd),!0}},!1),window.addEventListener("resize",function(){let t=document.documentElement.clientWidth,e=document.documentElement.clientHeight;PathMain.canvas.setAttribute("style","position:fixed;z-index:-1;left:0;top:0;width:"+PathMain.viewWidth+"px;height:"+PathMain.viewHeight+"px;"),PathMain.postMessage({cmd:"resize-canvas",viewWidth:t,viewHeight:e})}),window.addEventListener("mousemove",function(t){PathMain.postMessage({cmd:"move-mouse",x:t.clientX,y:t.clientY}),t.preventDefault()},{passive:!1}),window.addEventListener("touchmove",function(t){PathMain.postMessage({cmd:"move-mouse",x:t.touches[0].pageX,y:t.touches[0].pageY}),t.preventDefault()},{passive:!1}),window.addEventListener("keyup",function(t){PathMain.postMessage({cmd:"keyup",code:t.code})});let r=PathMain.canvas,s=PathMain.subCanvas;PathMain.useWorker&&(r=r.transferControlToOffscreen(),s=s.transferControlToOffscreen()),PathMain.postMessage({cmd:"init",viewWidth:a,viewHeight:i,canvas:r,subCanvas:s,defaultBoneName:PathMain.defaultBoneName},[r,s]),PathMain.path&&PathMain.postMessage({cmd:"load-bin",path:PathMain.path})},downloadData:function(t,e,a){let i=document.createElement("a");document.body.appendChild(i),i.style="display: none",console.log(i);let r=new Blob([a],{type:t});i.href=window.URL.createObjectURL(r),i.download=e,i.click(),i.remove()},outputBin:function(){PathMain.postMessage({cmd:"output-bin"})},loadBone:function(t,e){PathMain.completeFunc=e,PathMain.postMessage({cmd:"load-bone",path:new URL(t,window.location.href).href})},init:function(t,e,a){let i=document.getElementById("path-container");if(!i)return void console.error("CanvasContainer is not found.");t&&(PathMain.path=new URL(t,window.location.href).href),PathMain.completeFunc=e;document.currentScript.src;let r=new Blob([path_control],{type:"text/javascript"}),s=window.URL.createObjectURL(r),n=PathMain.canvas=document.createElement("canvas");n.className="main-canvas",i.appendChild(n);let o=PathMain.subCanvas=document.createElement("canvas");if(o.className="sub-canvas",o.setAttribute("style","display:none;"),i.appendChild(o),PathMain.useWorker=!!Worker&&!!n.transferControlToOffscreen,PathMain.useWorker)PathMain.worker=new Worker(s),PathMain.initWorker();else{console.log("this browser is not supported"),PathMain.worker=window;let t=document.createElement("script");t.src=s,document.body.appendChild(t)}}};