/**
 * path_control v0.8.0
 * 
 * Copyright (c) 2020 BUN
 * 
 * This software is released under the MIT License.
 * https://opensource.org/licenses/MIT
 **/
let path_control='\nvar InputInfo={isMouseDownLeft:!1,isMouseDownMiddle:!1,isMouseDownRight:!1,isMouseDownBack:!1,isMouseDownForward:!1,mouseX:0,mouseY:0,touches:[],isValidPointer:!1,pointerX:0,pointerY:0,setMousePos:function(t,e){this.pointerX=this.mouseX=t,this.pointerY=this.mouseY=e},setMouseState:function(t,e){switch(t){case 0:this.isMouseDownLeft=e;break;case 1:this.isMouseDownMiddle=e;break;case 2:this.isMouseDownRight=e;break;case 3:this.isMouseDownBack=e;break;case 4:this.isMouseDownForward=e}},setTouch:function(t){this.touches=t,0!=this.touches.length?(this.isValidPointer=!0,this.pointerX=this.touches[0].pageX,this.pointerY=this.touches[0].pageY):this.isValidPointer=!1}},PathCtr={defaultCanvasContainerID:"path-container",defaultActionName:"base",initTarget:null,pathContainers:[],canvas:null,subCanvas:null,context:null,subContext:null,viewWidth:0,viewHeight:0,fixFrameTime:1/24,prevTimestamp:0,average:0,requestAnimationIDs:[],setTimeoutIDs:[],cancelRequestAnimation:function(){(PathCtr.requestAnimationIDs.length>1||PathCtr.setTimeoutIDs.length>1)&&console.error("requestAnimationIDs:"+PathCtr.requestAnimationIDs.length+", "+PathCtr.setTimeoutIDs.length),PathCtr.requestAnimationIDs.forEach(cancelAnimationFrame),PathCtr.requestAnimationIDs.length=0,PathCtr.setTimeoutIDs.forEach(clearTimeout),PathCtr.setTimeoutIDs.length=0},setSize:function(t,e){PathCtr.canvas.width=PathCtr.subCanvas.width=PathCtr.viewWidth=t,PathCtr.canvas.height=PathCtr.subCanvas.height=PathCtr.viewHeight=e,PathCtr.pathContainers.forEach(i=>{i.setSize(t,e)}),PathCtr.update()},loadComplete:function(){let t=PathCtr.initTarget;null!=t.index?PathCtr.pathContainers[t.index]=t:PathCtr.pathContainers.push(t),t.context=PathWorker.isWorker?PathCtr.context:PathCtr.subContext,PathCtr.setSize(PathCtr.viewWidth,PathCtr.viewHeight),PathCtr.initTarget=null,PathWorker.loadPrint(t),void 0!==DebugPath&&DebugPath.init(t),t.visible=!0,"undefined"!=typeof setup&&setup(t)},draw:function(t){if(void 0!==DebugPath&&DebugPath.isStop){if(!DebugPath.isStep)return;DebugPath.isStep=!1,PathCtr.pathContainers.forEach(t=>{let e=t.actionList[t.currentActionID];console.log("STEP: "+e.name+" - "+e.currentFrame)})}if(void 0===t)return;let e=(t-PathCtr.prevTimestamp)/1e3;if(PathCtr.average=(PathCtr.average+e)/2,PathCtr.pathContainers.length<=0)return PathCtr.context.clearRect(0,0,PathCtr.viewWidth,PathCtr.viewHeight),PathCtr.context.fillStyle="#000000",PathCtr.context.font="20px Arial",void PathCtr.context.fillText(PathWorker.loadState,20,PathCtr.viewHeight-20);if(PathWorker.isWorker){if(PathCtr.context.clearRect(0,0,PathCtr.viewWidth,PathCtr.viewHeight),PathCtr.pathContainers.forEach(t=>t.draw()),t-PathCtr.prevTimestamp<1/24*500)return}else PathCtr.subContext.clearRect(0,0,PathCtr.viewWidth,PathCtr.viewHeight),PathCtr.pathContainers.forEach(t=>t.draw()),PathCtr.context.clearRect(0,0,PathCtr.viewWidth,PathCtr.viewHeight),PathCtr.context.putImageData(PathCtr.subContext.getImageData(0,0,PathCtr.viewWidth,PathCtr.viewHeight),0,0);PathCtr.pathContainers.forEach(t=>t.step()),PathCtr.prevTimestamp=t,PathCtr.average>1/24*2?(PathCtr.fixFrameTime*=.99,PathWorker.debugPrint("up")):PathCtr.average<1/24*.5?(PathCtr.fixFrameTime*=1.01,PathWorker.debugPrint("down")):PathCtr.fixFrameTime=(1/24+PathCtr.fixFrameTime)/2,PathCtr.pathContainers.forEach(t=>t.update())},update:function(){PathCtr.cancelRequestAnimation(),PathCtr.requestAnimationIDs.push(requestAnimationFrame(PathCtr.draw)),PathCtr.setTimeoutIDs.push(setTimeout(PathCtr.update,1e3*PathCtr.fixFrameTime))},init:function(t,e,i,a){t&&e?(PathCtr.canvas=t,PathCtr.context=t.getContext("2d"),PathCtr.subCanvas=e,PathCtr.subContext=e.getContext("2d"),PathCtr.context&&PathCtr.subContext?(t.width=e.width=PathCtr.viewWidth=i,t.height=e.height=PathCtr.viewHeight=a,PathCtr.update()):console.error("context is not found.")):console.error("canvas is not found.")}};class Matrix{constructor(){this.a=1,this.b=0,this.c=0,this.d=1,this.e=0,this.f=0}reset(){return this.a=this.d=1,this.b=this.c=this.e=this.f=0,this}applyToPoint(t,e=0){let i=t[e],a=t[e+1];t[e]=i*this.a+a*this.c+this.e,t[e+1]=i*this.b+a*this.d+this.f}applyToArray(t,e=0){let i=t.length;for(let a=e;a<i;a+=2)this.applyToPoint(t,a)}setMatrix(t){return this.a=t.a,this.b=t.b,this.c=t.c,this.d=t.d,this.e=t.e,this.f=t.f,this}interpolate(t,e){let i=new Matrix;return i.a=this.a+(t.a-this.a)*e,i.b=this.b+(t.b-this.b)*e,i.c=this.c+(t.c-this.c)*e,i.d=this.d+(t.d-this.d)*e,i.e=this.e+(t.e-this.e)*e,i.f=this.f+(t.f-this.f)*e,i}mult(t){let e=new Matrix;return e.a=this.a*t,e.b=this.b*t,e.c=this.c*t,e.d=this.d*t,e.e=this.e*t,e.f=this.f*t,e}multAndAddPoint(t,e,i,a,r){a[r]+=(e*this.a+i*this.c+this.e)*t,a[r+1]+=(e*this.b+i*this.d+this.f)*t}setTransform(t,e,i,a,r,s){return this.a=t,this.b=e,this.c=i,this.d=a,this.e=r,this.f=s,this}transform(t,e,i,a,r,s){let n=this.a,o=this.b,h=this.c,l=this.d,c=this.e,u=this.f;return this.a=n*t+h*e,this.b=o*t+l*e,this.c=n*i+h*a,this.d=o*i+l*a,this.e=n*r+h*s+c,this.f=o*r+l*s+u,this}rotate(t){let e=Math.cos(t),i=Math.sin(t);return this.transform(e,i,-i,e,0,0)}transformFromMatrix(t){return this.transform(t.a,t.b,t.c,t.d,t.e,t.f)}scale(t,e=t){return this.transform(t,0,0,e,0,0)}scaleX(t){return this.transform(t,0,0,1,0,0)}scaleY(t){return this.transform(1,0,0,t,0,0)}skew(t,e){return this.transform(1,e,t,1,0,0)}skewX(t){return this.transform(1,0,t,1,0,0)}skewY(t){return this.transform(1,t,0,1,0,0)}translate(t,e){return this.transform(1,0,0,1,t,e)}translateX(t){return this.transform(1,0,0,1,t,0)}translateY(t){return this.transform(1,0,0,1,0,t)}}class Sprite{constructor(){this.m=new Matrix,this.x=0,this.y=0,this.anchorX=0,this.anchorY=0,this.scaleX=1,this.scaleY=1,this.rotation=0}reset(){this.x=0,this.y=0,this.anchorX=0,this.anchorY=0,this.scaleX=1,this.scaleY=1,this.rotation=0}clone(){let t=new Sprite;return t.x=this.x,t.y=this.y,t.anchorX=this.anchorX,t.anchorY=this.anchorY,t.scaleX=this.scaleX,t.scaleY=this.scaleY,t.rotation=this.rotation,t}setSprite(t){return this.x=t.x,this.y=t.y,this.anchorX=t.anchorX,this.anchorY=t.anchorY,this.scaleX=t.scaleX,this.scaleY=t.scaleY,this.rotation=t.rotation,this}addSprite(t){return this.x+=t.x,this.y+=t.y,this.anchorX+=t.anchorX,this.anchorY+=t.anchorY,this.scaleX*=t.scaleX,this.scaleY*=t.scaleY,this.rotation=t.rotation,this}compSprite(t){let e=new Sprite;return e.x=this.x+t.x,e.y=this.y+t.y,e.anchorX=this.anchorX+t.anchorX,e.anchorY=this.anchorY+t.anchorY,e.scaleX=this.scaleX*t.scaleX,e.scaleY=this.scaleY*t.scaleY,e.rotation=this.rotation+t.rotation,e}getMatrix(t=0,e=0){return this.m.reset().translate(this.x+t,this.y+e).rotate(this.rotation).scale(this.scaleX,this.scaleY).translate(-this.anchorX-t,-this.anchorY-+e)}}class ActionContainer{constructor(t,e){this.data=t,this.checkFunc=e,this.hasAction=Array.isArray(t)&&t.some(t=>Array.isArray(t)&&t.some(e)),this.result=this.hasAction?t[0][0]:t}setData(t,e=0,i=0){this.hasAction?this.addAction(t,e,i):(this.data=t,this.hasAction=Array.isArray(t)&&t.some(t=>Array.isArray(t)&&t.some(this.checkFunc)),this.result=this.hasAction?t[0][0]:t)}addAction(t,e,i){if(!this.hasAction){if(JSON.stringify(this.data)==JSON.stringify(t))return;this.data=[[this.data]],this.hasAction=!0}void 0===this.data[e]&&(this.data[e]=[this.data[0][0].concat()]);let a=!0;for(let r=this.data[e].length-1;r>=0;--r)if(void 0!==this.data[e][r]){if(JSON.stringify(t)==JSON.stringify(this.data[e][r]))break;this.data[e][i]=t,a=!1;break}a&&(this.data[e][i]=void 0)}hasActionID(t){return!!this.hasAction&&void 0!==this.data[t]}getData(t=0,e=0){return this.hasAction?this.data[t][Math.min(e,this.data[t].length-1)]:this.data}getAvailableData(t=0,e=0){if(!this.hasAction)return this.data;if(!this.hasActionID(t))return this.data[0][0];for(let i=e;i>=0;--i){let e=this.getData(t,i);if(void 0!==e)return e}}update(t,e=0,i=0){if(!this.hasAction)return;this.hasActionID(e)||(e=0);let a=null;this.data.forEach((e,i)=>{let r=t.actionList[i],s=r.pastFrame,n=r.currentFrame;if(s!=n)if(s<=n)for(let t=Math.min(n,e.length-1);t>=s;--t){let i=e[t];if(void 0!==i){a=i,this.result!=a&&PathWorker.debugPrint(r.name,r.pastFrame,r.currentFrame,a);break}}else for(let t=Math.min(s,e.length-1);t>=n;--t){if(void 0!==e[t]){for(let t=Math.min(n,e.length-1);t>=0;--t){let i=e[t];if(void 0!==i){a=i,this.result!=a&&PathWorker.debugPrint(r.name,r.pastFrame,r.currentFrame,a);break}}break}}}),a&&this.result!=a&&(this.result=a)}}class PathObj{constructor(t,e,i,a,r,s,n){this.maskIdToUse=t,this.fillRule=a,this.pathDiffList=new ActionContainer(i,t=>Array.isArray(t)&&t.some(t=>Array.isArray(t))),this.fillStyle=new ActionContainer(r,t=>"string"==typeof t),this.lineWidth=new ActionContainer(s,t=>Number.isFinite(t)),this.strokeStyle=new ActionContainer(n,t=>"string"==typeof t),this.resultPathList=e,this.defPathList=e}addAction(t,e,i,a,r,s){t?this.defPathList.length!=t.length&&(console.error("The number of paths does not match."),console.log(this.defPathList),console.log(t),t=this.defPathList.concat()):t=this.defPathList.concat();let n=[];this.defPathList.forEach((e,i)=>{if(e.type!=t[i].type)return console.error("type does not match."),console.log(this.defPathList),void console.log(t);e.pos&&(n[i]=[],e.pos.forEach((e,a)=>{n[i].push(t[i].pos[a]-e)}))}),this.pathDiffList.addAction(n,s,r),this.fillStyle.addAction(e,s,r),this.lineWidth.addAction(i,s,r),this.strokeStyle.addAction(a,s,r)}makeData(t){let e=[];return this.defPathList.forEach((i,a)=>{e.push({type:i.type,pos:i.pos?i.pos.map((e,i)=>e+t[a][i]):void 0})}),e}getPathDataList(t=0,e=0){return this.makeData(this.pathDiffList.getAvailableData(e,t))}getMergePathDataList(t,e=0,i=0){if(!this.pathDiffList.hasAction)return this.makeData(this.pathDiffList.getData());this.pathDiffList.hasActionID(i)||(i=0,e=0);let a=this.makeData(this.pathDiffList.getAvailableData(i,e));return 1==t.actionList.length?a:(t.actionList.forEach(t=>{i!=t.id&&this.pathDiffList.hasActionID(t.id)&&this.pathDiffList.getAvailableData(t.id,t.currentFrame).forEach((t,e)=>{t&&t.forEach((t,i)=>{t&&(a[e].pos[i]+=t)})})}),a)}static calcFlexiPoints(t,e,i,a=0,r=i.length){if(!(!i||i.length>a+r||r<2))for(let s=a;s<a+r;s+=2){if(1==e.length){let a=e[0];if(0==t.groups[a].strength)continue;t.groups[a].effectSprite.getMatrix().applyToPoint(i,s);continue}let a=i[s],r=i[s+1],n=[],o=0;e.forEach(e=>{let i=t.groups[e].getInfluence(a,r);o+=i,n.push(i)}),0!=o&&(i[s]=0,i[s+1]=0,e.forEach((e,h)=>{t.groups[e].effectSprite.getMatrix().multAndAddPoint(1-n[h]/o,a,r,i,s)}))}}calcFlexi(t,e){this.resultPathList.forEach(i=>{i.pos&&0!=i.pos.length&&PathObj.calcFlexiPoints(t,e,i.pos)})}update(t,e,i,a){let r=this.getMergePathDataList(i,t,e);r.forEach(t=>{t.pos&&a.applyToArray(t.pos)}),this.resultPathList=r,this.fillStyle.update(i,e,t),this.lineWidth.update(i,e,t),this.strokeStyle.update(i,e,t)}draw(t,e,i,a){this.resultPathList.forEach(e=>{let a=e.pos,r=t.pathRatio;switch(e.type){case"M":i.moveTo(a[0]*r,a[1]*r);break;case"L":i.lineTo(a[0]*r,a[1]*r);break;case"C":i.bezierCurveTo(a[0]*r,a[1]*r,a[2]*r,a[3]*r,a[4]*r,a[5]*r);break;case"Z":i.closePath();break;default:console.error("unknown type")}}),a||(this.lineWidth.result&&(e.lineJoin="round",e.lineCap="round",e.lineWidth=this.lineWidth.result,e.strokeStyle=this.strokeStyle.result,e.stroke(i)),e.fillStyle=this.fillStyle.result,e.fill(i,this.fillRule))}debugDraw(t,e){let i=2*Math.PI,a=(t,a)=>{if(!DebugPath.isShowPoints)return;let r=new Path2D;r.arc(t,a,DebugPath.pointSize,0,i),e.fillStyle=DebugPath.pointColor,e.fill(r,"nonzero")};this.resultPathList.forEach(r=>{let s=r.pos,n=t.pathRatio;switch(r.type){case"M":case"L":a(s[0]*n,s[1]*n);break;case"C":((t,a,r,s)=>{if(!DebugPath.isShowControls)return;let n=new Path2D;n.arc(t,a,DebugPath.controlSize,0,i),n.arc(r,s,DebugPath.controlSize,0,i),e.fillStyle=DebugPath.controlColor,e.fill(n,"nonzero")})(s[0]*n,s[1]*n,s[2]*n,s[3]*n),a(s[4]*n,s[5]*n);break;case"Z":break;default:console.error("unknown type")}})}}class GroupObj extends Sprite{constructor(t,e,i,a,r){super(),this.visible=!0,this.uid=t,this.id=e,this.paths=i,this.childGroups=new ActionContainer(a,t=>Array.isArray(t)&&t.some(t=>Number.isFinite(t))),this.maskIdToUse=r,this.flexi=[]}addAction(t,e,i){this.childGroups.addAction(t,i,e)}preprocessing(t){this.reset();let e=t.currentActionID;this.childGroups.update(t,e,t.actionList[e].currentFrame)}update(t,e,i=[]){let a=t.currentActionID,r=t.actionList[a].currentFrame,s=e.compSprite(this),n=i.concat(this.flexi),o=s.getMatrix();this.paths.forEach(e=>{e.update(r,a,t,o)}),this.childGroups.result.forEach(e=>{t.groups[e].update(t,s,n)}),n.length<=0||this.paths.forEach(e=>e.calcFlexi(t,n))}draw(t,e,i=!1){if(!this.visible)return;let a=!1;if(!i&&this.maskIdToUse){let i=t.groups[this.maskIdToUse];i?(a=!0,e.save(),i.draw(t,e,!0)):console.error("group is not found : "+this.maskIdToUse)}let r=i?new Path2D:null,s=!1;this.paths.forEach(a=>{s=!0;let n=!1;if(!i&&a.maskIdToUse){let i=t.groups[a.maskIdToUse];i?(n=!0,e.save(),i.draw(t,e,!0)):console.error("mask is not found : "+a.maskIdToUse)}i||(r=new Path2D),a.draw(t,e,r,i),n&&e.restore()}),this.childGroups.result.forEach(a=>{t.groups[a].draw(t,e,i)}),i&&s&&e.clip(r),r=null,a&&e.restore()}debugDraw(t,e){if(this.visible){if(this.maskIdToUse){let i=t.groups[this.maskIdToUse];i?i.debugDraw(t,e):console.error("group is not found : "+this.maskIdToUse)}this.paths.forEach(i=>{if(i.maskIdToUse){let a=t.groups[i.maskIdToUse];a?a.debugDraw(t,e):console.error("mask is not found : "+i.maskIdToUse)}i.debugDraw(t,e)}),this.childGroups.result.forEach(i=>{t.groups[i].debugDraw(t,e)})}}}class BoneObj extends Sprite{constructor(t,e,i,a){super(),this.visible=!0,this.uid=t,this.id=e,this.paths=i,this.childGroups=a,this.effectSprite=new Sprite,i&&i.length>0&&BoneObj.setPath(this,i[0])}static getDistAndAngle(t,e,i,a,r){let s=a-e,n=r-i;return 0==s&&0==n?{x0:e,y0:i,x1:a,y1:r,distance:0,angle:0}:{x0:e,y0:i,x1:a,y1:r,distance:Math.sqrt(s*s+n*n),angle:Math.atan2(n,s)}}static setPath(t,e){let i=e.getPathDataList(),a=BoneObj.getDistAndAngle(t.id+":setPath",i[0].pos[0],i[0].pos[1],i[1].pos[0],i[1].pos[1]);t.defState=a,t.currentState={pos:[a.x0,a.y0,a.x1,a.y1],distance:a.distance,angle:a.angle}}initIK(t=0,e=0){this.posIK={enable:!1,x:t,y:e}}calcCurrentState(t){let e=this.currentState.pos;if("flexi"in this){this.paths[0].calcFlexi(t,this.flexi);let i=this.paths[0].resultPathList;e[0]=i[0].pos[0],e[1]=i[0].pos[1],e[2]=i[1].pos[0],e[3]=i[1].pos[1]}if("flexiPoint"in this){let i=this.flexiPoint.dataIndex,a=this.paths[0].resultPathList[i].pos.concat();PathObj.calcFlexiPoints(t,this.flexiPoint.bones,a,0,2);let r=a[0]-e[2*i+0],s=a[1]-e[2*i+1];e[0]+=r,e[1]+=s,e[2]+=r,e[3]+=s}let i=BoneObj.getDistAndAngle(this.id+":calcCurrentState",e[0],e[1],e[2],e[3]);this.currentState.distance=i.distance,this.currentState.angle=i.angle;let a=this.effectSprite;a.x=e[0],a.y=e[1],a.anchorX=this.defState.x0,a.anchorY=this.defState.y0,a.scaleY=i.distance/this.defState.distance,isNaN(a.scaleY)&&(a.scaleY=1),a.rotation=i.angle-this.defState.angle}rotateCurrentState(t,e){let i=this.currentState.distance,a=this.currentState.pos;a[2]=a[0]+Math.cos(e)*i,a[3]=a[1]+Math.sin(e)*i,this.calcCurrentState(t)}limitAngle(t,e){if(void 0===e){let t=this.currentState.pos;e=Math.atan2(t[3]-t[1],t[2]-t[0]),isNaN(e)&&(e=0)}if(!("maxAngle"in this||"minAngle"in this))return e;let i="parentID"in this?t.groups[this.parentID].currentState.angle:0,a=t=>{let e=Math.PI,i=2*e;for(;t<-e;)t+=i;for(;t>=e;)t-=i;return t},r=a(e-i);if("maxAngle"in this){let t=a(this.maxAngle);if(r>t)return t+i}if("minAngle"in this){let t=a(this.minAngle);if(r<t)return t+i}return e}preprocessing(t){if(!this.defState)return;let e=this.paths[0].resultPathList=this.paths[0].getPathDataList(t.actionList[t.currentActionID].currentFrame,t.currentActionID);if(2!=e.length)return;let i=[e[0].pos[0],e[0].pos[1],e[1].pos[0],e[1].pos[1]];this.getMatrix(i[0],i[1]).applyToArray(i);let a=this.currentState.pos;a[0]=i[0],a[1]=i[1],a[2]=i[2],a[3]=i[3],this.calcCurrentState(t)}calcInverseKinematics(t){let e=(e,i,a,r)=>{let s=e.pos,n=BoneObj.getDistAndAngle(this.id+":calcInverseKinematics",s[0],s[1],s[2],s[3]),o=Math.atan2(a-s[1],i-s[0]);isNaN(o)&&(o=0);let h=n.angle-r.currentState.angle,l=r.limitAngle(t,o-h);r.rotateCurrentState(t,l);let c=l+h,u=s[2]=s[0]+Math.cos(c)*n.distance,d=s[3]=s[1]+Math.sin(c)*n.distance;return e.resultAngle=c-h,{x:i-(s[2]-s[0]),y:a-(s[3]-s[1]),amdX:u,amdY:d}},i=(s,n=0)=>{let o=e(r[0],this.posIK.x,this.posIK.y,t.groups[a[0]]);for(let h=1;h<s;++h){let s=(o=e(r[h],o.x,o.y,t.groups[a[h]])).amdX-r[h-1].pos[0],l=o.amdY-r[h-1].pos[1];for(let t=0;t<h;++t){let e=r[t];e.pos[0]+=s,e.pos[1]+=l,e.pos[2]+=s,e.pos[3]+=l}i(h,n+1)}},a=[this.uid],r=[{pos:this.currentState.pos.concat(),defPos:this.currentState.pos.concat()}],s=this;for(;"parentID"in s;){let e=s.parentID,i=t.groups[e];if(i.fixed)break;r.push({pos:[i.currentState.pos[0],i.currentState.pos[1],s.currentState.pos[0],s.currentState.pos[1]],defPos:i.currentState.pos.concat()}),a.push(e),s=i}let n=a.length;i(n);for(let t=n-2;t>=0;--t){let e=r[t],i=r[t+1].pos[2]-e.pos[0],a=r[t+1].pos[3]-e.pos[1];e.pos[0]+=i,e.pos[1]+=a,e.pos[2]+=i,e.pos[3]+=a}let o=0,h=0;for(let e=n-1;e>=0;--e){let i=t.groups[a[e]],s=i.currentState.pos,n=r[e],l=n.pos[0]-n.defPos[0]+o,c=n.pos[1]-n.defPos[1]+h,u=s[0]=n.defPos[0]+l,d=s[1]=n.defPos[1]+c;s[2]=n.defPos[2]+l,s[3]=n.defPos[3]+c,i.rotateCurrentState(t,n.resultAngle),o+=s[0]-u,h+=s[1]-d}}calcForwardKinematics(t){if(!("parentID"in this))return;let e=this.currentState.pos;t.groups[this.parentID].effectSprite.getMatrix().applyToArray(e),this.calcCurrentState(t)}calc(t){this.calcForwardKinematics(t),"posIK"in this&&this.posIK.enable&&this.calcInverseKinematics(t)}getInfluence(t,e){let i=this.strength;if(!i)return 0;let a=this.defState.x0,r=this.defState.y0,s=this.defState.x1,n=this.defState.y1,o=s-a,h=n-r,l=o*o+h*h,c=-(o*(a-t)+h*(r-e)),u=0;if(c<0)u=(a-t)*(a-t)+(r-e)*(r-e);else if(c>l)u=(s-t)*(s-t)+(n-e)*(n-e);else{let i=o*(r-e)-h*(a-t);u=i*i/l}return u*i}update(){}draw(){}debugDraw(t,e){if(!this.visible||!DebugPath.isShowBones)return;let i=t.pathRatio,a=2*Math.PI;this.paths.forEach(t=>{let r=this.currentState.pos,s=r[0]*i,n=r[1]*i,o=r[2]*i,h=r[3]*i;e.lineJoin="round",e.lineCap="round";let l=new Path2D;l.arc(s,n,DebugPath.bonePointSize,0,a),l.moveTo(s,n),l.lineTo(o,h),e.lineWidth=DebugPath.boneLineSize,e.strokeStyle=DebugPath.boneColor,e.stroke(l);let c=this.strength*i/10;(l=new Path2D).arc(s,n,c,0,a),l.arc(o,h,c,0,a),e.fillStyle=DebugPath.strengthPointColor,e.fill(l,"nonzero"),(l=new Path2D).moveTo(s,n),l.lineTo(o,h),e.lineWidth=2*c,e.strokeStyle=DebugPath.strengthLineColor,e.stroke(l),l=null}),this.childGroups.forEach(i=>{t.groups[i].debugDraw(t,e)})}}class PathContainer extends Sprite{constructor(t,e,i){super(),this.name=t,this.index=null,this.visible=!1,this.originalWidth=e,this.originalHeight=i,this.displayWidth=e,this.displayHeight=i,this.pathRatio=0,this.context=null,this.rootGroups=[],this.groups=[],this.bones=[],this.actionList=[],this.currentActionID=0,this.currentFrame=0}getGroup(t){return this.groups.find(e=>e.id==t)}getBone(t){let e=this.getGroup(t);if(e&&this.bones.includes(e.uid))return this.groups[e.uid]}getAction(t){return this.actionList.find(e=>e.name==t)}setAction(t,e){let i=this.actionList.find(e=>e.name==t);i?(this.currentActionID=i.id,void 0!==e&&e>=0&&(i.currentFrame=this.currentFrame=e%i.totalFrames)):console.error("target action is not found: "+t)}addAction(t,e,i){return e<0&&(e=this.actionList.length),this.actionList[e]={name:t,id:e,totalFrames:i,pastFrame:0,currentFrame:0}}setSize(t,e){this.originalWidth>this.originalHeight?(this.displayWidth=t,this.displayHeight=t*this.originalHeight/this.originalWidth,this.pathRatio=t):(this.displayWidth=e*this.originalWidth/this.originalHeight,this.displayHeight=e,this.pathRatio=e)}step(){let t=this.actionList[this.currentActionID];this.currentFrame=this.currentFrame%t.totalFrames+1}update(){if(!this.visible||!this.rootGroups)return;let t=this.actionList[this.currentActionID];t.pastFrame=t.currentFrame,t.currentFrame=this.currentFrame,this.groups.forEach(t=>{t.preprocessing(this)}),"undefined"!=typeof control&&control(this);let e=this.groups.length,i=this.bones.map((t,i)=>{let a=this.groups[t],r={id:t,priority:-1,name:a.id};if(!a.defState)return r;let s=e-t+2*e,n=0;return this.bones.forEach(t=>{this.groups[t].parentID==a.uid&&(n+=1)}),"parentID"in a?s+=0==n?2*e:e:0==n&&(s+=3*e),r.priority=s,r});i.forEach(t=>{let a=this.groups[t.id];if(!("posIK"in a&&a.posIK.enable))return;let r=t.priority=a.uid+e;for(;"parentID"in a;){if(i.find(t=>t.id==a.parentID).priority=--r,(a=this.groups[a.parentID]).fixed)break}}),i.sort((t,e)=>t.priority<0?1:e.priority<0?-1:t.priority>e.priority?1:t.priority<e.priority?-1:0),i.some(t=>{if(t.priority<0)return!0;this.groups[t.id].calc(this)}),this.actionList.forEach(e=>{if(e.id!=t.id&&(e.pastFrame=e.currentFrame,"smartBoneID"in e)){let t=-this.groups[e.smartBoneID].currentState.angle,i=e.endAngle-e.startAngle;i>=0?((t-=e.startAngle)<0&&(t+=2*Math.PI),e.currentFrame=t>i?e.smartFrames:1+(t/i*(e.smartFrames-1)^0)):((t-=e.endAngle)<0&&(t+=2*Math.PI),e.currentFrame=t>-i?e.smartFrames:e.smartFrames+(t/i*(e.smartFrames-1)^0))}}),this.rootGroups.forEach(t=>{this.groups[t].update(this,(new Sprite).setSprite(this))})}draw(){this.visible&&this.rootGroups&&(this.context?(this.rootGroups.forEach(t=>{this.groups[t].draw(this,this.context)}),void 0!==DebugPath&&DebugPath.isDebugDraw()&&this.rootGroups.forEach(t=>{this.groups[t].debugDraw(this,this.context)})):console.error("context is not found"))}}var BinaryLoader={bonePropList:{parentID:1,isPin:2,fixed:3,strength:4,maxAngle:5,minAngle:6},binDataPosRange:3e4,init:function(t){if(!t)return console.error("array buffer is not found"),null;let e=new DataView(t),i=0,a=()=>{let t=e.getUint8(i);return i+=1,t},r=()=>{let t=e.getUint16(i);return i+=2,t},s=()=>{let t=e.getFloat32(i);return i+=4,t},n=()=>{let t=e.getInt16(i)/BinaryLoader.binDataPosRange;return i+=2,t},o=()=>{let t=a(),e="";for(let i=0;i<t;++i)e+=String.fromCharCode(r());return e},h=()=>0==a()?"transparent":"rgb("+a()+", "+a()+", "+a()+")",l=(t,e)=>{let i=Array(t()),a=i.length;for(let t=0;t<a;){let a=r();if(0==a){if(0==(a=r())){console.error("data format error");break}t+=a;continue}let s=e();if(Array.isArray(s))for(let e=0;e<a;++e)i[t+e]=s.concat();else for(let e=0;e<a;++e)i[t+e]=s;t+=a}return i},c=t=>a()?l(a,()=>l(r,()=>t())):t(),u=()=>l(r,()=>l(r,n)),d=()=>{let t=r()-1;t<0&&(t=null);let e=a()?"evenodd":"nonzero",i=(()=>{let t=r(),e=[];for(let i=0;i<t;++i){let t=a();switch(t){case 0:e.push({type:"M",pos:[n(),n()]});break;case 1:e.push({type:"L",pos:[n(),n()]});break;case 2:e.push({type:"C",pos:[n(),n(),n(),n(),n(),n()]});break;case 3:e.push({type:"Z"});break;default:console.error("unknown type : "+t)}}return e})(),o=c(s),l=c(h),d=c(h),p=c(u);return new PathObj(t,i,p,e,l,o,d)},p=t=>{let e=o(),i=r()-1;i<0&&(i=null);let n,h=l(r,d),u=l(a,r);if(e.startsWith(PathCtr.defaultBoneName)){n=new BoneObj(t,e,h,l(a,r));let i=a();for(;i>0;){switch(i){case BinaryLoader.bonePropList.parentID:n.parentID=r();break;case BinaryLoader.bonePropList.isPin:n.isPin=!0;break;case BinaryLoader.bonePropList.fixed:n.fixed=!0;break;case BinaryLoader.bonePropList.strength:n.strength=s();break;case BinaryLoader.bonePropList.maxAngle:n.maxAngle=s()/180*Math.PI;break;case BinaryLoader.bonePropList.minAngle:n.minAngle=s()/180*Math.PI}i=a()}a()&&(n.flexiPoint={dataIndex:a(),bones:l(a,r)})}else n=new GroupObj(t,e,h,c(()=>l(a,r)),i);return u.length>0&&(n.flexi=u),n},f=PathCtr.initTarget=new PathContainer(o(),r(),r()),g=a();if(g>0)for(let t=0;t<g;++t){let t=f.addAction(o(),a(),r());a()&&(t.smartBoneID=r(),t.smartFrames=r(),t.startAngle=s()/180*Math.PI,t.endAngle=s()/180*Math.PI)}f.rootGroups=l(a,r);let P=r();for(let t=0;t<P;++t){PathWorker.debugPrint("count : "+t),PathWorker.debugPrint(t),PathWorker.debugPrint(i);let e=p(t);f.groups[t]=e,BoneObj.prototype.isPrototypeOf(e)&&f.bones.push(e.uid),PathWorker.debugPrint(e)}return f},load:function(t,e,i=null){if(!t)return void console.error("filePath not found");let a=new XMLHttpRequest;a.onreadystatechange=function(r){let s=r.target;if(4!=s.readyState)return;if(200!=s.status&&0!=s.status||!s.response)return console.error("failed to read file: "+t),void console.error(s.statusText);let n=a.response;BinaryLoader.init(n).index=e,PathWorker.loadPrint("loading completed"),i&&i()},a.open("GET",t,!0),a.responseType="arraybuffer",a.send()}},PathWorker={debugPrint:function(){},loadPrint:function(){},setDebugPrint:function(t){PathWorker.debugPrint=t?console.debug:function(){}},setLoadPrint:function(t){PathWorker.loadPrint=t?console.log:function(){}},loadState:"",instance:null,isWorker:!1,postMessage:function(t){PathWorker.isWorker?PathWorker.instance.postMessage(t):window.dispatchEvent(new CustomEvent("message",{bubbles:!0,detail:t}))},init:function(){PathWorker.instance.addEventListener("message",function(t){let e=t.data?t.data:t.detail;switch(e.cmd){case"init":return PathWorker.loadPrint("init"),PathCtr.defaultBoneName=e.defaultBoneName,PathCtr.init(e.canvas,e.subCanvas,e.viewWidth,e.viewHeight),!1;case"load-complete":return PathWorker.loadState="",PathCtr.loadComplete(),PathWorker.postMessage({cmd:"main-init-complete"}),!1;case"load-bin":return BinaryLoader.load(e.path,e.index,()=>{PathCtr.loadComplete(),PathWorker.postMessage({cmd:"main-init-complete"})}),!1;case"load-bone":return PathWorker.loadState="load bone",PathWorker.loadPrint(PathWorker.loadState),BoneLoader.load(e.filePathList,PathCtr.pathContainers[PathCtr.pathContainers.length-1]),!1;case"resize-canvas":return PathCtr.setSize(e.viewWidth,e.viewHeight),!1;case"change-action":return PathCtr.pathContainers[0].setAction(e.name,e.frame),!1;case"mouse-move":return InputInfo.setMousePos(e.x,e.y),!1;case"mouse-enter":return InputInfo.isValidPointer=!0,!1;case"mouse-leave":return InputInfo.isValidPointer=!1,!1;case"touch-move":return InputInfo.setTouch(e.touches),!1;case"keyup":return void 0!==DebugPath&&DebugPath.keyUp(PathCtr.pathContainers[0],e.code),!1;case"set-control":return importScripts(e.path),!1;case"output-path-container":return DebugPath.outputJSON(PathCtr.pathContainers[0]),!1;case"output-bin":return DebugPath.outputBin(PathCtr.pathContainers[0]),!1;case"create-path-container":return PathWorker.loadState="init path container",PathWorker.loadPrint(PathWorker.loadState),PathCtr.initTarget=new PathContainer(e.name,e.width,e.height),PathCtr.initTarget.index=e.index,!1;case"add-action":return PathWorker.loadState="load action: "+e.actionName+" - "+e.totalFrames,PathWorker.loadPrint(PathWorker.loadState),PathCtr.initTarget.addAction(e.actionName,e.frame,e.totalFrames),!1;case"add-root-group":return PathCtr.initTarget.rootGroups.push(e.id),!1;case"new-group":return PathWorker.loadState="new group: "+e.uid+" - "+e.name,PathWorker.loadPrint(PathWorker.loadState),PathCtr.initTarget.groups[e.uid]=new GroupObj(e.uid,e.name,[],[],e.maskID),!1;case"new-bone":return PathWorker.loadState="new bone: "+e.uid+" - "+e.name,PathWorker.loadPrint(PathWorker.loadState),PathCtr.initTarget.groups[e.uid]=new BoneObj(e.uid,e.name,[],[]),PathCtr.initTarget.bones.push(e.uid),!1;case"add-group-action":return PathWorker.loadState="add action: "+e.actionName+" - "+e.frame,PathWorker.loadPrint(PathWorker.loadState),PathCtr.initTarget.bones.includes(e.uid)||PathCtr.initTarget.groups[e.uid].addAction(e.childGroups,e.frame,PathCtr.initTarget.getAction(e.actionName).id),!1;case"set-child-group-id":return PathCtr.initTarget.bones.includes(e.uid)?PathCtr.initTarget.groups[e.uid].childGroups=e.childGroups:PathCtr.initTarget.groups[e.uid].childGroups.setData(e.childGroups),!1;case"new-path":return PathCtr.initTarget.groups[e.uid].paths.push(new PathObj(e.maskID,e.pathDataList,e.pathDiffList,e.fillRule,e.fillStyle,e.lineWidth,e.strokeStyle)),!1;case"new-bone-path":if(PathCtr.initTarget.groups[e.uid].paths.push(new PathObj(null,e.pathDataList,e.pathDiffList,"nonzero","transparent",2,"rgb(0, 255, 0)")),1==PathCtr.initTarget.groups[e.uid].paths.length){let t=PathCtr.initTarget.groups[e.uid];BoneObj.setPath(t,t.paths[0])}return!1;case"add-path-action":return PathCtr.initTarget.groups[e.uid].paths[e.pathID].addAction(e.pathDataList,e.fillStyle,e.lineWidth,e.strokeStyle,e.frame,PathCtr.initTarget.getAction(e.actionName).id),!1;case"add-bone-path-action":return PathCtr.initTarget.groups[e.uid].paths[e.pathID].addAction(e.pathDataList,"transparent",2,"rgb(0, 255, 0)",e.frame,PathCtr.initTarget.getAction(e.actionName).id),!1;case"set-unvisible-path-action":return PathCtr.initTarget.groups[e.uid].paths.forEach(t=>{t.addAction(null,"transparent",0,"transparent",e.frame,PathCtr.initTarget.getAction(e.actionName).id)}),!1;default:return t.bubbles||console.error("unknown command: "+e.cmd),!0}},!1)}};PathWorker.isWorker="undefined"!=typeof DedicatedWorkerGlobalScope,PathWorker.isWorker?(PathWorker.instance=this,PathWorker.init()):(PathWorker.instance=window,PathWorker.init(),PathMain.initWorker());var BoneLoader={load:function(t,e){if(!Array.isArray(t))return console.error("filePathList is not array data."),void console.log(t);let i=0,a=new XMLHttpRequest,r=a.onreadystatechange=function(s){let n=s.target;if(4!=n.readyState)return;if(200!=n.status&&0!=n.status||""==n.responseText)return console.error("failed to read file: "+t[i]),void console.error(n.statusText);let o=JSON.parse(n.responseText);if("bones"in o&&"object"==typeof o.bones&&Object.keys(o.bones).forEach(t=>{let i=e.getBone(t);i?((t,i)=>{if(!t||!i)return;PathWorker.loadPrint("BONE: "+t.id);let a=e.getBone(i.parent);if("parent"in i&&a&&(t.parentID=a.uid,PathWorker.loadPrint("  parentID: "+t.parentID+"("+i.parent+")")),"isPin"in i&&"boolean"==typeof i.isPin&&(t.isPin=i.isPin,PathWorker.loadPrint("  isPin: "+t.isPin)),"fixed"in i&&"boolean"==typeof i.fixed&&(t.fixed=i.fixed,PathWorker.loadPrint("  fixed: "+t.fixed)),"strength"in i&&Number.isFinite(i.strength)&&(t.strength=i.strength,PathWorker.loadPrint("  strength: "+t.strength)),"maxAngle"in i&&Number.isFinite(i.maxAngle)&&(t.maxAngle=i.maxAngle/180*Math.PI,PathWorker.loadPrint("  maxAngle: "+t.maxAngle)),"minAngle"in i&&Number.isFinite(i.minAngle)&&(t.minAngle=i.minAngle/180*Math.PI,PathWorker.loadPrint("  minAngle: "+t.minAngle)),"flexiPoint"in i&&"object"==typeof i.flexiPoint){let a=i.flexiPoint.dataIndex,r=i.flexiPoint.bones;if(!Number.isFinite(a)||!Array.isArray(r))return;if(a>=2)return;PathWorker.loadPrint("  flexiPoint:"),PathWorker.loadPrint("    dataIndex: "+a);let s=[];r.forEach(t=>{let i=e.getBone(t);i&&(s.push(i.uid),PathWorker.loadPrint("    bone: "+t))}),t.flexiPoint={dataIndex:a,bones:s}}})(i,o.bones[t]):console.error("bone is not found : "+t)}),"flexi"in o&&"object"==typeof o.flexi&&Object.keys(o.flexi).forEach(t=>{let i=e.getGroup(t);if(!i)return void console.error("group is not found : "+t);let a=o.flexi[t];a&&Array.isArray(a)&&0!=a.length&&(PathWorker.loadPrint("FLEXI GROUP: "+i.id),i.flexi=[],PathWorker.loadPrint("  flexi:"),a.forEach(t=>{let a=e.getBone(t);a&&(i.flexi.push(a.uid),PathWorker.loadPrint("    "+t))}))}),"action"in o&&"object"==typeof o.action&&Object.keys(o.action).forEach(t=>{let i=e.actionList.find(e=>e.name==t);if(!i)return void console.error("smart action is not found : "+t);let a=o.action[t],r=e.getBone(a.boneName);r?(i.smartBoneID=r.uid,i.startAngle=a.startAngle/180*Math.PI,i.endAngle=a.endAngle/180*Math.PI,i.smartFrames=a.smartFrames,PathWorker.loadPrint("  smartAction: "+i.name),PathWorker.loadPrint("    boneName: "+r.id),PathWorker.loadPrint("    startAngle: "+i.startAngle),PathWorker.loadPrint("    endAngle: "+i.endAngle),PathWorker.loadPrint("    smartFrames: "+i.smartFrames)):console.error("bone is not found : "+id)}),i<t.length)return a.open("GET",t[i++],!0),a.onreadystatechange=r,void a.send();let h=(t,i,a,r)=>{if(r.includes(t))return;r.push(t);let s=e.groups[t];if(!s.defState)return;let n=s.paths[0].pathDiffList;if(!n.hasActionID(i))return;let o=n.data[i][a];if(void 0===o)return;let l=s.paths[0].getPathDataList(a,i),c=s.parentID;if(void 0!==c){let t=e.groups[c];h(c,i,a,r);let n=t.x-t.defState.x1,u=t.y-t.defState.y1,d=[l[0].pos[0]-n,l[0].pos[1]-u,l[1].pos[0]-n,l[1].pos[1]-u];t.effectSprite.x=t.effectSprite.anchorX=d[0],t.effectSprite.y=t.effectSprite.anchorY=d[1],t.effectSprite.getMatrix().applyToArray(d),o[0][0]=d[0]-s.defState.x0,o[0][1]=d[1]-s.defState.y0,o[1][0]=d[2]-s.defState.x1,o[1][1]=d[3]-s.defState.y1}};e.actionList.forEach(t=>{let i=t.id;for(let a=1;a<t.totalFrames;++a){e.bones.forEach(t=>{let r=e.groups[t];if(!r.defState)return;let s=r.paths[0].pathDiffList;if(s.hasActionID(i)){if(void 0===s.data[i][a])return}else if(1!=a)return;let n=r.paths[0].getPathDataList(a,i),o=r.anchorX=n[0].pos[0],h=r.anchorY=n[0].pos[1],l=r.x=n[1].pos[0],c=r.y=n[1].pos[1],u=Math.atan2(c-h,l-o);isNaN(u)&&(u=r.defState.angle),r.effectSprite.rotation=r.defState.angle-u});let t=[];e.bones.forEach(e=>h(e,i,a,t))}}),e.bones.forEach(t=>{let i=e.groups[t];if(i.reset(),!i.defState)return;let a=i.paths[0].getPathDataList(0,0);i.effectSprite.reset(),i.defState=BoneObj.getDistAndAngle(i.id+":load",a[0].pos[0],a[0].pos[1],a[1].pos[0],a[1].pos[1])}),PathWorker.loadPrint("bones JSON load complete."),PathWorker.loadPrint(e),PathWorker.postMessage({cmd:"main-bone-load-complete"})};a.open("GET",t[i++],!0),a.send()}},DebugPath={isStop:!1,isStep:!1,isShowBones:!1,bonePointSize:2,boneLineSize:2,boneColor:"rgb(0, 255, 0)",strengthPointColor:"rgba(0, 255, 0, 0.005)",strengthLineColor:"rgba(0, 255, 0, 0.2)",isShowPoints:!1,pointSize:2,pointColor:"rgb(255, 0, 0)",isShowControls:!1,controlSize:1,controlColor:"rgb(255, 255, 0)",actionIndex:0,init:function(t){},keyUp:function(t,e){let i=e=>{console.log(e),t.setAction(e)};switch(e){case"Space":this.isStop=!this.isStop,console.log(this.isStop?"--STOP--":"--START--");break;case"ArrowRight":this.isStep=!0;break;case"ArrowDown":this.actionIndex=(this.actionIndex+1)%t.actionList.length,i(t.actionList[this.actionIndex].name);break;case"ArrowUp":--this.actionIndex<0&&(this.actionIndex=t.actionList.length-1),i(t.actionList[this.actionIndex].name);break;case"KeyD":PathWorker.setDebugPrint(PathWorker.debugPrint!=console.debug);break;case"KeyL":PathWorker.setLoadPrint(PathWorker.loadPrint!=console.log);break;case"KeyB":this.isShowBones=!this.isShowBones;break;case"KeyC":this.isShowControls=!this.isShowControls;break;case"KeyP":this.isShowPoints=!this.isShowPoints;break;case"KeyO":postMessage({cmd:"main-confirm",callback:"output-path-container",message:"現在の状態をJSONに出力します"})}},isDebugDraw:function(){return this.isShowBones||this.isShowPoints||this.isShowControls},outputJSON:function(t){postMessage({cmd:"main-download",type:"application/json",fileName:"pathContainer.json",data:JSON.stringify(t,(t,e)=>{if(!t.includes("result")&&!t.includes("current")&&!t.includes("past")&&"m"!=t)return e},2)})},toBin:function(t){if(!t)return console.error("path container is not found"),null;let e=new ArrayBuffer(1e9),i=new DataView(e),a=0,r=t=>{i.setUint8(a,t),a+=1},s=t=>{i.setUint16(a,t),a+=2},n=t=>{i.setFloat32(a,t),a+=4},o=t=>{i.setInt16(a,t*BinaryLoader.binDataPosRange),a+=2},h=t=>{r(t.length),[].map.call(t,t=>s(t.charCodeAt(0)))},l=t=>{if("transparent"==t)r(0);else{let e=t.match(/(\\d+), (\\d+), (\\d+)/);r(1),r(e[1]),r(e[2]),r(e[3])}},c=(t,e,i)=>{if(!Array.isArray(t))return void e(0);let a=t.length;e(a);for(let e=0;e<a;){let r=t[e],n=1;if(void 0!==r){for(;n<a&&(void 0!==t[e+n]&&JSON.stringify(r)==JSON.stringify(t[e+n]));++n);s(n),e+=n,i(r)}else{for(s(0);n<a&&void 0===t[e+n];++n);s(n),e+=n}}},u=(t,e)=>{t.hasAction?(r(1),c(t.data,r,t=>{c(t,s,e)})):(r(0),e(t.data))},d=t=>{c(t,s,t=>{c(t,s,o)})},p=t=>{s(null==t.maskIdToUse?0:t.maskIdToUse+1),r("nonzero"==t.fillRule?0:1),(t=>{s(t.length),t.forEach(t=>{switch(t.type){case"M":r(0),o(t.pos[0]),o(t.pos[1]);break;case"L":r(1),o(t.pos[0]),o(t.pos[1]);break;case"C":r(2);for(let e=0;e<6;++e)o(t.pos[e]);break;case"Z":r(3);break;default:console.error("unknown type")}})})(t.defPathList),u(t.lineWidth,n),u(t.fillStyle,l),u(t.strokeStyle,l),u(t.pathDiffList,d)};h(t.name),s(t.originalWidth),s(t.originalHeight),r(t.actionList.length),t.actionList.forEach(t=>{h(t.name),r(t.id),s(t.totalFrames),"smartBoneID"in t?(r(1),s(t.smartBoneID),s(t.smartFrames),n(t.startAngle/Math.PI*180),n(t.endAngle/Math.PI*180)):r(0)}),c(t.rootGroups,r,s);let f=t.groups.length;return s(f),t.groups.forEach(t=>{PathWorker.loadPrint("count : "+f--),(t=>{h(t.id),s(null==t.maskIdToUse?0:t.maskIdToUse+1),c(t.paths,s,p),c(t.flexi,r,s),BoneObj.prototype.isPrototypeOf(t)?(c(t.childGroups,r,s),Object.keys(BinaryLoader.bonePropList).map(e=>{if(e in t)switch(r(BinaryLoader.bonePropList[e]),e){case"parentID":s(t.parentID);break;case"isPin":case"fixed":break;case"strength":n(t.strength);break;case"maxAngle":n(t.maxAngle/Math.PI*180);break;case"minAngle":n(t.minAngle/Math.PI*180)}}),r(0),t.flexiPoint?(r(1),r(t.flexiPoint.dataIndex),c(t.flexiPoint.bones,r,s)):r(0)):u(t.childGroups,t=>{c(t,r,s)})})(t)}),i=null,e.slice(0,a)},outputBin:function(t){if(!t)return;let e=this.toBin(t);postMessage({cmd:"main-download",type:"octet/stream",fileName:"path_data.bin",data:e},[e])}};',path_load_svg_worker='\nlet fileInfoList=null,fileIndex=0,getFrameNum=e=>"00000".substr(0,5-e.toString().length)+e+".svg";addEventListener("message",function(e){let t=()=>{let e=fileInfoList[fileIndex++],t=e[0],n=e[1],s=e[2],a=e[3],o=1,d=new XMLHttpRequest,l=d.onreadystatechange=function(e){let r=e.target;if(4==r.readyState){if(200!=r.status&&0!=r.status||""==r.responseText)return console.error("failed to read file: "+i),void console.error(r.statusText);if(postMessage({cmd:"new-svg",actionName:s,frame:o,svg:r.responseText}),delete d,o<=n)return i=a+getFrameNum(o++),(d=new XMLHttpRequest).open("GET",i,!0),d.onreadystatechange=l,void d.send();fileIndex<fileInfoList.length?postMessage({cmd:"load-add",kind:t,actionName:s,totalFrames:n}):(postMessage({cmd:"load-complete",kind:t,actionName:s,totalFrames:n}),close())}},i=a+getFrameNum(o++);d.open("GET",i,!0),d.send()},n=e.data;switch(n.cmd){case"load":fileIndex=0,fileInfoList=n.fileInfoList,t();break;case"load-next":t();break;default:console.error("unknown command: "+n.cmd)}},!1);';var PathMain={debugPrint:function(){},loadPrint:function(){},setDebugPrint:function(t){PathMain.debugPrint=t?console.debug:function(){}},setLoadPrint:function(t){PathMain.loadPrint=t?console.log:function(){}},defaultBoneName:"bone",isUseMin:!1,worker:null,useWorker:!1,canvas:null,subCanvas:null,completeInitFunc:null,completeLoadFunc:null,postMessage:function(t,e){PathMain.useWorker?PathMain.worker.postMessage(t,e):window.dispatchEvent(new CustomEvent("message",{bubbles:!0,detail:t}))},initWorker:function(){let t=PathMain.canvas,e=PathMain.subCanvas,a=document.documentElement.clientWidth,i=document.documentElement.clientHeight;t.width=e.width=a,t.height=e.height=i,t.setAttribute("style","position:fixed;z-index:-1;left:0;top:0;width:"+a+"px;height:"+i+"px;"),PathMain.worker.addEventListener("message",function(t){let e=t.data?t.data:t.detail;switch(e.cmd){case"main-init-complete":return PathMain.completeLoadFunc&&(PathMain.completeLoadFunc(),PathMain.completeLoadFunc=null),!1;case"main-bone-load-complete":return PathMain.completeBoneLoadFunc&&(PathMain.completeBoneLoadFunc(),PathMain.completeBoneLoadFunc=null),!1;case"main-confirm":return confirm(e.message)&&PathMain.postMessage({cmd:e.callback}),!1;case"main-download":return PathMain.downloadData(e.type,e.fileName,e.data),!1;default:return t.bubbles||console.error("unknown command: "+e.cmd),!0}},!1),window.addEventListener("resize",function(){let t=document.documentElement.clientWidth,e=document.documentElement.clientHeight;PathMain.canvas.setAttribute("style","position:fixed;z-index:-1;left:0;top:0;width:"+PathMain.viewWidth+"px;height:"+PathMain.viewHeight+"px;"),PathMain.postMessage({cmd:"resize-canvas",viewWidth:t,viewHeight:e})}),document.addEventListener("mousemove",function(t){PathMain.postMessage({cmd:"mouse-move",x:t.clientX,y:t.clientY}),t.preventDefault()},{passive:!1}),document.addEventListener("mouseenter",function(t){PathMain.postMessage({cmd:"mouse-enter"}),t.preventDefault()},{passive:!1}),document.addEventListener("mouseleave",function(t){PathMain.postMessage({cmd:"mouse-leave"}),t.preventDefault()},{passive:!1}),document.addEventListener("touchmove",function(t){let e=[];for(let a=0;a<t.touches.length;++a){let i=t.touches[a];e.push({identifier:i.identifier,pageX:i.pageX,pageY:i.pageY})}PathMain.postMessage({cmd:"touch-move",touches:e}),t.preventDefault()},{passive:!1}),document.addEventListener("keyup",function(t){PathMain.postMessage({cmd:"keyup",code:t.code})});let r=PathMain.canvas,n=PathMain.subCanvas;PathMain.useWorker&&(r=r.transferControlToOffscreen(),n=n.transferControlToOffscreen()),PathMain.postMessage({cmd:"init",viewWidth:a,viewHeight:i,canvas:r,subCanvas:n,defaultBoneName:PathMain.defaultBoneName},[r,n]),PathMain.completeInitFunc&&(PathMain.completeInitFunc(),PathMain.completeInitFunc=null)},downloadData:function(t,e,a){let i=document.createElement("a");document.body.appendChild(i),i.style="display: none";let r=new Blob([a],{type:t});i.href=window.URL.createObjectURL(r),i.download=e,i.click(),i.remove()},outputBin:function(){PathMain.postMessage({cmd:"output-bin"})},loadBone:function(t,e){if(!Array.isArray(t))return console.error("filePathList is not array data."),void console.log(t);PathMain.completeBoneLoadFunc=e;let a=t.map(t=>new URL(t,window.location.href).href);PathMain.postMessage({cmd:"load-bone",filePathList:a})},init:function(t=null,e=null){let a=document.getElementById("path-container");if(!a)return void console.error("CanvasContainer is not found.");let i=PathMain.canvas=document.createElement("canvas");i.className="main-canvas",a.appendChild(i);let r=PathMain.subCanvas=document.createElement("canvas");r.className="sub-canvas",r.setAttribute("style","display:none;"),a.appendChild(r),PathMain.completeInitFunc=e,PathMain.useWorker=!!Worker&&!!i.transferControlToOffscreen;let n=new Blob([path_control],{type:"text/javascript"}),s=window.URL.createObjectURL(n);if(PathMain.useWorker)PathMain.worker=new Worker(s),t&&PathMain.postMessage({cmd:"set-control",path:new URL(t,window.location.href).href}),PathMain.initWorker();else{if(console.warn("this browser is not supported"),PathMain.worker=window,t){let e=document.createElement("script");e.src=t,document.body.appendChild(e)}let e=document.createElement("script");e.src=s,document.body.appendChild(e)}},load:function(t,e,a=null){PathMain.completeLoadFunc=a,PathMain.postMessage({cmd:"load-bin",index:e,path:new URL(t,window.location.href).href})}},SVGLoader={FILE_KIND_BASE:"BASE",FILE_KIND_BONE:"BONE",FILE_KIND_SMRT:"SMRT",initKind:"",width:0,height:0,groupNameToIDList:null,masksList:null,domList:[],loadWorker:null,getMaskId:function(t){if(!t)return null;let e=t.replace(/^url\(#/,"").replace(/\)$/,"");return this.masksList[e]?this.masksList[e]:(console.error("unknown mask name: "+t),null)},makePathDataList:function(t){let e,a=[];e=t.indexOf(",")<0?t.split(/ /):t.replace(/([MCZ])/g,",$1,").replace(/[^,]-/g,",-").split(/[, ]/);let i=this.width,r=this.height,n=i>r?i:r,s=()=>parseFloat(e.shift())/n,o=()=>parseFloat(e.shift())/n;for(;e.length>0;){let t=e.shift();switch(t){case"M":a.push({type:"M",pos:[s(),o()]});break;case"C":a.push({type:"C",pos:[s(),o(),s(),o(),s(),o()]});break;case"Z":a.push({type:"Z"});break;case"":break;default:console.error("unknown type : "+t),console.log(t)}}return a},makePath:function(t,e,a){let i=a.fill;"none"==i&&(i="transparent");let r=0,n=a.stroke;"none"==n?n="transparent":r=parseFloat(a.strokeWidth.match(/([\d\.]+)/)[1]);let s=this.makePathDataList(e.getAttribute("d")),o=[];s.forEach(t=>o.push(t.pos?t.pos.concat().fill(0):void 0)),PathMain.postMessage({cmd:"new-path",uid:t,maskID:this.getMaskId(e.getAttribute("mask")),pathDataList:s,pathDiffList:o,fillRule:a.fillRule,fillStyle:i,lineWidth:r,strokeStyle:n})},addActionPath:function(t,e,a,i,r,n){let s=a?i.fill:"none";"none"==s&&(s="transparent");let o=0,h=a?i.stroke:"none";"none"==h?h="transparent":o=parseFloat(i.strokeWidth.match(/([\d\.]+)/)[1]);let l=null;a&&(l=this.makePathDataList(a.getAttribute("d"))),PathMain.postMessage({cmd:"add-path-action",uid:t,pathID:e,pathDataList:l,fillStyle:s,lineWidth:o,strokeStyle:h,frame:r,actionName:n}),l=null},makeBonePathDataList:function(t){let e,a=[];e=t.indexOf(",")<0?t.split(/ /):t.replace(/([MCZ])/g,",$1,").replace(/[^,]-/g,",-").split(/[, ]/);let i=this.width,r=this.height,n=i>r?i:r,s=()=>parseFloat(e.shift())/n,o=()=>parseFloat(e.shift())/n,h=[];for(;e.length>0&&h.length<2;){let t=e.shift();switch(t){case"M":h.push([s(),o()]);break;case"C":e.shift(),e.shift(),e.shift(),e.shift(),h.push([s(),o()]);break;case"":break;default:console.error("unknown type : "+t),console.log(t)}}return a.push({type:"M",pos:[h[0][0],h[0][1]]}),a.push({type:"L",pos:[h[1][0],h[1][1]]}),a},makeBonePath:function(t,e){let a=this.makeBonePathDataList(e.getAttribute("d")),i=[];a.forEach(t=>i.push(t.pos?t.pos.slice().fill(0):void 0)),PathMain.postMessage({cmd:"new-bone-path",uid:t,pathDataList:a,pathDiffList:i}),a=null,i=null},addBoneActionPath:function(t,e,a,i,r){let n=null;a&&(n=this.makeBonePathDataList(a.getAttribute("d"))),PathMain.postMessage({cmd:"add-bone-path-action",uid:t,pathID:e,pathDataList:n,frame:i,actionName:r}),n=null},makeGroup:function(t){let e=t.getAttribute("id"),a=this.groupNameToIDList[e],i=e.startsWith(PathMain.defaultBoneName),r=!i&&this.initKind===this.FILE_KIND_BONE;i?PathMain.postMessage({cmd:"new-bone",uid:a,name:e}):PathMain.postMessage({cmd:"new-group",uid:a,name:e,maskID:this.getMaskId(t.getAttribute("mask"))});let n=[];return Array.prototype.slice.call(t.children).forEach(t=>{switch(t.tagName){case"path":if(r)break;i?this.makeBonePath(a,t):this.makePath(a,t,window.getComputedStyle(t));break;case"mask":Array.prototype.slice.call(t.children).forEach(t=>{"g"==t.tagName&&this.makeGroup(t)});break;case"g":n.push(this.groupNameToIDList[t.getAttribute("id")]),this.makeGroup(t);break;default:console.error("unknown element"),console.log(t)}}),n.length>0&&PathMain.postMessage({cmd:"set-child-group-id",uid:a,childGroups:n}),n=null,a},addActionGroup:function(t,e,a,i,r){i%10==0&&0==t&&PathMain.loadPrint("add action DOM: "+r+" - "+i);let n=SVGLoader.groupNameToIDList[a],s=[],o=0,h=a.startsWith(PathMain.defaultBoneName),l=!h&&SVGLoader.initKind===SVGLoader.FILE_KIND_BONE;e?Array.prototype.slice.call(e.children).forEach(t=>{switch(t.tagName){case"path":if(l)break;h?SVGLoader.addBoneActionPath(n,o++,t,i,r):SVGLoader.addActionPath(n,o++,t,window.getComputedStyle(t),i,r);break;case"mask":break;case"g":s.push(SVGLoader.groupNameToIDList[t.getAttribute("id")]);break;default:console.error("unknown element"),console.log(t)}}):PathMain.postMessage({cmd:"set-unvisible-path-action",uid:n,frame:i,actionName:r}),PathMain.postMessage({cmd:"add-group-action",uid:n,childGroups:s,frame:i,actionName:r}),s=null},addActionFromList:function(t){if(!this.domList)return void console.error("groups dom list is not found");PathMain.loadPrint("check id");let e=Array.prototype.slice.call(this.domList),a=e[0];e.forEach(t=>{let e=t.getElementsByTagName("g"),a=[].map.call(e,t=>t.getAttribute("id"));Array.prototype.forEach.call(a,e=>{null==this.groupNameToIDList[e]&&(this.groupNameToIDList[e]=Object.keys(this.groupNameToIDList).length,this.makeGroup(t.getElementById(e)))}),Array.prototype.slice.call(t.getElementsByTagName("mask")).forEach(t=>{let e=t.getAttribute("id");if(this.masksList[e])return;let a=Array.prototype.slice.call(t.children);a.forEach(t=>{"use"==t.tagName?this.masksList[e]=this.groupNameToIDList[t.getAttribute("xlink:href").slice(1)]:"g"==t.tagName?this.masksList[e]=this.groupNameToIDList[t.getAttribute("id")]:(console.error("unknown mask data"),console.log(t))}),a=null}),e=null,a=null}),PathMain.loadPrint("check diff");let i=[];Object.keys(this.groupNameToIDList).forEach(t=>{let r=a.getElementById(t);e.some(e=>{if(!e||!r||!r.isEqualNode(e.getElementById(t)))return i.push(t),!0}),r=null}),e.forEach((e,a)=>{0!=a&&(a%10==0&&PathMain.loadPrint("add action : "+t+" - "+a),i.forEach((i,r)=>{setTimeout(this.addActionGroup,0,r,e.getElementById(i),i,a,t)}))}),setTimeout(this.loadDOMEnd),e=null,a=null,i=null},initPathContainer:function(t){if(!t)return console.error("groups dom is not found"),null;this.width=parseInt(t.getAttribute("width").replace("px","")),this.height=parseInt(t.getAttribute("height").replace("px","")),PathMain.postMessage({cmd:"create-path-container",name:this.name,index:this.index,width:this.width,height:this.height}),Array.prototype.slice.call(t.getElementsByTagName("g")).forEach(t=>{let e=t.getAttribute("id");null==this.groupNameToIDList[e]?this.groupNameToIDList[e]=Object.keys(this.groupNameToIDList).length:console.error("group ID is duplicated : "+e)}),Array.prototype.slice.call(t.getElementsByTagName("mask")).forEach(t=>{Array.prototype.slice.call(t.children).forEach(e=>{"use"==e.tagName?this.masksList[t.getAttribute("id")]=this.groupNameToIDList[e.getAttribute("xlink:href").slice(1)]:"g"==e.tagName?this.masksList[t.getAttribute("id")]=this.groupNameToIDList[e.getAttribute("id")]:(console.error("unknown mask data"),console.log(e))})}),Array.prototype.slice.call(t.children).forEach(t=>{"g"==t.tagName&&PathMain.postMessage({cmd:"add-root-group",id:this.makeGroup(t)})})},loadFromDOM:function(t,e,a){this.initKind=t,t==this.FILE_KIND_BASE&&this.initPathContainer(this.domList[0]),PathMain.postMessage({cmd:"add-action",actionName:e,frame:-1,totalFrames:a}),this.addActionFromList(e)},amendMohoSVG:function(t){Array.prototype.slice.call(t.getElementsByTagName("clipPath")).forEach(t=>{let e="cmn_"+t.getAttribute("id"),a=t.nextElementSibling;if("path"!=a.tagName)return;let i=!0,r=[];if(Array.prototype.slice.call(t.getElementsByTagName("path")).forEach(t=>{i||"path"==a.tagName||t.outerHTML==a.outerHTML?(r.push(a),a=a.nextElementSibling):i=!1}),i){let a=document.createElement("g");a.setAttribute("id",e),t.innerHTML='<use xlink:href="#'+e+'"/>',r.forEach(t=>{a.insertAdjacentElement("beforeend",t)}),t.insertAdjacentElement("afterend",a)}}),t.innerHTML=t.innerHTML.replace(/clip-path=/g,"mask=").replace(/<clipPath/g,'<mask style="mask-type:alpha;"').replace(/<\/clipPath>/g,"</mask>"),t.querySelectorAll('[id$="Mtarget"]').forEach(t=>t.setAttribute("mask","url(#mask_target)")),t.querySelectorAll('[id$="Mask"]').forEach(t=>{let e='<mask id="mask_target" style="mask-type:alpha;">\n';e+='<use xlink:href="#'+t.getAttribute("id")+'"/>',e+="</mask>\n",t.outerHTML+=e})},addSvgDOM:function(t){let e=document.createElement("div");e.setAttribute("style","display:none;"),e.innerHTML=t,this.amendMohoSVG(e);let a=e.firstElementChild;document.body.append(e),this.domList[parseInt(t.match(/id="Frame_(\d+)"/)[1])-1]=a,e=null,a=null},loadDOMEnd:function(){PathMain.loadPrint("DOM END"),SVGLoader.domList.forEach(t=>t.parentNode.remove()),SVGLoader.domList.length=0,SVGLoader.initKind="",SVGLoader.loadWorker.postMessage({cmd:"load-next"})},loadEnd:function(){PathMain.loadPrint("LOAD END"),SVGLoader.groupNameToIDList=null,SVGLoader.masksList=null,PathMain.postMessage({cmd:"load-complete"})},startWorker:function(t){if(!t||!Array.isArray(t)||!Array.isArray(t[0]))return console.error("fileInfoList format is woring"),void console.log(t);if(t[0][0]!=this.FILE_KIND_BASE)return void console.error('action kind "'+this.FILE_KIND_BASE+'" is missing in fileInfoList');t.forEach(t=>{t[3]=new URL(t[3],window.location.href).href});let e=new Blob([path_load_svg_worker],{type:"text/javascript"}),a=window.URL.createObjectURL(e);this.loadWorker=new Worker(a),this.loadWorker.addEventListener("message",function(t){let e=t.data;switch(e.cmd){case"load-complete":SVGLoader.loadFromDOM(e.kind,e.actionName,e.totalFrames),setTimeout(SVGLoader.loadEnd);break;case"load-add":SVGLoader.loadFromDOM(e.kind,e.actionName,e.totalFrames);break;case"new-svg":e.frame%10==0&&PathMain.loadPrint("load file: "+e.actionName+" - "+e.frame),SVGLoader.addSvgDOM(e.svg);break;default:console.error("unknown command: "+e.cmd)}}),this.loadWorker.postMessage({cmd:"load",fileInfoList:t})},load:function(t,e,a,i=null,r=null){this.name=t,this.index=e,this.groupNameToIDList={},this.masksList={},PathMain.completeLoadFunc=null==i?r:()=>{PathMain.loadBone(i,r)};let n=new XMLHttpRequest;n.onreadystatechange=function(t){let e=t.target;if(4!=e.readyState)return;if(200!=e.status&&0!=e.status||""==e.responseText)return console.error("failed to read file: "+a),void console.error(e.statusText);let i=e.responseText.split("\n").map(t=>{let e=t.split(", ");return 4==e.length&&(e[1]=Number(e[1]),e)}).filter(t=>t);SVGLoader.startWorker(i)},n.open("GET",a,!0),n.send()}};