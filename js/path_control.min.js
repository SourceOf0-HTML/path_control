var PathCtr={isDebug:!1,debugPrint:function(){if(this.isDebug)for(let t=0;t<arguments.length;++t)console.log(arguments[t])},defaultCanvasContainerID:"path-container",defaultActionName:"base",defaultBoneName:"bone",initTarget:null,currentFrame:0,currentActionID:-1,binDataPosRange:2e4,pathContainer:null,context:null,subContext:null,viewWidth:0,viewHeight:0,requestAnimationIDs:[],setTimeoutIDs:[],cancelFunctions:function(){(this.requestAnimationIDs.length>1||this.setTimeoutIDs.length>1)&&console.log("requestAnimationIDs:"+this.requestAnimationIDs.length+", "+setTimeoutIDs.length),this.requestAnimationIDs.forEach(window.cancelAnimationFrame),this.requestAnimationIDs.length=0,this.setTimeoutIDs.forEach(window.clearTimeout),this.setTimeoutIDs.length=0},init:function(){let t=document.getElementById(this.defaultCanvasContainerID);if(!t)return void console.error("CanvasContainer is not found.");let i=document.createElement("canvas");i.className="main-canvas",t.appendChild(i);let e=document.createElement("canvas");if(e.className="sub-canvas",e.style.cssText="display:none;",t.appendChild(e),this.context=i.getContext("2d"),this.subContext=e.getContext("2d"),!this.context||!this.subContext)return void console.error("context is not found.");window.requestAnimationFrame||window.mozRequestAnimationFrame||window.webkitRequestAnimationFrame||window.msRequestAnimationFrame,window.cancelAnimationFrame||window.mozCancelAnimationFrame;this.viewWidth=document.documentElement.clientWidth,this.viewHeight=document.documentElement.clientHeight,i.setAttribute("style","position:fixed;z-index:-1;left:0;top:0;width:"+this.viewWidth+"px;height:"+this.viewHeight+"px;"),i.width=e.width=this.viewWidth,i.height=e.height=this.viewHeight,window.addEventListener("resize",()=>{this.viewWidth=document.documentElement.clientWidth,this.viewHeight=document.documentElement.clientHeight,i.setAttribute("style","position:fixed;z-index:-1;left:0;top:0;width:"+this.viewWidth+"px;height:"+this.viewHeight+"px;"),this.pathContainer&&this.pathContainer.setSize(this.viewWidth,this.viewHeight)});let s=1/24,h=0,r=0,n=0,a=t=>{if(!i.parentNode)return void this.cancelFunctions();if(void 0===t)return;if(n=(n+(t-r)/1e3)/2,r=t,!this.pathContainer)return;i.width=e.width=this.viewWidth,i.height=e.height=this.viewHeight,this.subContext.clearRect(0,0,this.viewWidth,this.viewHeight),this.pathContainer.draw(h),h=(h+1)%260,this.context.clearRect(0,0,this.viewWidth,this.viewHeight);let a=this.subContext.getImageData(0,0,this.viewWidth,this.viewHeight);this.context.putImageData(a,0,0),a=null,n>1/24*2?(s*=.99,this.debugPrint("up")):n<1/24*.5?(s*=1.01,this.debugPrint("down")):s=(1/24+s)/2},o=()=>{this.cancelFunctions(),this.requestAnimationIDs.push(window.requestAnimationFrame(a)),this.setTimeoutIDs.push(window.setTimeout(o,1e3*s))};this.setTimeoutIDs.push(window.setTimeout(o,1e3*s))}};class Matrix{constructor(){this.a=1,this.b=0,this.c=0,this.d=1,this.e=0,this.f=0}reset(){return this.a=this.d=1,this.b=this.c=this.e=this.f=0,this}applyToPoint(t,i,e=1,s=e){return{x:(t*this.a+i*this.c+this.e)*e,y:(t*this.b+i*this.d+this.f)*s}}applyToArray(t,i=1,e=i){let s=[],h=t.length;for(let r=0;r<h;){let h=this.applyToPoint(t[r++],t[r++]);s.push(h.x*i,h.y*e)}return s}setMatrix(t){return this.a=t.a,this.b=t.b,this.c=t.c,this.d=t.d,this.e=t.e,this.f=t.f,this}interpolate(t,i){let e=new Matrix;return e.a=this.a+(t.a-this.a)*i,e.b=this.b+(t.b-this.b)*i,e.c=this.c+(t.c-this.c)*i,e.d=this.d+(t.d-this.d)*i,e.e=this.e+(t.e-this.e)*i,e.f=this.f+(t.f-this.f)*i,e}setTransform(t,i,e,s,h,r){return this.a=t,this.b=i,this.c=e,this.d=s,this.e=h,this.f=r,this}transform(t,i,e,s,h,r){let n=this.a,a=this.b,o=this.c,l=this.d,c=this.e,u=this.f;return this.a=n*t+o*i,this.b=a*t+l*i,this.c=n*e+o*s,this.d=a*e+l*s,this.e=n*h+o*r+c,this.f=a*h+l*r+u,this}rotate(t){let i=Math.cos(t),e=Math.sin(t);return this.transform(i,e,-e,i,0,0)}scale(t,i=t){return this.transform(t,0,0,i,0,0)}scaleX(t){return this.transform(t,0,0,1,0,0)}scaleY(t){return this.transform(1,0,0,t,0,0)}skew(t,i){return this.transform(1,i,t,1,0,0)}skewX(t){return this.transform(1,0,t,1,0,0)}skewY(t){return this.transform(1,t,0,1,0,0)}translate(t,i){return this.transform(1,0,0,1,t,i)}translateX(t){return this.transform(1,0,0,1,t,0)}translateY(t){return this.transform(1,0,0,1,0,t)}}class Sprite{constructor(){this.m=new Matrix,this.x=0,this.y=0,this.anchorX=0,this.anchorY=0,this.scaleX=1,this.scaleY=1,this.rotation=0}setSprite(t){return this.x=t.x,this.y=t.y,this.anchorX=t.anchorX,this.anchorY=t.anchorY,this.scaleX=t.scaleX,this.scaleY=t.scaleY,this.rotation=t.rotation,this}compSprite(t){let i=new Sprite;return i.x=this.x+t.x,i.y=this.y+t.y,i.anchorX=this.anchorX+t.anchorX,i.anchorY=this.anchorY+t.anchorY,i.scaleX=this.scaleX*t.scaleX,i.scaleY=this.scaleY*t.scaleY,i.rotation=this.rotation+t.rotation,i}get matrix(){let t=this.scaleX,i=this.scaleY,e=this.rotation;return this.m.reset().translate(this.x,this.y).rotate(e).scale(t,i).translate(-this.anchorX,-this.anchorY)}}class PathObj{constructor(t,i,e,s,h,r){this.maskIdToUse=i,this.pathDataList=t,this.fillRule=e,this.fillStyle=s,this.lineWidth=h,this.strokeStyle=r,this.hasActionList=[]}addAction(t,i,e,s,h,r,n){0==this.hasActionList.length&&(this.pathDataList=[[this.pathDataList]],this.fillStyle=[[this.fillStyle]],this.lineWidth=[[this.lineWidth]],this.strokeStyle=[[this.strokeStyle]]),this.hasActionList[n]||(this.pathDataList[n]=[this.pathDataList[0][0]],this.fillStyle[n]=[this.fillStyle[0][0]],this.lineWidth[n]=[this.lineWidth[0][0]],this.strokeStyle[n]=[this.strokeStyle[0][0]],this.hasActionList[n]=!0),this.pathDataList[n][r]=t,this.fillStyle[n][r]=e,this.lineWidth[n][r]=s,this.strokeStyle[n][r]=h}drawPath(t,i,e,s){let h;switch(s.type){case"M":h=i.applyToArray(s.pos,t.pathRatio),e.moveTo(h[0],h[1]);break;case"C":h=i.applyToArray(s.pos,t.pathRatio),e.bezierCurveTo(h[0],h[1],h[2],h[3],h[4],h[5]);break;case"Z":e.closePath();break;default:console.error("unknown type")}}drawStroke(t,i,e,s){e&&(t.lineJoin="round",t.lineCap="round",t.lineWidth=e,t.strokeStyle=s,t.stroke(i))}drawFill(t,i,e){t.fillStyle=e,t.fill(i,this.fillRule)}draw(t,i,e,s,h){let r=PathCtr.currentActionID,n=PathCtr.currentFrame;if(0==this.hasActionList.length){if(this.pathDataList.forEach(t=>this.drawPath(i,s,t)),h)return;return this.drawStroke(e,s,this.lineWidth,this.strokeStyle),void this.drawFill(e,s,this.fillStyle)}this.hasActionList[r]||(r=0,n=0),this.pathDataList[r][Math.min(n,this.pathDataList[r].length)].forEach(e=>this.drawPath(t,i,s,e)),h||(this.drawStroke(e,s,this.lineWidth[r][Math.min(n,this.lineWidth[r].length)],this.strokeStyle[r][Math.min(n,this.strokeStyle[r].length)]),this.drawFill(e,s,this.fillStyle[r][Math.min(n,this.fillStyle[r].length)]))}}class GroupObj extends Sprite{constructor(t,i,e,s,h){super(),this.visible=!0,this.id=t,this.paths=i,this.childGroups=e,this.maskIdToUse=h,this.hasActionList=[],s&&this.childGroups.forEach((t,i)=>this.hasActionList[i]=!0)}addAction(t,i,e){if(0!=t.length){if(0==this.hasActionList.length){if(JSON.stringify(t)==JSON.stringify(this.childGroups))return;this.childGroups=[[this.childGroups]],this.hasActionList[0]=!0}this.hasActionList[e]||(this.childGroups[e]=[this.childGroups[0][0].concat()],this.hasActionList[e]=!0),this.childGroups[e][i]=t}}getChildGroups(){if(0==this.childGroups.length)return this.childGroups;if(0==this.hasActionList.length)return this.childGroups;let t=PathCtr.currentActionID;return null==this.childGroups[t]||null==this.childGroups[t][PathCtr.currentFrame]?this.childGroups[0][0]:this.childGroups[t][PathCtr.currentFrame]}draw(t,i,e,s){if(!i)return void console.error("context is not found");if(!this.visible)return;let h=!1,r=e.compSprite(this);if(!s&&this.maskIdToUse){let e=t.groups[this.maskIdToUse];e?(h=!0,i.save(),e.draw(t,i,r,!0)):console.error("group is not found : "+this.maskIdToUse)}let n=s?new Path2D:null,a=!1;this.paths.forEach(e=>{a=!0;let h=!1;if(!s&&e.maskIdToUse){let s=t.groups[e.maskIdToUse];s?(h=!0,i.save(),s.draw(t,i,r,!0)):console.error("mask is not found : "+e.maskIdToUse)}s||(n=new Path2D),e.draw(t,r.matrix,i,n,s),h&&i.restore()}),this.getChildGroups().forEach(e=>{t.groups[e].draw(t,i,r,s)}),s&&a&&i.clip(n),n=null,h&&i.restore()}}class BoneObj extends GroupObj{constructor(t,i,e,s){super(t,i,e,s,"")}draw(t,i,e){if(!i)return void console.error("context is not found");if("undefined"==typeof DebugPath||!DebugPath.isShowBones||!this.visible)return;let s=e.compSprite(this);this.paths.forEach(e=>{let h=new Path2D;e.draw(t,s.matrix,i,h,!1),h=null}),this.getChildGroups().forEach(e=>{t.groups[e].draw(t,i,s,!1)})}}class PathContainer extends Sprite{constructor(){super(),this.visible=!0,this.originalWidth=0,this.originalHeight=0,this.displayWidth=0,this.displayHeight=0,this.pathRatio=0,this.context=null,this.rootGroups=[],this.groups=[],this.groupNameToIDList={},this.masks={},this.actionList=null}getGroup(t){return this.groups[this.groupNameToIDList[t]]}setSize(t,i){this.originalWidth>this.originalHeight?(this.displayWidth=t,this.displayHeight=t*this.originalHeight/this.originalWidth,this.pathRatio=t):(this.displayWidth=i*this.originalWidth/this.originalHeight,this.displayHeight=i,this.pathRatio=i)}draw(t,i=PathCtr.defaultActionName){if(!this.visible||!this.rootGroups)return;PathCtr.currentFrame=t,PathCtr.currentActionID=Object.keys(this.actionList).indexOf(i);let e,s,h=this.displayWidth,r=this.displayHeight;h>r?(e=1,s=r/h):(e=h/r,s=1);let n=()=>(new Sprite).setSprite(this);this.rootGroups.forEach(t=>{this.groups[t].draw(this,this.context,n(),!1)})}}var BinaryLoader={init:function(t){if(!t)return console.error("array buffer is not found"),null;let i=PathCtr.initTarget=new PathContainer,e=new DataView(t),s=0,h=()=>{let t=e.getUint8(s);return s+=1,t},r=()=>{let t=e.getUint16(s);return s+=2,t},n=()=>{let t=e.getFloat32(s);return s+=4,t},a=()=>{let t=e.getInt16(s)/PathCtr.binDataPosRange;return s+=2,t},o=()=>{let t=h(),i="";for(let e=0;e<t;++e)i+=String.fromCharCode(r());return i},l=()=>0==h()?"transparent":"rgb("+h()+", "+h()+", "+h()+")",c=(t,i)=>{let e=[],s=t();for(let t=0;t<s;){let s=r();if(0==s){if(0==(s=r())){console.error("data format error");break}t+=s;continue}let h=i();if(Array.isArray(h))for(let i=0;i<s;++i)e[t+i]=h.concat();else for(let i=0;i<s;++i)e[t+i]=h;t+=s}return e},u=t=>c(h,()=>c(r,()=>t())),d=()=>{let t=r(),i=[];for(let e=0;e<t;++e){let t=h();switch(t){case 0:i.push({type:"M",pos:[a(),a()]});break;case 1:i.push({type:"C",pos:[a(),a(),a(),a(),a(),a()]});break;case 2:i.push({type:"Z"});break;default:console.error("unknown type : "+t)}}return i},p=()=>{let t=r(),i=0==h()?"nonzero":"evenodd";if(!h()){let e=n(),s=l(),h=l(),r=d();return new PathObj(r,t,i,s,e,h)}let e=u(n),s=u(l),a=u(l),o=u(d),c=new PathObj(o,t,i,s,e,a);return c.lineWidth.forEach((t,i)=>c.hasActionList[i]=!0),c.fillStyle.forEach((t,i)=>c.hasActionList[i]=!0),c.strokeStyle.forEach((t,i)=>c.hasActionList[i]=!0),c.pathDataList.forEach((t,i)=>c.hasActionList[i]=!0),c},f=t=>{let e=o();i.groupNameToIDList[e]=t;let s,n=r(),a=c(r,p),l=h()>0;return s=l?u(()=>c(h,r)):c(h,r),e==PathCtr.defaultBoneName?new BoneObj(e,a,s,l):new GroupObj(e,a,s,l,n)};i.originalWidth=i.displayWidth=r(),i.originalHeight=i.displayHeight=r();let g=h();if(g>0){i.actionList={};for(let t=0;t<g;++t)i.actionList[o()]={id:h(),totalFrames:r()}}i.rootGroups=c(h,r);let m=r();for(let t=0;t<m;++t)PathCtr.debugPrint("count : "+t),PathCtr.debugPrint(t),PathCtr.debugPrint(s),i.groups[t]=f(t),PathCtr.debugPrint(i.groups[t]);return PathCtr.initTarget=null,i},load:function(t,i){if(!t)return void console.error("filePath not found");let e=new XMLHttpRequest;e.onload=function(t){let s=t.target;if(4!=s.readyState)return;if(200!=s.status&&0!=s.status)return;let h=e.response,r=BinaryLoader.init(h);console.log("loading completed"),PathCtr.debugPrint(r),i(r)},e.open("GET",t,!0),e.responseType="arraybuffer",e.send()}};