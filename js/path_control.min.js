var PathCtr={defaultActionName:"base",initTarget:null,currentFrame:0,currentActionID:-1,binDataPosRange:2e4,isDebug:!1,debugPrint:function(){if(this.isDebug)for(let t=0;t<arguments.length;++t)console.log(arguments[t])}};class PathObj{constructor(t,e,i,r,o,a){this.maskIdToUse=e,this.pathDataList=t,this.fillRule=i,this.fillStyle=r,this.lineWidth=o,this.strokeStyle=a,this.hasActionList=[]}addAction(t,e,i,r,o,a,s){0==this.hasActionList.length&&(this.pathDataList=[[this.pathDataList]],this.fillStyle=[[this.fillStyle]],this.lineWidth=[[this.lineWidth]],this.strokeStyle=[[this.strokeStyle]],this.hasActionList[0]=!0),this.hasActionList[s]||(this.pathDataList[s]=[this.pathDataList[0][0]],this.fillStyle[s]=[this.fillStyle[0][0]],this.lineWidth[s]=[this.lineWidth[0][0]],this.strokeStyle[s]=[this.strokeStyle[0][0]],this.hasActionList[s]=!0),this.pathDataList[s][a]=t,this.fillStyle[s][a]=i,this.lineWidth[s][a]=r,this.strokeStyle[s][a]=o}drawPath(t,e,i,r){let o=r.pos;switch(r.type){case"M":i.moveTo(o[0]*t,o[1]*e);break;case"C":i.bezierCurveTo(o[0]*t,o[1]*e,o[2]*t,o[3]*e,o[4]*t,o[5]*e);break;case"Z":i.closePath();break;default:console.error("unknown type")}}drawStroke(t,e,i,r){i&&(t.lineWidth=i,t.strokeStyle=r,t.stroke(e))}drawFill(t,e,i){t.fillStyle=i,t.fill(e,this.fillRule)}draw(t,e,i,r,o){let a=PathCtr.currentActionID,s=PathCtr.currentFrame;if(0==this.hasActionList.length){if(this.pathDataList.forEach(i=>this.drawPath(t,e,r,i)),o)return;return this.drawStroke(i,r,this.lineWidth,this.strokeStyle),void this.drawFill(i,r,this.fillStyle)}this.hasActionList[a]||(a=0,s=0),this.pathDataList[a][Math.min(s,this.pathDataList[a].length)].forEach(i=>this.drawPath(t,e,r,i)),o||(this.drawStroke(i,r,this.lineWidth[a][Math.min(s,this.lineWidth[a].length)],this.strokeStyle[a][Math.min(s,this.strokeStyle[a].length)]),this.drawFill(i,r,this.fillStyle[a][Math.min(s,this.fillStyle[a].length)]))}}class GroupObj{constructor(t,e,i,r){this.id=t,this.paths=e,this.childGroups=i,this.maskIdToUse=r,this.hasActionList=[]}addAction(t,e,i){if(0!=t.length){if(0==this.hasActionList.length){if(JSON.stringify(t)==JSON.stringify(this.childGroups))return;this.childGroups=[[this.childGroups]],this.hasActionList[0]=!0}this.hasActionList[i]||(this.childGroups[i]=[this.childGroups[0][0].concat()],this.hasActionList[i]=!0),this.childGroups[i][e]=t}}getChildGroups(){if(0==this.childGroups.length)return this.childGroups;if(0==this.hasActionList.length)return this.childGroups;let t=PathCtr.currentActionID;return null==this.childGroups[t]||null==this.childGroups[t][PathCtr.currentFrame]?this.childGroups[0][0]:this.childGroups[t][PathCtr.currentFrame]}}class PathContainer{constructor(){this.originalWidth=0,this.originalHeight=0,this.displayWidth=0,this.displayHeight=0,this.context=null,this.rootGroups=[],this.groups=[],this.groupNameToIDList={},this.masks={},this.actionList=null}setFitSize(t,e){this.originalWidth>this.originalHeight?(this.displayWidth=t,this.displayHeight=t*this.originalHeight/this.originalWidth):(this.displayWidth=e*this.originalWidth/this.originalHeight,this.displayHeight=e)}drawGroup(t,e){if(!this.context)return void console.error("context is not found");let i=!1;if(!e&&t.maskIdToUse){let e=this.groups[t.maskIdToUse];e?(i=!0,this.context.save(),this.drawGroup(e,!0)):console.error("group is not found : "+t.maskIdToUse)}let r=e?new Path2D:null,o=!1;t.paths.forEach(t=>{o=!0;let i=!1;if(!e&&t.maskIdToUse){let e=this.groups[t.maskIdToUse];e?(i=!0,this.context.save(),this.drawGroup(e,!0)):console.error("mask is not found : "+t.maskIdToUse)}e||(r=new Path2D),t.draw(this.displayWidth,this.displayHeight,this.context,r,e),i&&this.context.restore()}),t.getChildGroups().forEach(t=>{this.drawGroup(this.groups[t],e)}),e&&o&&this.context.clip(r),r=null,i&&this.context.restore()}draw(t,e=PathCtr.defaultActionName){if(!this.rootGroups)return void console.error("root groups is not found");PathCtr.currentFrame=t,PathCtr.currentActionID=Object.keys(this.actionList).indexOf(e);let i=new Path2D;i.rect(0,0,this.displayWidth,this.displayHeight),this.context.clip(i),i=null,this.rootGroups.forEach(t=>{this.drawGroup(this.groups[t],!1)})}}var PathFactory={getMaskId:function(t){if(!t)return null;let e=t.replace(/^url\(#/,"").replace(/\)$/,"");return PathCtr.initTarget.masks[e]?PathCtr.initTarget.masks[e]:(console.error("unknown mask name : "+t),null)},makePathDataList:function(t){let e,i=[];e=t.indexOf(",")<0?t.split(/ /):t.replace(/([MCZ])/g,",$1,").replace(/[^,]-/g,",-").split(/[, ]/);let r=PathCtr.initTarget.originalWidth,o=PathCtr.initTarget.originalHeight,a=()=>parseFloat(e.shift())/r,s=()=>parseFloat(e.shift())/o;for(;e.length>0;){let t=e.shift();switch(t){case"M":i.push({type:"M",pos:[a(),s()]});break;case"C":i.push({type:"C",pos:[a(),s(),a(),s(),a(),s()]});break;case"Z":i.push({type:"Z"});break;case"":break;default:console.error("unknown type : "+t),console.log(t)}}return i},makePath:function(t,e){let i=e.fill;"none"==i&&(i="transparent");let r=0,o=e.stroke;return"none"==o&&(r=parseFloat(e.strokeWidth.match(/([\d\.]+)/)[1]),o="transparent"),new PathObj(PathFactory.makePathDataList(t.getAttribute("d")),PathFactory.getMaskId(t.getAttribute("mask")),e.fillRule,i,r,o)},addActionPath:function(t,e,i,r,o){let a=e?i.fillRule:"nonzero",s=e?i.fill:"none";"none"==s&&(s="transparent");let n=0,l=e?i.stroke:"none";"none"==l?l="transparent":n=parseFloat(i.strokeWidth.match(/([\d\.]+)/)[1]);let h=null;h=e?this.makePathDataList(e.getAttribute("d")):t.hasActionList[o]?t.pathDataList[0][0].concat():t.pathDataList.concat(),t.addAction(h,a,s,n,l,r,o)},makeGroup:function(t){let e=t.getAttribute("id"),i=[],r=[];Array.prototype.slice.call(t.children).forEach(t=>{let o=t.tagName;switch(PathCtr.debugPrint("make group : "+e+" : "+o),o){case"path":i.push(this.makePath(t,window.getComputedStyle(t)));break;case"mask":case"clipPath":break;case"g":r.push(PathCtr.initTarget.groupNameToIDList[t.getAttribute("id")]),this.makeGroup(t);break;default:console.error("unknown element"),console.log(t)}});let o=new GroupObj(e,i,r,PathFactory.getMaskId(t.getAttribute("mask")));return PathCtr.initTarget.groups[PathCtr.initTarget.groupNameToIDList[e]]=o,o},addActionGroup:function(t,e,i,r){let o=PathCtr.initTarget.groups[PathCtr.initTarget.groupNameToIDList[e]],a=[],s=0;if(t){Array.prototype.slice.call(t.children).forEach(t=>{switch(t.tagName){case"path":this.addActionPath(o.paths[s++],t,window.getComputedStyle(t),i,r);break;case"mask":case"clipPath":break;case"g":a.push(PathCtr.initTarget.groupNameToIDList[t.getAttribute("id")]);break;default:console.error("unknown element"),console.log(t)}})}else{Array.prototype.slice.call(o.paths).forEach(t=>{this.addActionPath(t,null,null,i,r)})}o.addAction(a,i,r)},initFromSvg:function(t){if(!t)return console.error("groups dom is not found"),null;console.log("init");let e=PathCtr.initTarget=new PathContainer;return e.originalWidth=e.displayWidth=parseInt(t.getAttribute("width").replace("px","")),e.originalHeight=e.displayHeight=parseInt(t.getAttribute("height").replace("px","")),Array.prototype.slice.call(t.getElementsByTagName("g")).forEach(t=>{let i=t.getAttribute("id");null==e.groupNameToIDList[i]?e.groupNameToIDList[i]=Object.keys(e.groupNameToIDList).length:console.error("group ID is duplicated : "+i)}),Array.prototype.slice.call(t.getElementsByTagName("mask")).forEach(t=>{Array.prototype.slice.call(t.children).forEach(i=>{"use"==i.tagName?e.masks[t.getAttribute("id")]=e.groupNameToIDList[i.getAttribute("xlink:href").slice(1)]:(console.error("unknown mask data"),console.log(i))})}),Array.prototype.slice.call(t.children).forEach(t=>{if("g"!=t.tagName)return;let i=this.makeGroup(t);e.rootGroups.push(e.groupNameToIDList[i.id])}),PathCtr.initTarget=null,e},addActionFromSvgList:function(t,e,i=0){if(!t)return void console.error("path container is not found");if(!e)return void console.error("groups dom list is not found");PathCtr.initTarget=t,console.log("check id");let r={},o=Array.prototype.slice.call(e),a=o[0];a.getElementsByTagName("g");o.forEach(e=>{let i=e.getElementsByTagName("g"),r=[].map.call(i,t=>t.getAttribute("id"));Array.prototype.forEach.call(r,i=>{null==t.groupNameToIDList[i]&&(t.groupNameToIDList[i]=Object.keys(t.groupNameToIDList).length,this.makeGroup(e.getElementById(i)))}),Array.prototype.slice.call(e.getElementsByTagName("mask")).forEach(e=>{let i=e.getAttribute("id");t.masks[i]||Array.prototype.slice.call(e.children).forEach(e=>{"use"==e.tagName?t.masks[i]=t.groupNameToIDList[e.getAttribute("xlink:href").slice(1)]:(console.error("unknown mask data"),console.log(e))})})}),console.log(t),console.log("check diff"),o.forEach(e=>{Object.keys(t.groupNameToIDList).forEach(t=>{let i=a.getElementById(t);i&&e&&i.isEqualNode(e.getElementById(t))||(r[t]=!0)})}),o.forEach((t,e)=>{0!=e&&(console.log("add action : "+i+" - "+e),Object.keys(r).forEach(r=>{this.addActionGroup(t.getElementById(r),r,e,i)}))}),PathCtr.initTarget=null},initFromBin:function(t){if(!t)return console.error("array buffer is not found"),null;let e=new PathContainer,i=new DataView(t),r=0,o=()=>{let t=i.getUint8(r);return r+=1,t},a=()=>{let t=i.getUint16(r);return r+=2,t},s=()=>{let t=i.getFloat32(r);return r+=4,t},n=()=>{let t=i.getInt16(r)/PathCtr.binDataPosRange;return r+=2,t},l=()=>{let t=o(),e="";for(let i=0;i<t;++i)e+=String.fromCharCode(a());return e},h=()=>0==o()?"transparent":"rgb("+o()+", "+o()+", "+o()+")",c=(t,e)=>{let i=[],r=t();for(let t=0;t<r;){let r=a();if(0==r){if(0==(r=a())){console.error("data format error");break}t+=r;continue}let o=e();if(Array.isArray(o))for(let e=0;e<r;++e)i[t+e]=o.concat();else for(let e=0;e<r;++e)i[t+e]=o;t+=r}return i},u=t=>c(o,()=>c(a,()=>t())),d=()=>{let t=a(),e=[];for(let i=0;i<t;++i){let t=o();switch(t){case 0:e.push({type:"M",pos:[n(),n()]});break;case 1:e.push({type:"C",pos:[n(),n(),n(),n(),n(),n()]});break;case 2:e.push({type:"Z"});break;default:console.error("unknown type : "+t)}}return e},p=()=>{let t=a(),e=0==o()?"nonzero":"evenodd";if(!o()){let i=s(),r=h(),o=h(),a=d();return new PathObj(a,t,e,r,i,o)}let i=u(s),r=u(h),n=u(h),l=u(d),c=new PathObj(l,t,e,r,i,n);return c.lineWidth.forEach((t,e)=>c.hasActionList[e]=!0),c.fillStyle.forEach((t,e)=>c.hasActionList[e]=!0),c.strokeStyle.forEach((t,e)=>c.hasActionList[e]=!0),c.pathDataList.forEach((t,e)=>c.hasActionList[e]=!0),c},g=t=>{let i=l();e.groupNameToIDList[i]=t;let r=a(),s=c(a,p);if(!o()){let t=c(o,a);return new GroupObj(i,s,t,r)}let n=new GroupObj(i,s,[],r);return n.childGroups=u(()=>c(o,a)),n.childGroups.forEach((t,e)=>n.hasActionList[e]=!0),n};e.originalWidth=e.displayWidth=a(),e.originalHeight=e.displayHeight=a();let f=o();if(f>0){e.actionList={};for(let t=0;t<f;++t)e.actionList[l()]={id:o(),totalFrames:a()}}e.rootGroups=c(o,a);let m=a();for(let t=0;t<m;++t)PathCtr.debugPrint("count : "+t),PathCtr.debugPrint(t),PathCtr.debugPrint(r),e.groups[t]=g(t),PathCtr.debugPrint(e.groups[t]);return e},dataTobin:function(t){if(!t)return console.error("path container is not found"),null;let e=new ArrayBuffer(1e9),i=new DataView(e),r=0,o=t=>{i.setUint8(r,t),r+=1},a=t=>{i.setUint16(r,t),r+=2},s=t=>{i.setFloat32(r,t),r+=4},n=t=>{i.setInt16(r,t*PathCtr.binDataPosRange),r+=2},l=t=>{o(t.length),[].map.call(t,t=>a(t.charCodeAt(0)))},h=t=>{if("transparent"==t)o(0);else{let e=t.match(/(\d+), (\d+), (\d+)/);o(1),o(e[1]),o(e[2]),o(e[3])}},c=(t,e,i)=>{let r=t.length;e(r);for(let e=0;e<r;){let o=t[e],s=1;if(void 0!==o){for(;s<r&&(void 0!==t[e+s]&&JSON.stringify(o)==JSON.stringify(t[e+s]));++s);a(s),e+=s,i(o)}else{for(a(0);s<r&&void 0===t[e+s];++s);a(s),e+=s}}},u=(t,e)=>{c(t,o,t=>{c(t,a,e)})},d=t=>{a(t.length),t.forEach(t=>{switch(t.type){case"M":o(0),n(t.pos[0]),n(t.pos[1]);break;case"C":o(1);for(let e=0;e<6;++e)n(t.pos[e]);break;case"Z":o(2);break;default:console.error("unknown type"),console.log(t)}})},p=t=>{if(a(t.maskIdToUse),o("nonzero"==t.fillRule?0:1),!(t.hasActionList.length>0))return o(0),s(t.lineWidth),h(t.fillStyle),h(t.strokeStyle),void d(t.pathDataList);o(1),u(t.lineWidth,s),u(t.fillStyle,h),u(t.strokeStyle,h),u(t.pathDataList,d)};a(t.originalWidth),a(t.originalHeight),o(Object.keys(t.actionList).length),Object.keys(t.actionList).forEach(e=>{l(e),o(t.actionList[e].id),a(t.actionList[e].totalFrames)}),c(t.rootGroups,o,a);let g=t.groups.length;return a(g),t.groups.forEach(t=>{console.log("count : "+g--),PathCtr.debugPrint(r),(t=>{if(l(t.id),a(t.maskIdToUse),c(t.paths,a,p),!(t.hasActionList.length>0))return o(0),void c(t.childGroups,o,a);o(1),u(t.childGroups,t=>{c(t,o,a)})})(t),PathCtr.debugPrint(t)}),delete i,e.slice(0,r)},svgFilesLoad:function(t,e){if(!t||!Array.isArray(t)||!Array.isArray(t[0]))return console.error("fileInfoList format is woring"),void console.log(t);if(t[0][2]!=PathCtr.defaultActionName)return void console.error('action name "'+PathCtr.defaultActionName+'" is missing in fileInfoList');let i=null,r=0,o=[],a=t=>"00000".substr(0,5-t.toString().length)+t+".svg",s=n=>{let l=n[0],h=n[1],c=n[2],u=1,d=new XMLHttpRequest,p=d.onload=function(n){let g=n.target;if(4!=g.readyState)return;if(200!=g.status&&0!=g.status)return;let f=g.responseText,m=document.createElement("div");m.setAttribute("style","display:none;"),m.innerHTML=f;let y=m.firstElementChild;if(document.body.append(m),o[parseInt(f.match(/id="Frame_(\d+)"/)[1])-1]=y,m=y=null,delete d,u<=h)return console.log("load file : "+u),(d=new XMLHttpRequest).open("GET",l+a(u++),!0),d.onreadystatechange=p,void d.send();i||((i=PathFactory.initFromSvg(o[0])).actionList={});let k=Object.keys(i.actionList).length;i.actionList[c]={id:k,totalFrames:h},PathFactory.addActionFromSvgList(i,o,k),console.log("loading completed"),PathCtr.debugPrint(i),o.forEach(t=>t.parentNode.remove()),o.length=0,++r<t.length?s(t[r]):e(i)};d.open("GET",l+a(u++),!0),d.send()};s(t[r])},binFileLoad:function(t,e){if(!t)return void console.error("filePath not found");let i=new XMLHttpRequest;i.onload=function(t){let r=t.target;if(4!=r.readyState)return;if(200!=r.status&&0!=r.status)return;let o=i.response,a=PathFactory.initFromBin(o);console.log("loading completed"),PathCtr.debugPrint(a),e(a)},i.open("GET",t,!0),i.responseType="arraybuffer",i.send()}};