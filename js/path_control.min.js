var PathCtr={defaultAction:"base",initTarget:null,currentFrame:0,currentActionName:"",binDataPosRange:2e4,isDebug:!1,debugPrint:function(){if(this.isDebug)for(var t=0;t<arguments.length;++t)console.log(arguments[t])},PathObj:function(t,i,e,r,a,s){this.maskIdToUse=i,this.pathDataList=t,this.fillRule=e,this.fillStyle=r,this.lineWidth=a,this.strokeStyle=s,this.actionList=null},GroupObj:function(t,i,e,r){this.id=t,this.paths=i,this.childGroups=e,this.maskIdToUse=r,this.actionList=null},PathContainer:function(){this.originalWidth=0,this.originalHeight=0,this.displayWidth=0,this.displayHeight=0,this.context=null,this.rootGroups=[],this.groups={},this.masks={}},getMaskId:function(t){return t?t.replace(/^url\(#/,"").replace(/\)$/,""):""},makePathDataList:function(t){var i,e=[];i=t.indexOf(",")<0?t.split(/ /):t.replace(/([MCZ])/g,",$1,").replace(/[^,]-/g,",-").split(/[, ]/);for(var r=this.initTarget.originalWidth,a=this.initTarget.originalHeight,s=()=>parseFloat(i.shift())/r,o=()=>parseFloat(i.shift())/a;i.length>0;){var n=i.shift();switch(n){case"M":e.push({type:"M",pos:[s(),o()]});break;case"C":e.push({type:"C",pos:[s(),o(),s(),o(),s(),o()]});break;case"Z":e.push({type:"Z"});break;case"":break;default:console.error("unknown type : "+n)}}return e},makePath:function(t,i){var e=i.fill;"none"==e&&(e="transparent");var r=0,a=i.stroke;return"none"==a&&(r=parseFloat(i.strokeWidth.match(/([\d\.]+)/)[1]),a="transparent"),new this.PathObj(this.makePathDataList(t.getAttribute("d")),this.getMaskId(t.getAttribute("mask")),i.fillRule,e,r,a)},addActionPath:function(t,i,e,r,a){var s=i?e.fillRule:"nonzero",o=i?e.fill:"none";"none"==o&&(o="transparent");var n=0,h=i?e.stroke:"none";"none"==h?h="transparent":n=parseFloat(e.strokeWidth.match(/([\d\.]+)/)[1]);var l=null;l=i?this.makePathDataList(i.getAttribute("d")):t.actionList?t.pathDataList[0][0].concat():t.pathDataList.concat(),t.addAction(l,s,o,n,h,r,a)},makeGroup:function(t){var i=t.getAttribute("id"),e=[],r=[];Array.prototype.slice.call(t.children).forEach(t=>{var a=t.tagName;switch(PathCtr.debugPrint("make group : "+i+" : "+a),a){case"path":e.push(this.makePath(t,window.getComputedStyle(t)));break;case"mask":Array.prototype.slice.call(t.children).forEach(i=>{"use"==i.tagName?this.initTarget.masks[t.getAttribute("id")]=i.getAttribute("xlink:href").slice(1):(console.error("unknown mask data"),console.log(i))});break;case"clipPath":break;case"g":r.push(t.getAttribute("id")),this.makeGroup(t);break;default:console.error("unknown element"),console.log(t)}});var a=new this.GroupObj(i,e,r,this.getMaskId(t.getAttribute("mask")));return this.initTarget.groups[i]=a,a},addActionGroup:function(t,i,e,r){var a=this.initTarget.groups[i],s=[],o=0;t?Array.prototype.slice.call(t.children).forEach(t=>{switch(t.tagName){case"path":this.addActionPath(a.paths[o++],t,window.getComputedStyle(t),e,r);break;case"mask":case"clipPath":break;case"g":s.push(t.getAttribute("id"));break;default:console.error("unknown element"),console.log(t)}}):Array.prototype.slice.call(a.paths).forEach(t=>{this.addActionPath(t,null,null,e,r)});a.addAction(s,e,r)},initFromSvg:function(t){if(!t)return console.error("groups dom is not found"),null;console.log("init");var i=this.initTarget=new this.PathContainer;return this.initTarget.originalWidth=this.initTarget.displayWidth=parseInt(t.getAttribute("width").replace("px","")),this.initTarget.originalHeight=this.initTarget.displayHeight=parseInt(t.getAttribute("height").replace("px","")),Array.prototype.slice.call(t.children).forEach(t=>{if("g"==t.tagName){var e=this.makeGroup(t);i.rootGroups.push(e.id)}}),this.initTarget=null,i},addActionFromSvgList:function(t,i,e=this.defaultAction){if(t)if(i){this.initTarget=t,console.log("check id");var r={},a=Array.prototype.slice.call(i),s=a[0],o=s.getElementsByTagName("g"),n=[].map.call(o,t=>t.getAttribute("id"));a.forEach(t=>{var i=t.getElementsByTagName("g"),e=[].map.call(i,t=>t.getAttribute("id"));Array.prototype.forEach.call(e,i=>{n.includes(i)||(n.push(i),this.makeGroup(t.getElementById(i)))})}),console.log("check diff"),a.forEach(t=>{n.forEach(i=>{var e=s.getElementById(i);e&&t&&e.isEqualNode(t.getElementById(i))||(r[i]=!0)})}),a.forEach((t,i)=>{0!=i&&(console.log("add action : "+i),Object.keys(r).forEach(r=>{this.addActionGroup(t.getElementById(r),r,i,e)}),++i)}),this.initTarget=null}else console.error("groups dom list is not found");else console.error("path container is not found")},initFromBin:function(t){if(!t)return console.error("array buffer is not found"),null;var i=new this.PathContainer,e=new DataView(t),r=0,a={0:""},s=()=>{var t=e.getUint8(r);return r+=1,t},o=()=>{var t=e.getUint16(r);return r+=2,t},n=()=>{var t=e.getFloat32(r);return r+=4,t},h=()=>{var t=e.getInt16(r)/this.binDataPosRange;return r+=2,t},l=()=>{for(var t=s(),i="",e=0;e<t;++e)i+=String.fromCharCode(o());return i},c=()=>{return 0==s()?"transparent":"rgb("+s()+", "+s()+", "+s()+")"},u=(t,i)=>{for(var e=[],r=t(),a=0;a<r;){var s=o();if(0!=s){var n=i();if(Array.isArray(n))for(var h=0;h<s;++h)e[a+h]=n.concat();else for(h=0;h<s;++h)e[a+h]=n;a+=s}else{if(0==(s=o())){console.error("data format error");break}a+=s}}return e},p=()=>a[o()],d=t=>u(s,()=>u(o,()=>t())),g=()=>{for(var t=o(),i=[],e=0;e<t;++e){var r=s();switch(r){case 0:i.push({type:"M",pos:[h(),h()]});break;case 1:i.push({type:"C",pos:[h(),h(),h(),h(),h(),h()]});break;case 2:i.push({type:"Z"});break;default:console.error("unknown type : "+r)}}return i},f=()=>{var t=p(),i=0==s()?"nonzero":"evenodd",e=s();if(0==e){var r=n(),a=c(),o=c(),h=g();return new this.PathObj(h,t,i,a,r,o)}for(var u={},f=0;f<e;++f)u[l()]=s();r=d(n),a=d(c),o=d(c),h=d(g);var k=new this.PathObj(h,t,i,a,r,o);return k.actionList=u,k},k=()=>{var t=p(),i=p(),e=u(o,f),r=s();if(0==r){var a=u(s,p);return n=new this.GroupObj(t,e,a,i)}for(var n=new this.GroupObj(t,e,[],i),h={},c=[],g=0;g<r;++g){var k=l();h[k]=s(),c.push(k)}return n.actionList=h,n.childGroups=d(()=>u(s,p)),n};i.originalWidth=i.displayWidth=o(),i.originalHeight=i.displayHeight=o();for(var y=o(),m=0;m<y;++m)a[m+1]=l();for(m=s();m>0;--m)i.masks[p()]=p();i.rootGroups=u(s,p);var b=o();for(m=0;m<b;++m){var v=a[m+1];PathCtr.debugPrint("count : "+m),PathCtr.debugPrint(v),PathCtr.debugPrint(r),i.groups[v]=k(),PathCtr.debugPrint(i.groups[v])}return i},dataTobin:function(t){if(!t)return console.error("path container is not found"),null;var i=new ArrayBuffer(1e9),e=new DataView(i),r=0,a={"":0},s=t=>{e.setUint8(r,t),r+=1},o=t=>{e.setUint16(r,t),r+=2},n=t=>{e.setFloat32(r,t),r+=4},h=t=>{e.setInt16(r,t*this.binDataPosRange),r+=2},l=t=>{s(t.length);[].map.call(t,t=>o(t.charCodeAt(0)))},c=t=>{if("transparent"==t)s(0);else{var i=t.match(/(\d+), (\d+), (\d+)/);s(1),s(i[1]),s(i[2]),s(i[3])}},u=(t,i,e)=>{var r=t.length;i(r);for(var a=0;a<r;){var s=t[a],n=1;if(void 0!==s){for(;n<r&&(void 0!==t[a+n]&&JSON.stringify(s)==JSON.stringify(t[a+n]));++n);o(n),a+=n,e(s)}else{for(o(0);n<r&&void 0===t[a+n];++n);o(n),a+=n}}},p=(t,i)=>{u(t,s,t=>{u(t,o,i)})},d=t=>o(a[t]),g=t=>{o(t.length),t.forEach(t=>{switch(t.type){case"M":s(0),h(t.pos[0]),h(t.pos[1]);break;case"C":s(1);for(var i=0;i<6;++i)h(t.pos[i]);break;case"Z":s(2);break;default:console.error("unknown type"),console.log(t)}})},f=t=>{if(d(t.maskIdToUse),s("nonzero"==t.fillRule?0:1),!t.actionList)return s(0),n(t.lineWidth),c(t.fillStyle),c(t.strokeStyle),void g(t.pathDataList);s(Object.keys(t.actionList).length),Object.keys(t.actionList).forEach(i=>{l(i),s(t.actionList[i])}),p(t.lineWidth,n),p(t.fillStyle,c),p(t.strokeStyle,c),p(t.pathDataList,g)};o(t.originalWidth),o(t.originalHeight);var k=Object.keys(t.groups).length,y=Object.keys(t.masks).length;return o(k+y),Object.keys(t.groups).forEach(t=>{a[t]=Object.keys(a).length,l(t)}),Object.keys(t.masks).forEach(t=>{a[t]=Object.keys(a).length,l(t)}),s(y),Object.keys(t.masks).forEach(i=>{d(i),d(t.masks[i])}),u(t.rootGroups,s,d),o(k),Object.keys(t.groups).forEach(i=>{console.log("count : "+k--),PathCtr.debugPrint(i),PathCtr.debugPrint(r),(t=>{if(d(t.id),d(t.maskIdToUse),u(t.paths,o,f),!t.actionList)return s(0),void u(t.childGroups,s,d);s(Object.keys(t.actionList).length),Object.keys(t.actionList).forEach(i=>{l(i),s(t.actionList[i])}),p(t.childGroups,t=>{u(t,s,d)})})(t.groups[i]),PathCtr.debugPrint(t.groups[i])}),i.slice(0,r)}};PathCtr.PathObj.prototype={addAction:function(t,i,e,r,a,s,o){if(o){if(this.actionList||(this.pathDataList=[[this.pathDataList]],this.fillStyle=[[this.fillStyle]],this.lineWidth=[[this.lineWidth]],this.strokeStyle=[[this.strokeStyle]],this.actionList={},this.actionList[PathCtr.defaultAction]=0),!this.actionList.hasOwnProperty(o)){var n=Object.keys(this.actionList).length;this.actionList[o]=n,this.pathDataList[n]=[this.pathDataList[0][0]],this.fillStyle[n]=[this.fillStyle[0][0]],this.lineWidth[n]=[this.lineWidth[0][0]],this.strokeStyle[n]=[this.strokeStyle[0][0]]}n=this.actionList[o];this.pathDataList[n][s]=t,this.fillStyle[n][s]=e,this.lineWidth[n][s]=r,this.strokeStyle[n][s]=a}else console.error("please specify a action name")},draw:function(t,i,e,r,a){var s=e=>{var a=e.pos,s=t,o=i;switch(e.type){case"M":r.moveTo(a[0]*s,a[1]*o);break;case"C":r.bezierCurveTo(a[0]*s,a[1]*o,a[2]*s,a[3]*o,a[4]*s,a[5]*o);break;case"Z":r.closePath();break;default:console.error("unknown type")}},o=(t,i)=>{t&&(e.lineWidth=t,e.strokeStyle=i,e.stroke(r))},n=t=>{e.fillStyle=t,e.fill(r,this.fillRule)};if(this.actionList){var h=this.actionList[PathCtr.currentActionName];if(h||(h=0),frame=Math.min(PathCtr.currentFrame,this.lineWidth[h].length),this.pathDataList[h][frame].forEach(s),a)return;return o(this.lineWidth[h][frame],this.strokeStyle[h][frame]),void n(this.fillStyle[h][frame])}this.pathDataList.forEach(s),a||(o(this.lineWidth,this.strokeStyle),n(this.fillStyle))}},PathCtr.GroupObj.prototype={addAction:function(t,i,e){if(e){if(0!=t.length){if(this.actionList||(this.childGroups=[[this.childGroups]],this.actionList={},this.actionList[PathCtr.defaultAction]=0),!this.actionList.hasOwnProperty(e)){var r=Object.keys(this.actionList).length;this.actionList[e]=r,this.childGroups[r]=[],this.childGroups[r][0]=this.childGroups[0][0].concat()}r=this.actionList[e];this.childGroups[r][i]=t}}else console.error("please specify a action name")},getChildGroups:function(){if(0==this.childGroups.length)return this.childGroups;if(!this.actionList)return this.childGroups;var t=this.actionList[PathCtr.currentActionName];return this.childGroups[t]?this.childGroups[t][PathCtr.currentFrame]:this.childGroups[0][0]}},PathCtr.PathContainer.prototype={setFitSize:function(t,i){this.originalWidth>this.originalHeight?(this.displayWidth=t,this.displayHeight=t*this.originalHeight/this.originalWidth):(this.displayWidth=i*this.originalWidth/this.originalHeight,this.displayHeight=i)},getMaskGroup:function(t){var i=this.masks[t];return i?this.groups[i]:(console.error("mask is not found : "+t),null)},drawGroup:function(t,i){if(this.context){var e=!1;if(!i&&t.maskIdToUse){var r=this.getMaskGroup(t.maskIdToUse);r?(e=!0,this.context.save(),this.drawGroup(r,!0)):console.error("group is not found : "+t.maskIdToUse)}var a=i?new Path2D:0,s=!1;t.paths.forEach(t=>{s=!0;var e=!1;if(!i&&t.maskIdToUse){var r=this.getMaskGroup(t.maskIdToUse);r?(e=!0,this.context.save(),this.drawGroup(r,!0)):console.error("mask is not found : "+t.maskIdToUse)}i||(a=new Path2D),t.draw(this.displayWidth,this.displayHeight,this.context,a,i),e&&this.context.restore()});var o=t.getChildGroups();o&&o.forEach(t=>{this.drawGroup(this.groups[t],i)}),i&&s&&this.context.clip(a),e&&this.context.restore()}else console.error("context is not found")},draw:function(t,i=PathCtr.defaultAction){if(this.rootGroups){PathCtr.currentFrame=t,PathCtr.currentActionName=i;var e=new Path2D;e.rect(0,0,this.displayWidth,this.displayHeight),this.context.clip(e),this.rootGroups.forEach(t=>{this.drawGroup(this.groups[t],!1)})}else console.error("root groups is not found")}};