var PathCtr={defaultAction:"base",initTarget:null,currentFrame:0,currentActionName:"",binDataPosRange:2e4,isDebug:!1,debugPrint:function(){if(this.isDebug)for(let t=0;t<arguments.length;++t)console.log(arguments[t])},PathObj:function(t,e,i,r,s,o){this.maskIdToUse=e,this.pathDataList=t,this.fillRule=i,this.fillStyle=r,this.lineWidth=s,this.strokeStyle=o,this.actionList=null},GroupObj:function(t,e,i,r){this.id=t,this.paths=e,this.childGroups=i,this.maskIdToUse=r,this.actionList=null},PathContainer:function(){this.originalWidth=0,this.originalHeight=0,this.displayWidth=0,this.displayHeight=0,this.context=null,this.rootGroups=[],this.groups={},this.masks={}},getMaskId:function(t){return t?t.replace(/^url\(#/,"").replace(/\)$/,""):""},makePathDataList:function(t){let e,i=[];e=t.indexOf(",")<0?t.split(/ /):t.replace(/([MCZ])/g,",$1,").replace(/[^,]-/g,",-").split(/[, ]/);let r=this.initTarget.originalWidth,s=this.initTarget.originalHeight,o=()=>parseFloat(e.shift())/r,a=()=>parseFloat(e.shift())/s;for(;e.length>0;){let t=e.shift();switch(t){case"M":i.push({type:"M",pos:[o(),a()]});break;case"C":i.push({type:"C",pos:[o(),a(),o(),a(),o(),a()]});break;case"Z":i.push({type:"Z"});break;case"":break;default:console.error("unknown type : "+t)}}return i},makePath:function(t,e){let i=e.fill;"none"==i&&(i="transparent");let r=0,s=e.stroke;return"none"==s&&(r=parseFloat(e.strokeWidth.match(/([\d\.]+)/)[1]),s="transparent"),new this.PathObj(this.makePathDataList(t.getAttribute("d")),this.getMaskId(t.getAttribute("mask")),e.fillRule,i,r,s)},addActionPath:function(t,e,i,r,s){let o=e?i.fillRule:"nonzero",a=e?i.fill:"none";"none"==a&&(a="transparent");let n=0,l=e?i.stroke:"none";"none"==l?l="transparent":n=parseFloat(i.strokeWidth.match(/([\d\.]+)/)[1]);let h=null;h=e?this.makePathDataList(e.getAttribute("d")):t.actionList?t.pathDataList[0][0].concat():t.pathDataList.concat(),t.addAction(h,o,a,n,l,r,s)},makeGroup:function(t){let e=t.getAttribute("id"),i=[],r=[];Array.prototype.slice.call(t.children).forEach(t=>{let s=t.tagName;switch(PathCtr.debugPrint("make group : "+e+" : "+s),s){case"path":i.push(this.makePath(t,window.getComputedStyle(t)));break;case"mask":Array.prototype.slice.call(t.children).forEach(e=>{"use"==e.tagName?this.initTarget.masks[t.getAttribute("id")]=e.getAttribute("xlink:href").slice(1):(console.error("unknown mask data"),console.log(e))});break;case"clipPath":break;case"g":r.push(t.getAttribute("id")),this.makeGroup(t);break;default:console.error("unknown element"),console.log(t)}});let s=new this.GroupObj(e,i,r,this.getMaskId(t.getAttribute("mask")));return this.initTarget.groups[e]=s,s},addActionGroup:function(t,e,i,r){let s=this.initTarget.groups[e],o=[],a=0;if(t){Array.prototype.slice.call(t.children).forEach(t=>{switch(t.tagName){case"path":this.addActionPath(s.paths[a++],t,window.getComputedStyle(t),i,r);break;case"mask":case"clipPath":break;case"g":o.push(t.getAttribute("id"));break;default:console.error("unknown element"),console.log(t)}})}else{Array.prototype.slice.call(s.paths).forEach(t=>{this.addActionPath(t,null,null,i,r)})}s.addAction(o,i,r)},initFromSvg:function(t){if(!t)return console.error("groups dom is not found"),null;console.log("init");let e=this.initTarget=new this.PathContainer;return this.initTarget.originalWidth=this.initTarget.displayWidth=parseInt(t.getAttribute("width").replace("px","")),this.initTarget.originalHeight=this.initTarget.displayHeight=parseInt(t.getAttribute("height").replace("px","")),Array.prototype.slice.call(t.children).forEach(t=>{if("g"!=t.tagName)return;let i=this.makeGroup(t);e.rootGroups.push(i.id)}),this.initTarget=null,e},addActionFromSvgList:function(t,e,i=this.defaultAction){if(!t)return void console.error("path container is not found");if(!e)return void console.error("groups dom list is not found");this.initTarget=t,console.log("check id");let r={},s=Array.prototype.slice.call(e),o=s[0],a=o.getElementsByTagName("g"),n=[].map.call(a,t=>t.getAttribute("id"));s.forEach(t=>{let e=t.getElementsByTagName("g"),i=[].map.call(e,t=>t.getAttribute("id"));Array.prototype.forEach.call(i,e=>{n.includes(e)||(n.push(e),this.makeGroup(t.getElementById(e)))})}),console.log("check diff"),s.forEach(t=>{n.forEach(e=>{let i=o.getElementById(e);i&&t&&i.isEqualNode(t.getElementById(e))||(r[e]=!0)})}),s.forEach((t,e)=>{0!=e&&(console.log("add action : "+e),Object.keys(r).forEach(r=>{this.addActionGroup(t.getElementById(r),r,e,i)}),++e)}),this.initTarget=null},initFromBin:function(t){if(!t)return console.error("array buffer is not found"),null;let e=new this.PathContainer,i=new DataView(t),r=0,s={0:""},o=()=>{let t=i.getUint8(r);return r+=1,t},a=()=>{let t=i.getUint16(r);return r+=2,t},n=()=>{let t=i.getFloat32(r);return r+=4,t},l=()=>{let t=i.getInt16(r)/this.binDataPosRange;return r+=2,t},h=()=>{let t=o(),e="";for(let i=0;i<t;++i)e+=String.fromCharCode(a());return e},c=()=>{return 0==o()?"transparent":"rgb("+o()+", "+o()+", "+o()+")"},u=(t,e)=>{let i=[],r=t();for(let t=0;t<r;){let r=a();if(0==r){if(0==(r=a())){console.error("data format error");break}t+=r;continue}let s=e();if(Array.isArray(s))for(let e=0;e<r;++e)i[t+e]=s.concat();else for(let e=0;e<r;++e)i[t+e]=s;t+=r}return i},d=()=>s[a()],p=t=>u(o,()=>u(a,()=>t())),f=()=>{let t=a(),e=[];for(let i=0;i<t;++i){let t=o();switch(t){case 0:e.push({type:"M",pos:[l(),l()]});break;case 1:e.push({type:"C",pos:[l(),l(),l(),l(),l(),l()]});break;case 2:e.push({type:"Z"});break;default:console.error("unknown type : "+t)}}return e},g=()=>{let t=d(),e=0==o()?"nonzero":"evenodd",i=o();if(0==i){let i=n(),r=c(),s=c(),o=f();return new this.PathObj(o,t,e,r,i,s)}let r={};for(let t=0;t<i;++t)r[h()]=o();let s=p(n),a=p(c),l=p(c),u=p(f),g=new this.PathObj(u,t,e,a,s,l);return g.actionList=r,g},k=()=>{let t=d(),e=d(),i=u(a,g),r=o();if(0==r){let r=u(o,d);return new this.GroupObj(t,i,r,e)}let s=new this.GroupObj(t,i,[],e),n={},l=[];for(let t=0;t<r;++t){let t=h();n[t]=o(),l.push(t)}return s.actionList=n,s.childGroups=p(()=>u(o,d)),s};e.originalWidth=e.displayWidth=a(),e.originalHeight=e.displayHeight=a();let y=a();for(let t=0;t<y;++t)s[t+1]=h();for(let t=o();t>0;--t)e.masks[d()]=d();e.rootGroups=u(o,d);let m=a();for(let t=0;t<m;++t){let i=s[t+1];PathCtr.debugPrint("count : "+t),PathCtr.debugPrint(i),PathCtr.debugPrint(r),e.groups[i]=k(),PathCtr.debugPrint(e.groups[i])}return e},dataTobin:function(t){if(!t)return console.error("path container is not found"),null;let e=new ArrayBuffer(1e9),i=new DataView(e),r=0,s={"":0},o=t=>{i.setUint8(r,t),r+=1},a=t=>{i.setUint16(r,t),r+=2},n=t=>{i.setFloat32(r,t),r+=4},l=t=>{i.setInt16(r,t*this.binDataPosRange),r+=2},h=t=>{o(t.length);[].map.call(t,t=>a(t.charCodeAt(0)))},c=t=>{if("transparent"==t)o(0);else{let e=t.match(/(\d+), (\d+), (\d+)/);o(1),o(e[1]),o(e[2]),o(e[3])}},u=(t,e,i)=>{let r=t.length;e(r);for(let e=0;e<r;){let s=t[e],o=1;if(void 0!==s){for(;o<r&&(void 0!==t[e+o]&&JSON.stringify(s)==JSON.stringify(t[e+o]));++o);a(o),e+=o,i(s)}else{for(a(0);o<r&&void 0===t[e+o];++o);a(o),e+=o}}},d=(t,e)=>{u(t,o,t=>{u(t,a,e)})},p=t=>a(s[t]),f=t=>{a(t.length),t.forEach(t=>{switch(t.type){case"M":o(0),l(t.pos[0]),l(t.pos[1]);break;case"C":o(1);for(let e=0;e<6;++e)l(t.pos[e]);break;case"Z":o(2);break;default:console.error("unknown type"),console.log(t)}})},g=t=>{if(p(t.maskIdToUse),o("nonzero"==t.fillRule?0:1),!t.actionList)return o(0),n(t.lineWidth),c(t.fillStyle),c(t.strokeStyle),void f(t.pathDataList);o(Object.keys(t.actionList).length),Object.keys(t.actionList).forEach(e=>{h(e),o(t.actionList[e])}),d(t.lineWidth,n),d(t.fillStyle,c),d(t.strokeStyle,c),d(t.pathDataList,f)};a(t.originalWidth),a(t.originalHeight);let k=Object.keys(t.groups).length,y=Object.keys(t.masks).length;return a(k+y),Object.keys(t.groups).forEach(t=>{s[t]=Object.keys(s).length,h(t)}),Object.keys(t.masks).forEach(t=>{s[t]=Object.keys(s).length,h(t)}),o(y),Object.keys(t.masks).forEach(e=>{p(e),p(t.masks[e])}),u(t.rootGroups,o,p),a(k),Object.keys(t.groups).forEach(e=>{console.log("count : "+k--),PathCtr.debugPrint(e),PathCtr.debugPrint(r),(t=>{if(p(t.id),p(t.maskIdToUse),u(t.paths,a,g),!t.actionList)return o(0),void u(t.childGroups,o,p);o(Object.keys(t.actionList).length),Object.keys(t.actionList).forEach(e=>{h(e),o(t.actionList[e])}),d(t.childGroups,t=>{u(t,o,p)})})(t.groups[e]),PathCtr.debugPrint(t.groups[e])}),e.slice(0,r)}};PathCtr.PathObj.prototype={addAction:function(t,e,i,r,s,o,a){if(!a)return void console.error("please specify a action name");if(this.actionList||(this.pathDataList=[[this.pathDataList]],this.fillStyle=[[this.fillStyle]],this.lineWidth=[[this.lineWidth]],this.strokeStyle=[[this.strokeStyle]],this.actionList={},this.actionList[PathCtr.defaultAction]=0),!this.actionList.hasOwnProperty(a)){let t=Object.keys(this.actionList).length;this.actionList[a]=t,this.pathDataList[t]=[this.pathDataList[0][0]],this.fillStyle[t]=[this.fillStyle[0][0]],this.lineWidth[t]=[this.lineWidth[0][0]],this.strokeStyle[t]=[this.strokeStyle[0][0]]}let n=this.actionList[a];this.pathDataList[n][o]=t,this.fillStyle[n][o]=i,this.lineWidth[n][o]=r,this.strokeStyle[n][o]=s},draw:function(t,e,i,r,s){let o=i=>{let s=i.pos,o=t,a=e;switch(i.type){case"M":r.moveTo(s[0]*o,s[1]*a);break;case"C":r.bezierCurveTo(s[0]*o,s[1]*a,s[2]*o,s[3]*a,s[4]*o,s[5]*a);break;case"Z":r.closePath();break;default:console.error("unknown type")}},a=(t,e)=>{t&&(i.lineWidth=t,i.strokeStyle=e,i.stroke(r))},n=t=>{i.fillStyle=t,i.fill(r,this.fillRule)};if(this.actionList){let t=this.actionList[PathCtr.currentActionName];if(t||(t=0),frame=Math.min(PathCtr.currentFrame,this.lineWidth[t].length),this.pathDataList[t][frame].forEach(o),s)return;return a(this.lineWidth[t][frame],this.strokeStyle[t][frame]),void n(this.fillStyle[t][frame])}this.pathDataList.forEach(o),s||(a(this.lineWidth,this.strokeStyle),n(this.fillStyle))}},PathCtr.GroupObj.prototype={addAction:function(t,e,i){if(!i)return void console.error("please specify a action name");if(0==t.length)return;if(this.actionList||(this.childGroups=[[this.childGroups]],this.actionList={},this.actionList[PathCtr.defaultAction]=0),!this.actionList.hasOwnProperty(i)){let t=Object.keys(this.actionList).length;this.actionList[i]=t,this.childGroups[t]=[],this.childGroups[t][0]=this.childGroups[0][0].concat()}let r=this.actionList[i];this.childGroups[r][e]=t},getChildGroups:function(){if(0==this.childGroups.length)return this.childGroups;if(!this.actionList)return this.childGroups;let t=this.actionList[PathCtr.currentActionName];return this.childGroups[t]?this.childGroups[t][PathCtr.currentFrame]:this.childGroups[0][0]}},PathCtr.PathContainer.prototype={setFitSize:function(t,e){t>=e?(this.displayWidth=t,this.displayHeight=t*this.originalHeight/this.originalWidth):(this.displayWidth=e*this.originalWidth/this.originalHeight,this.displayHeight=e)},getMaskGroup:function(t){let e=this.masks[t];return e?this.groups[e]:(console.error("mask is not found : "+t),null)},drawGroup:function(t,e){if(!this.context)return void console.error("context is not found");let i=!1;if(!e&&t.maskIdToUse){let e=this.getMaskGroup(t.maskIdToUse);e?(i=!0,this.context.save(),this.drawGroup(e,!0)):console.error("group is not found : "+t.maskIdToUse)}let r=e?new Path2D:0,s=!1;t.paths.forEach(t=>{s=!0;let i=!1;if(!e&&t.maskIdToUse){let e=this.getMaskGroup(t.maskIdToUse);e?(i=!0,this.context.save(),this.drawGroup(e,!0)):console.error("mask is not found : "+t.maskIdToUse)}e||(r=new Path2D),t.draw(this.displayWidth,this.displayHeight,this.context,r,e),i&&this.context.restore()});let o=t.getChildGroups();o&&o.forEach(t=>{this.drawGroup(this.groups[t],e)}),e&&s&&this.context.clip(r),i&&this.context.restore()},draw:function(t,e=PathCtr.defaultAction){if(!this.rootGroups)return void console.error("root groups is not found");PathCtr.currentFrame=t,PathCtr.currentActionName=e;let i=new Path2D;i.rect(0,0,this.displayWidth,this.displayHeight),this.context.clip(i),this.rootGroups.forEach(t=>{this.drawGroup(this.groups[t],!1)})}};