var PathCtr={isOutputDebugPrint:!1,debugPrint:function(){if(this.isOutputDebugPrint)for(let t=0;t<arguments.length;++t)console.log(arguments[t])},isOutputLoadState:!0,loadState:function(){if(this.isOutputLoadState)for(let t=0;t<arguments.length;++t)console.log(arguments[t])},defaultCanvasContainerID:"path-container",defaultActionName:"base",initTarget:null,binDataPosRange:2e4,pathContainer:null,canvas:null,context:null,viewWidth:0,viewHeight:0,requestAnimationIDs:[],setTimeoutIDs:[],cancelRequestAnimation:function(){(this.requestAnimationIDs.length>1||this.setTimeoutIDs.length>1)&&PathCtr.debugPrint("requestAnimationIDs:"+this.requestAnimationIDs.length+", "+this.setTimeoutIDs.length),this.requestAnimationIDs.forEach(cancelAnimationFrame),this.requestAnimationIDs.length=0,this.setTimeoutIDs.forEach(clearTimeout),this.setTimeoutIDs.length=0},setSize:function(t,e){this.canvas.width=this.viewWidth=t,this.canvas.height=this.viewHeight=e,this.pathContainer&&this.pathContainer.setSize(t,e)},loadComplete:function(t){this.pathContainer=this.initTarget,this.pathContainer.context=this.context,this.setSize(this.viewWidth,this.viewHeight),this.initTarget=null},init:function(t,e,i){if(!t)return void console.error("canvas is not found.");if(this.canvas=t,this.context=t.getContext("2d"),!this.context)return void console.error("context is not found.");t.width=this.viewWidth=e,t.height=this.viewHeight=i;let s=1/24,a=0,r=0,o=0,n=new Event("update");addEventListener("update",t=>{this.pathContainer.update(a,"walk")});let h=t=>{if(void 0!==DebugPath&&DebugPath.isStop){if(!DebugPath.isStep)return;DebugPath.isStep=!1,console.log("--STEP--")}if(void 0===t)return;o=(o+(t-r)/1e3)/2,r=t,this.debugPrint(1e5*o^0),this.pathContainer&&(this.context.clearRect(0,0,this.viewWidth,this.viewHeight),this.pathContainer.draw(),a=a%260+1,o>1/24*2?(s*=.99,this.debugPrint("up")):o<1/24*.5?(s*=1.01,this.debugPrint("down")):s=(1/24+s)/2,dispatchEvent(n))},l=()=>{this.cancelRequestAnimation(),this.requestAnimationIDs.push(requestAnimationFrame(h)),this.setTimeoutIDs.push(setTimeout(l,1e3*s))};this.setTimeoutIDs.push(setTimeout(l,1e3*s))}};class Matrix{constructor(){this.a=1,this.b=0,this.c=0,this.d=1,this.e=0,this.f=0}reset(){return this.a=this.d=1,this.b=this.c=this.e=this.f=0,this}applyToPoint(t,e=0){let i=t[e],s=t[e+1];t[e]=i*this.a+s*this.c+this.e,t[e+1]=i*this.b+s*this.d+this.f}applyToArray(t,e=0){let i=t.length;for(let s=e;s<i;s+=2)this.applyToPoint(t,s)}setMatrix(t){return this.a=t.a,this.b=t.b,this.c=t.c,this.d=t.d,this.e=t.e,this.f=t.f,this}interpolate(t,e){let i=new Matrix;return i.a=this.a+(t.a-this.a)*e,i.b=this.b+(t.b-this.b)*e,i.c=this.c+(t.c-this.c)*e,i.d=this.d+(t.d-this.d)*e,i.e=this.e+(t.e-this.e)*e,i.f=this.f+(t.f-this.f)*e,i}mult(t){let e=new Matrix;return e.a=this.a*t,e.b=this.b*t,e.c=this.c*t,e.d=this.d*t,e.e=this.e*t,e.f=this.f*t,e}multAndAddPoint(t,e,i,s,a){s[a]+=(e*this.a+i*this.c+this.e)*t,s[a+1]+=(e*this.b+i*this.d+this.f)*t}setTransform(t,e,i,s,a,r){return this.a=t,this.b=e,this.c=i,this.d=s,this.e=a,this.f=r,this}transform(t,e,i,s,a,r){let o=this.a,n=this.b,h=this.c,l=this.d,c=this.e,u=this.f;return this.a=o*t+h*e,this.b=n*t+l*e,this.c=o*i+h*s,this.d=n*i+l*s,this.e=o*a+h*r+c,this.f=n*a+l*r+u,this}rotate(t){let e=Math.cos(t),i=Math.sin(t);return this.transform(e,i,-i,e,0,0)}scale(t,e=t){return this.transform(t,0,0,e,0,0)}scaleX(t){return this.transform(t,0,0,1,0,0)}scaleY(t){return this.transform(1,0,0,t,0,0)}skew(t,e){return this.transform(1,e,t,1,0,0)}skewX(t){return this.transform(1,0,t,1,0,0)}skewY(t){return this.transform(1,t,0,1,0,0)}translate(t,e){return this.transform(1,0,0,1,t,e)}translateX(t){return this.transform(1,0,0,1,t,0)}translateY(t){return this.transform(1,0,0,1,0,t)}}class Sprite{constructor(){this.m=new Matrix,this.x=0,this.y=0,this.anchorX=0,this.anchorY=0,this.scaleX=1,this.scaleY=1,this.rotation=0}reset(){this.x=0,this.y=0,this.anchorX=0,this.anchorY=0,this.scaleX=1,this.scaleY=1,this.rotation=0}clone(){let t=new Sprite;return t.x=this.x,t.y=this.y,t.anchorX=this.anchorX,t.anchorY=this.anchorY,t.scaleX=this.scaleX,t.scaleY=this.scaleY,t.rotation=this.rotation,t}setSprite(t){return this.x=t.x,this.y=t.y,this.anchorX=t.anchorX,this.anchorY=t.anchorY,this.scaleX=t.scaleX,this.scaleY=t.scaleY,this.rotation=t.rotation,this}addSprite(t){return this.x+=t.x,this.y+=t.y,this.anchorX+=t.anchorX,this.anchorY+=t.anchorY,this.scaleX*=t.scaleX,this.scaleY*=t.scaleY,this.rotation=t.rotation,this}compSprite(t){let e=new Sprite;return e.x=this.x+t.x,e.y=this.y+t.y,e.anchorX=this.anchorX+t.anchorX,e.anchorY=this.anchorY+t.anchorY,e.scaleX=this.scaleX*t.scaleX,e.scaleY=this.scaleY*t.scaleY,e.rotation=this.rotation+t.rotation,e}getMatrix(t=0,e=0){return this.m.reset().translate(this.x+t,this.y+e).rotate(this.rotation).scale(this.scaleX,this.scaleY).translate(-this.anchorX-t,-this.anchorY-+e)}}class ActionContainer{constructor(t,e){this.data=t,this.checkFunc=e,this.hasAction=Array.isArray(t)&&t.some(t=>Array.isArray(t)&&t.some(e)),this.result=this.hasAction?t[0][0]:t}setData(t,e=0,i=0){this.hasAction?this.addAction(t,e,i):(this.data=t,this.hasAction=Array.isArray(t)&&t.some(t=>Array.isArray(t)&&t.some(this.checkFunc)),this.result=this.hasAction?t[0][0]:t)}addAction(t,e,i){if(!this.hasAction){if(JSON.stringify(this.data)==JSON.stringify(t))return;this.data=[[this.data]],this.hasAction=!0}void 0===this.data[e]&&(this.data[e]=[this.data[0][0].concat()]);let s=!0;for(let a=this.data[e].length-1;a>=0;--a)if(void 0!==this.data[e][a]){if(JSON.stringify(t)==JSON.stringify(this.data[e][a]))break;this.data[e][i]=t,s=!1;break}s&&(this.data[e][i]=void 0)}hasActionID(t){return!!this.hasAction&&void 0!==this.data[t]}getData(t=0,e=0){return this.hasAction?this.data[t][Math.min(e,this.data[t].length-1)]:this.data}getAvailableData(t=0,e=0){if(!this.hasAction)return this.data;if(!this.hasActionID(t))return this.data[0][0];for(let i=e;i>=0;--i){let e=this.getData(t,i);if(null!=e)return e}}update(t,e=0,i=0){if(!this.hasAction)return;this.hasActionID(e)||(e=0,i=0);let s=this.getData(e,i);this.data.forEach((e,i)=>{let a=t.actionList[i],r=a.pastFrame,o=a.currentFrame;if(r!=o)if(r<=o)for(let t=Math.min(o,e.length-1);t>=r;--t){let i=e[t];if(null!=i){s=i;break}}else for(let t=Math.min(r,e.length-1);t>=o;--t){if(null!=e[t]){for(let t=Math.min(o,e.length-1);t>=0;--t){let i=e[t];if(null!=i){s=i;break}}break}}}),s&&(this.result=s)}}class PathObj{constructor(t,e,i,s,a,r,o){this.maskIdToUse=t,this.fillRule=s,this.pathDiffList=new ActionContainer(i,t=>Array.isArray(t)&&t.some(t=>Array.isArray(t))),this.fillStyle=new ActionContainer(a,t=>"string"==typeof t),this.lineWidth=new ActionContainer(r,t=>Number.isFinite(t)),this.strokeStyle=new ActionContainer(o,t=>"string"==typeof t),this.resultPathList=e,this.defPathList=e}addAction(t,e,i,s,a,r){t?this.defPathList.length!=t.length&&(console.error("The number of paths does not match."),console.log(this.defPathList),console.log(t),t=this.defPathList.slice()):t=this.defPathList.slice();let o=[];this.defPathList.forEach((e,i)=>{if(e.type!=t[i].type)return console.error("type does not match."),console.log(this.defPathList),void console.log(t);e.pos&&(o[i]=[],e.pos.forEach((e,s)=>{o[i].push(t[i].pos[s]-e)}))}),this.pathDiffList.addAction(o,r,a),this.fillStyle.addAction(e,r,a),this.lineWidth.addAction(i,r,a),this.strokeStyle.addAction(s,r,a)}getPathDataList(t=0,e=0){let i=[];return(t=>(this.defPathList.forEach((e,s)=>{i.push({type:e.type,pos:e.pos?e.pos.map((e,i)=>e+t[s][i]):void 0})}),i))(this.pathDiffList.getAvailableData(e,t))}getMergePathDataList(t,e=0,i=0){let s=[],a=t=>(this.defPathList.forEach((e,i)=>{s.push({type:e.type,pos:e.pos?e.pos.map((e,s)=>e+t[i][s]):void 0})}),s);if(!this.pathDiffList.hasAction)return a(this.pathDiffList.getData());this.pathDiffList.hasActionID(i)||(i=0,e=0);let r=a(this.pathDiffList.getAvailableData(i,e));return 1==t.actionList.length?r:(t.actionList.forEach(t=>{i!=t.id&&this.pathDiffList.hasActionID(t.id)&&this.pathDiffList.getAvailableData(t.id,t.currentFrame).forEach((t,e)=>{t&&t.forEach((t,i)=>{t&&(r[e].pos[i]+=t)})})}),r)}update(t,e,i,s){let a=this.getMergePathDataList(i,t,e);a.forEach(t=>{t.pos&&s.applyToArray(t.pos)}),this.resultPathList=a,this.fillStyle.update(i,e,t),this.lineWidth.update(i,e,t),this.strokeStyle.update(i,e,t)}draw(t,e,i,s){this.resultPathList.forEach(e=>{let s=e.pos,a=t.pathRatio;switch(e.type){case"M":i.moveTo(s[0]*a,s[1]*a);break;case"L":i.lineTo(s[0]*a,s[1]*a);break;case"C":i.bezierCurveTo(s[0]*a,s[1]*a,s[2]*a,s[3]*a,s[4]*a,s[5]*a);break;case"Z":i.closePath();break;default:console.error("unknown type")}}),s||(this.lineWidth.result&&(e.lineJoin="round",e.lineCap="round",e.lineWidth=this.lineWidth.result,e.strokeStyle=this.strokeStyle.result,e.stroke(i)),e.fillStyle=this.fillStyle.result,e.fill(i,this.fillRule))}debugDraw(t,e){let i=2*Math.PI,s=(t,s)=>{if(!DebugPath.isShowPoints)return;let a=new Path2D;a.arc(t,s,DebugPath.pointSize,0,i),e.fillStyle=DebugPath.pointColor,e.fill(a,"nonzero")};this.resultPathList.forEach(a=>{let r=a.pos,o=t.pathRatio;switch(a.type){case"M":case"L":s(r[0]*o,r[1]*o);break;case"C":((t,s,a,r)=>{if(!DebugPath.isShowControls)return;let o=new Path2D;o.arc(t,s,DebugPath.controlSize,0,i),o.arc(a,r,DebugPath.controlSize,0,i),e.fillStyle=DebugPath.controlColor,e.fill(o,"nonzero")})(r[0]*o,r[1]*o,r[2]*o,r[3]*o),s(r[4]*o,r[5]*o);break;case"Z":break;default:console.error("unknown type")}})}}class GroupObj extends Sprite{constructor(t,e,i,s,a){super(),this.visible=!0,this.uid=t,this.id=e,this.paths=i,this.childGroups=new ActionContainer(s,t=>Array.isArray(t)&&t.some(t=>Number.isFinite(t))),this.maskIdToUse=a,this.flexi=[]}addAction(t,e,i){this.childGroups.addAction(t,i,e)}setFlexiBones(t,e){e&&Array.isArray(e)&&0!=e.length&&(PathCtr.loadState("GROUP:"+this.id),this.flexi.length=0,e.forEach(e=>{let i=t.getBone(e);i&&(PathCtr.loadState("  flexi:"),this.flexi.push(i.uid),PathCtr.loadState("    "+e))}))}preprocessing(t){this.reset()}update(t,e,i=[]){let s=t.currentActionID,a=t.actionList[s].currentFrame,r=e.compSprite(this),o=i.concat(this.flexi),n=r.getMatrix();this.paths.forEach(e=>{e.update(a,s,t,n)});this.childGroups.update(t,s,a);this.childGroups.result.forEach(e=>{t.groups[e].update(t,r,o)}),o.length>0&&this.paths.forEach(e=>{e.resultPathList.forEach(e=>{if(!e.pos||0==e.pos.length)return;let i=e.pos,s=i.length;for(let e=0;e<s;e+=2){if(1==o.length){let s=o[0];if(0==t.groups[s].strength)continue;t.groups[s].effectSprite.getMatrix().applyToPoint(i,e);continue}let s=i[e],a=i[e+1],r=[],n=0;o.forEach(e=>{let i=t.groups[e].calc(s,a);n+=i,r.push(i)}),0!=n&&(i[e]=0,i[e+1]=0,o.forEach((o,h)=>{t.groups[o].effectSprite.getMatrix().multAndAddPoint(1-r[h]/n,s,a,i,e)}))}})})}draw(t,e,i=!1){if(!this.visible)return;let s=!1;if(!i&&this.maskIdToUse){let i=t.groups[this.maskIdToUse];i?(s=!0,e.save(),i.draw(t,e,!0)):console.error("group is not found : "+this.maskIdToUse)}let a=i?new Path2D:null,r=!1;this.paths.forEach(s=>{r=!0;let o=!1;if(!i&&s.maskIdToUse){let i=t.groups[s.maskIdToUse];i?(o=!0,e.save(),i.draw(t,e,!0)):console.error("mask is not found : "+s.maskIdToUse)}i||(a=new Path2D),s.draw(t,e,a,i),o&&e.restore()}),this.childGroups.result.forEach(s=>{t.groups[s].draw(t,e,i)}),i&&r&&e.clip(a),a=null,s&&e.restore()}debugDraw(t,e){if(this.visible){if(this.maskIdToUse){let i=t.groups[this.maskIdToUse];i?i.debugDraw(t,e):console.error("group is not found : "+this.maskIdToUse)}this.paths.forEach(i=>{if(i.maskIdToUse){let s=t.groups[i.maskIdToUse];s?s.debugDraw(t,e):console.error("mask is not found : "+i.maskIdToUse)}i.debugDraw(t,e)}),this.childGroups.result.forEach(i=>{t.groups[i].debugDraw(t,e)})}}}class BoneObj extends Sprite{constructor(t,e,i,s){super(),this.visible=!0,this.uid=t,this.id=e,this.paths=i,this.childGroups=s,this.parentID=-1,this.isParentPin=!1,this.feedback=!1,this.strength=0,this.effectSprite=new Sprite,this.isReady=!1,i&&i.length>0&&BoneObj.setPath(this,i[0])}static setPath(t,e){let i=e.getPathDataList(),s=i[0].pos[0],a=i[0].pos[1],r=i[1].pos[0],o=i[1].pos[1],n=r-s,h=o-a,l=Math.sqrt(n*n+h*h),c=Math.atan2(h,n);t.defState={x0:s,y0:a,x1:r,y1:o,distance:l,angle:c},t.currentState={pos:[s,a,r,o],distance:l,angle:c}}setJSONData(t,e){if(!t||!e)return;PathCtr.loadState("BONE:"+this.id);let i=t.getBone(e.parent);"parent"in e&&i&&(this.parentID=i.uid,PathCtr.loadState("  parentID:"+this.parentID+"("+e.parent+")")),"isParentPin"in e&&"boolean"==typeof e.isParentPin&&(this.isParentPin=e.isParentPin,PathCtr.loadState("  isParentPin:"+this.isParentPin)),"feedback"in e&&"boolean"==typeof e.feedback&&(this.feedback=e.feedback,PathCtr.loadState("  feedback:"+this.feedback)),"strength"in e&&Number.isFinite(e.strength)&&(this.strength=e.strength,PathCtr.loadState("  strength:"+this.strength)),"isSmartBone"in e&&"boolean"==typeof e.isSmartBone&&(this.isSmartBone=e.isSmartBone,PathCtr.loadState("  isSmartBone:"+this.isSmartBone)),"smartBase"in e&&Number.isFinite(e.smartBase)&&(this.smartBase=e.smartBase/180*Math.PI,PathCtr.loadState("  smartBase:"+this.smartBase)),"smartMax"in e&&Number.isFinite(e.smartMax)&&(this.smartMax=e.smartMax/180*Math.PI,PathCtr.loadState("  smartMax:"+this.smartMax))}getSmartFrame(t){if(!this.isSmartBone)return console.error("It is not bone: "+this.id),0;let e=-this.currentState.angle;return(e-=this.smartBase)<0&&(e+=2*Math.PI),e>this.smartMax&&(e=this.smartMax),1+(e/this.smartMax*(t-2)^0)}preprocessing(t){if(this.reset(),!this.defState)return;let e=this.paths[0].getPathDataList(t.actionList[t.currentActionID].currentFrame,t.currentActionID);if(2!=e.length)return void(this.isReady=!0);this.isReady=!1;let i=this.currentState.pos,s=i[0]=e[0].pos[0],a=i[1]=e[0].pos[1],r=(i[2]=e[1].pos[0])-s,o=(i[3]=e[1].pos[1])-a;this.currentState.distance=Math.sqrt(r*r+o*o),this.currentState.angle=Math.atan2(o,r),this.x=this.anchorX=this.defState.x0,this.y=this.anchorY=this.defState.y0}control(t){}diff(t){if(!this.defState||this.isReady)return;this.isReady=!0,this.effectSprite.reset();let e=this.currentState.pos,i=this.parentID;for(;i>=0;){let s=t.groups[i];if(s.diff(t),this.isParentPin){let t=s.x-s.anchorX,i=s.y-s.anchorY;e[0]+=t,e[1]+=i,e[2]+=t,e[3]+=i}else s.getMatrix().applyToArray(e);i=s.parentID}this.getMatrix().applyToArray(e);let s=this.effectSprite.x=e[0],a=this.effectSprite.y=e[1],r=e[2]-s,o=e[3]-a,n=this.currentState.distance=Math.sqrt(r*r+o*o),h=this.currentState.angle=Math.atan2(o,r);this.effectSprite.anchorX=this.defState.x0,this.effectSprite.anchorY=this.defState.y0,this.effectSprite.scaleY=n/this.defState.distance,this.effectSprite.rotation=h-this.defState.angle}calc(t,e){let i=this.strength;if(0==i)return 0;this.currentState.pos;let s=this.defState.x0,a=this.defState.y0,r=this.defState.x1,o=this.defState.y1,n=r-s,h=o-a,l=n*n+h*h,c=-(n*(s-t)+h*(a-e)),u=0;if(c<0)u=(s-t)*(s-t)+(a-e)*(a-e);else if(c>l)u=(r-t)*(r-t)+(o-e)*(o-e);else{let i=n*(a-e)-h*(s-t);u=i*i/l}return u*i}update(){}draw(){}debugDraw(t,e){if(!this.visible||!DebugPath.isShowBones)return;let i=t.pathRatio,s=2*Math.PI;this.paths.forEach(t=>{let a=this.currentState.pos,r=a[0]*i,o=a[1]*i,n=a[2]*i,h=a[3]*i;e.lineJoin="round",e.lineCap="round";let l=new Path2D;l.arc(r,o,DebugPath.bonePointSize,0,s),l.moveTo(r,o),l.lineTo(n,h),e.lineWidth=DebugPath.boneLineSize,e.strokeStyle=DebugPath.boneColor,e.stroke(l);let c=this.strength*i;(l=new Path2D).arc(r,o,c,0,s),l.arc(n,h,c,0,s),e.fillStyle=DebugPath.strengthPointColor,e.fill(l,"nonzero"),(l=new Path2D).moveTo(r,o),l.lineTo(n,h),e.lineWidth=2*c,e.strokeStyle=DebugPath.strengthLineColor,e.stroke(l),l=null}),this.childGroups.forEach(i=>{t.groups[i].debugDraw(t,e)})}}class PathContainer extends Sprite{constructor(t,e){super(),this.visible=!0,this.originalWidth=t,this.originalHeight=e,this.displayWidth=t,this.displayHeight=e,this.pathRatio=0,this.context=null,this.rootGroups=[],this.groups=[],this.bones=[],this.actionList=[],this.currentActionID=-1}getGroup(t){return this.groups.find(e=>e.id==t)}getBone(t){let e=this.getGroup(t);if(e&&this.bones.includes(e.uid))return this.groups[e.uid]}getAction(t){return this.actionList.find(e=>e.name==t)}addAction(t,e,i){return e<0&&(e=this.actionList.length),this.actionList[e]={name:t,id:e,totalFrames:i,pastFrame:0,currentFrame:0}}setSize(t,e){this.originalWidth>this.originalHeight?(this.displayWidth=t,this.displayHeight=t*this.originalHeight/this.originalWidth,this.pathRatio=t):(this.displayWidth=e*this.originalWidth/this.originalHeight,this.displayHeight=e,this.pathRatio=e)}update(t,e=PathCtr.defaultActionName){if(!this.visible||!this.rootGroups)return;let i=this.getAction(e);i?(i.pastFrame=i.currentFrame,i.currentFrame=t,this.currentActionID=i.id,this.groups.forEach(t=>{t.preprocessing(this)}),this.bones.forEach(t=>{let e=this.groups[t];e.control(this),e.diff(this)}),this.actionList.forEach(t=>{t.smartBoneID&&(t.pastFrame=t.currentFrame,t.currentFrame=this.groups[t.smartBoneID].getSmartFrame(t.totalFrames))}),this.rootGroups.forEach(t=>{this.groups[t].update(this,(new Sprite).setSprite(this))})):console.error("target action is not found: "+e)}draw(){this.visible&&this.rootGroups&&(this.context?(this.rootGroups.forEach(t=>{this.groups[t].draw(this,this.context)}),void 0!==DebugPath&&DebugPath.isDebugDraw()&&this.rootGroups.forEach(t=>{this.groups[t].debugDraw(this,this.context)})):console.error("context is not found"))}}var BinaryLoader={init:function(t){if(!t)return console.error("array buffer is not found"),null;let e=new DataView(t),i=0,s=()=>{let t=e.getUint8(i);return i+=1,t},a=()=>{let t=e.getUint16(i);return i+=2,t},r=()=>{let t=e.getFloat32(i);return i+=4,t},o=()=>{let t=e.getInt16(i)/PathCtr.binDataPosRange;return i+=2,t},n=()=>{let t=s(),e="";for(let i=0;i<t;++i)e+=String.fromCharCode(a());return e},h=()=>0==s()?"transparent":"rgb("+s()+", "+s()+", "+s()+")",l=(t,e)=>{let i=Array(t()),s=i.length;for(let t=0;t<s;){let s=a();if(0==s){if(0==(s=a())){console.error("data format error");break}t+=s;continue}let r=e();if(Array.isArray(r))for(let e=0;e<s;++e)i[t+e]=r.concat();else for(let e=0;e<s;++e)i[t+e]=r;t+=s}return i},c=t=>s()?l(s,()=>l(a,()=>t())):t(),u=()=>l(a,()=>l(a,o)),d=()=>{let t=a()-1;t<0&&(t=null);let e=0==s()?"nonzero":"evenodd",i=(()=>{let t=a(),e=[];for(let i=0;i<t;++i){let t=s();switch(t){case 0:e.push({type:"M",pos:[o(),o()]});break;case 1:e.push({type:"L",pos:[o(),o()]});break;case 2:e.push({type:"C",pos:[o(),o(),o(),o(),o(),o()]});break;case 3:e.push({type:"Z"});break;default:console.error("unknown type : "+t)}}return e})(),n=c(r),l=c(h),d=c(h),p=c(u);return new PathObj(t,i,p,e,l,n,d)},p=t=>{let e=n(),i=a()-1;i<0&&(i=null);let r=l(a,d);return e.startsWith(PathCtr.defaultBoneName)?new BoneObj(t,e,r,l(s,a)):new GroupObj(t,e,r,c(()=>l(s,a)),i)},f=PathCtr.initTarget=new PathContainer(a(),a()),g=s();if(g>0)for(let t=0;t<g;++t)f.addAction(n(),s(),a());f.rootGroups=l(s,a);let b=a();for(let t=0;t<b;++t){PathCtr.debugPrint("count : "+t),PathCtr.debugPrint(t),PathCtr.debugPrint(i);let e=p(t);f.groups[t]=e,BoneObj.prototype.isPrototypeOf(e)&&f.bones.push(e.uid),PathCtr.debugPrint(e)}return f},load:function(t,e=null){if(!t)return void console.error("filePath not found");let i=new XMLHttpRequest;i.onload=function(t){let s=t.target;if(4!=s.readyState)return;if(200!=s.status&&0!=s.status)return;let a=i.response,r=BinaryLoader.init(a);PathCtr.loadState("loading completed"),PathCtr.loadState(r),PathCtr.loadComplete(r),e&&e()},i.open("GET",t,!0),i.responseType="arraybuffer",i.send()}},BoneLoader={load:function(t,e){let i=new XMLHttpRequest;i.onload=function(t){let i=t.target;if(4!=i.readyState)return;if(200!=i.status&&0!=i.status)return;let s=JSON.parse(i.responseText);s.bones&&Object.keys(s.bones).forEach(t=>{let i=e.getBone(t);i?i.setJSONData(e,s.bones[t]):console.error("bone is not found : "+t)}),s.flexi&&Object.keys(s.flexi).forEach(t=>{let i=e.getGroup(t);i?i.setFlexiBones(e,s.flexi[t]):console.error("group is not found : "+t)}),s.smartAction&&Object.keys(s.smartAction).forEach(t=>{let i=e.actionList.find(e=>e.name==t);if(!i)return void console.error("smart action is not found : "+t);let a=s.smartAction[t],r=e.getBone(a);r?(i.smartBoneID=r.uid,PathCtr.loadState("smartAction: "+t+" - "+a)):console.error("smart bone is not found : "+a)}),PathCtr.loadState("bones JSON load complete."),PathCtr.loadState(e)},i.open("GET",t,!0),i.send()}};addEventListener("message",function(t){let e=t.data;switch(e.cmd){case"init":PathCtr.defaultBoneName=e.defaultBoneName,PathCtr.init(e.canvas,e.viewWidth,e.viewHeight);break;case"load-bin":BinaryLoader.load(e.path,()=>{postMessage({cmd:"init-complete"})});break;case"load-bone":BoneLoader.load(e.path,PathCtr.pathContainer);break;case"resize-canvas":PathCtr.setSize(e.viewWidth,e.viewHeight);break;case"move-mouse":void 0!==DebugPath&&DebugPath.moveMouse(PathCtr.pathContainer,e.x,e.y);break;case"keyup":void 0!==DebugPath&&DebugPath.keyUp(PathCtr.pathContainer,e.code);break;case"output-path-container":DebugPath.outputJSON(PathCtr.pathContainer);break;case"output-bin":DebugPath.outputBin(PathCtr.pathContainer);break;case"create-path-container":PathCtr.loadState("init path container"),PathCtr.initTarget=new PathContainer(e.width,e.height);break;case"add-action":PathCtr.loadState("load action: "+e.actionName+" - "+e.totalFrames),PathCtr.initTarget.addAction(e.actionName,e.frame,e.totalFrames);break;case"add-root-group":PathCtr.initTarget.rootGroups.push(e.id);break;case"new-group":PathCtr.initTarget.groups[e.uid]=new GroupObj(e.uid,e.name,[],[],e.maskID);break;case"new-bone":PathCtr.initTarget.groups[e.uid]=new BoneObj(e.uid,e.name,[],[]),PathCtr.initTarget.bones.push(e.uid);break;case"add-group-action":PathCtr.initTarget.bones.includes(e.uid)||PathCtr.initTarget.groups[e.uid].addAction(e.childGroups,e.frame,PathCtr.initTarget.getAction(e.actionName).id);break;case"set-child-group-id":PathCtr.initTarget.bones.includes(e.uid)?PathCtr.initTarget.groups[e.uid].childGroups=e.childGroups:PathCtr.initTarget.groups[e.uid].childGroups.setData(e.childGroups);break;case"new-path":PathCtr.initTarget.groups[e.uid].paths.push(new PathObj(e.maskID,e.pathDataList,e.pathDiffList,e.fillRule,e.fillStyle,e.lineWidth,e.strokeStyle));break;case"new-bone-path":if(PathCtr.initTarget.groups[e.uid].paths.push(new PathObj(null,e.pathDataList,e.pathDiffList,"nonzero","transparent",2,"rgb(0, 255, 0)")),1==PathCtr.initTarget.groups[e.uid].paths.length){let t=PathCtr.initTarget.groups[e.uid];BoneObj.setPath(t,t.paths[0])}break;case"add-path-action":PathCtr.initTarget.groups[e.uid].paths[e.pathID].addAction(e.pathDataList,e.fillStyle,e.lineWidth,e.strokeStyle,e.frame,PathCtr.initTarget.getAction(e.actionName).id);break;case"add-bone-path-action":PathCtr.initTarget.groups[e.uid].paths[e.pathID].addAction(e.pathDataList,"transparent",2,"rgb(0, 255, 0)",e.frame,PathCtr.initTarget.getAction(e.actionName).id);break;case"set-unvisible-path-action":PathCtr.initTarget.groups[e.uid].paths.forEach(t=>{t.addAction(null,"transparent",0,"transparent",e.frame,PathCtr.initTarget.getAction(e.actionName).id)});break;case"load-complete":PathCtr.loadComplete(),postMessage({cmd:"init-complete"});break;default:console.error("unknown command: "+e.cmd)}},!1);var DebugPath={isStop:!1,isStep:!1,isShowBones:!1,bonePointSize:2,boneLineSize:2,boneColor:"rgb(0, 255, 0)",strengthPointColor:"rgba(0, 255, 0, 0.005)",strengthLineColor:"rgba(0, 255, 0, 0.2)",isShowPoints:!1,pointSize:2,pointColor:"rgb(255, 0, 0)",isShowControls:!1,controlSize:1,controlColor:"rgb(255, 255, 0)",moveMouse:function(t,e,i){if(!t)return;e/=t.pathRatio,i/=t.pathRatio,t.getGroup("bone1_clothes").control=function(t){this.rotation=Math.atan2(e-this.currentState.pos[0]-t.x,-i+this.currentState.pos[1])}},keyUp:function(t,e){switch(e){case"Space":this.isStop=!this.isStop,console.log(this.isStop?"--STOP--":"--START--");break;case"ArrowRight":this.isStep=!0;break;case"KeyD":PathCtr.isOutputDebugPrint=!PathCtr.isOutputDebugPrint;break;case"KeyL":PathCtr.isOutputLoadState=!PathCtr.isOutputLoadState;break;case"KeyB":this.isShowBones=!this.isShowBones;break;case"KeyC":this.isShowControls=!this.isShowControls;break;case"KeyP":this.isShowPoints=!this.isShowPoints;break;case"KeyO":postMessage({cmd:"confirm",callback:"output-path-container",message:"現在の状態をJSONに出力します"})}},isDebugDraw:function(){return this.isShowBones||this.isShowPoints||this.isShowControls},outputJSON:function(t){postMessage({cmd:"download",type:"application/json",fileName:"pathContainer.json",data:JSON.stringify(t,(t,e)=>{if(!t.includes("result")&&!t.includes("current")&&!t.includes("past")&&"m"!=t)return e},2)})},toBin:function(t){if(!t)return console.error("path container is not found"),null;let e=new ArrayBuffer(1e9),i=new DataView(e),s=0,a=t=>{i.setUint8(s,t),s+=1},r=t=>{i.setUint16(s,t),s+=2},o=t=>{i.setFloat32(s,t),s+=4},n=t=>{i.setInt16(s,t*PathCtr.binDataPosRange),s+=2},h=t=>{a(t.length),[].map.call(t,t=>r(t.charCodeAt(0)))},l=t=>{if("transparent"==t)a(0);else{let e=t.match(/(\d+), (\d+), (\d+)/);a(1),a(e[1]),a(e[2]),a(e[3])}},c=(t,e,i)=>{let s=t.length;e(s);for(let e=0;e<s;){let a=t[e],o=1;if(void 0!==a){for(;o<s&&(void 0!==t[e+o]&&JSON.stringify(a)==JSON.stringify(t[e+o]));++o);r(o),e+=o,i(a)}else{for(r(0);o<s&&void 0===t[e+o];++o);r(o),e+=o}}},u=(t,e)=>{t.hasAction?(a(1),c(t.data,a,t=>{c(t,r,e)})):(a(0),e(t.data))},d=t=>{c(t,r,t=>{c(t,r,n)})},p=t=>{r(null==t.maskIdToUse?0:t.maskIdToUse+1),a("nonzero"==t.fillRule?0:1),(t=>{r(t.length),t.forEach(t=>{switch(t.type){case"M":a(0),n(t.pos[0]),n(t.pos[1]);break;case"L":a(1),n(t.pos[0]),n(t.pos[1]);break;case"C":a(2);for(let e=0;e<6;++e)n(t.pos[e]);break;case"Z":a(3);break;default:console.error("unknown type")}})})(t.defPathList),u(t.lineWidth,o),u(t.fillStyle,l),u(t.strokeStyle,l),u(t.pathDiffList,d)};r(t.originalWidth),r(t.originalHeight),a(t.actionList.length),t.actionList.forEach(t=>{h(t.name),a(t.id),r(t.totalFrames)}),c(t.rootGroups,a,r);let f=t.groups.length;return r(f),t.groups.forEach(t=>{PathCtr.loadState("count : "+f--),(t=>{h(t.id),r(null==t.maskIdToUse?0:t.maskIdToUse+1),c(t.paths,r,p),BoneObj.prototype.isPrototypeOf(t)?c(t.childGroups,a,r):u(t.childGroups,t=>{c(t,a,r)})})(t)}),delete i,e.slice(0,s)},outputBin:function(t){if(!t)return;let e=this.toBin(PathCtr.pathContainer);postMessage({cmd:"download",type:"octet/stream",fileName:"path_data.bin",data:e},[e])}};